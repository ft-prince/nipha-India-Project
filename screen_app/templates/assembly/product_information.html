<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NIPHA INDIA PRIVATE LIMITED EXPORT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-red': '#DF2427',
                        'primary-blue': '#5783C3',
                        'light-blue': '#dbeafe',
                        'light-red': '#fecaca',
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- Header -->
<header class="bg-white text-[#DE2025] shadow-md">
    <div class="container mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-20 justify-center">
                <!-- Logo Image -->
                <img src="https://www.niphaindia.com/assets/Frontend/images/logo.svg" alt="NIPHA Logo" class="h-20 w-auto">
                
                {% comment %} <h1 class="text-3xl font-bold">NIPHA INDIA PRIVATE LIMITED</h1> {% endcomment %}
            </div>
            <div class="text-sm">
                <span class=" text-2xl font-bold text-[#DF2427] px-3 py-1 rounded-full">
                    Nipha Exports Private Limited Admin Dashboard
                </span>
            </div>
        </div>
    </div>
</header>


    <!-- Product Selection -->
    <div class="container mx-auto px-6 py-4">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                    <i class="fas fa-search text-primary-blue mr-2"></i>
                    Select Product
                </h2>
                <button onclick="openCreateProductModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-200 hover:scale-105">
                    <i class="fas fa-plus mr-2"></i>
                    Create New Product
                </button>
            </div>
            
            <form method="GET" id="productForm">
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <select name="product_id" id="productSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-blue" onchange="loadProductData()">
                            <option value="">-- Select a Product --</option>
                            {% for product in products %}
                                <option value="{{ product.id }}" 
                                    {% if selected_product and selected_product.id == product.id %}selected{% endif %}>
                                    {{ product.code }} - {{ product.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="bg-primary-red hover:bg-red-700 text-white px-6 py-3 rounded-lg flex items-center">
                        <i class="fas fa-search mr-2"></i> Load Information
                    </button>
                </div>
            </form>
        </div>

        <!-- 4-Step Workflow (Only show if product is selected) -->
        {% if selected_product %}
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">
                    Product Workflow: {{ selected_product.code }} - {{ selected_product.name }}
                </h2>
                <div class="flex flex-wrap items-center space-x-6 text-sm text-gray-600">
                    <span class="flex items-center"><i class="fas fa-layer-group mr-2"></i>{{ product_data.assembly_stages.count|default:0 }} Stages</span>
                    <span class="flex items-center"><i class="fas fa-cogs mr-2"></i>{{ assembly_processes.count|default:0 }} Processes</span>
                    <span class="flex items-center"><i class="fas fa-list mr-2"></i>{{ product_data.bom_templates.count|default:0 }} Templates</span>
                    <span class="flex items-center"><i class="fas fa-images mr-2"></i>{{ product_data.media_files.count|default:0 }} Media Files</span>
                </div>
            </div>

            <!-- Step Navigation -->
            <div class="mb-8">
                <div class="flex justify-center">
                    <div class="flex items-center space-x-4">
                        <button onclick="showStep(1)" id="step1-btn" class="step-btn active flex items-center space-x-2 px-4 py-2 rounded-lg">
                            <span class="w-8 h-8 rounded-full bg-white flex items-center justify-center font-bold">1</span>
                            <span>Assembly Stages</span>
                        </button>
                        <i class="fas fa-arrow-right text-gray-400"></i>
                        <button onclick="showStep(2)" id="step2-btn" class="step-btn flex items-center space-x-2 px-4 py-2 rounded-lg">
                            <span class="w-8 h-8 rounded-full bg-white flex items-center justify-center font-bold">2</span>
                            <span>Assembly Processes</span>
                        </button>
                        <i class="fas fa-arrow-right text-gray-400"></i>
                        <button onclick="showStep(3)" id="step3-btn" class="step-btn flex items-center space-x-2 px-4 py-2 rounded-lg">
                            <span class="w-8 h-8 rounded-full bg-white flex items-center justify-center font-bold">3</span>
                            <span>BOM Templates</span>
                        </button>
                        <i class="fas fa-arrow-right text-gray-400"></i>
                        <button onclick="showStep(4)" id="step4-btn" class="step-btn flex items-center space-x-2 px-4 py-2 rounded-lg">
                            <span class="w-8 h-8 rounded-full bg-white flex items-center justify-center font-bold">4</span>
                            <span>Product Media</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 1: Assembly Stages -->
            <div id="step1" class="step-content">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Assembly Stages</h3>
                    <button onclick="openAssemblyStageModal()" class="bg-primary-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-plus mr-2"></i>
                        Add Stage
                    </button>
                </div>
                
                {% if product_data.assembly_stages %}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {% for stage in product_data.assembly_stages %}
                        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-all duration-200">
                            <div class="bg-[#DF2427] text-white p-4">
                                <div class="flex items-center justify-between">
                                    <h4 class="font-semibold flex items-center">
                                        <span class="bg-white text-primary-blue w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold mr-2">{{ stage.order }}</span>
                                        {{ stage.display_name|default:stage.name }}
                                    </h4>
                                    <div class="flex space-x-1">
                                        <button onclick="editAssemblyStage({{ stage.id }})" class="text-white hover:text-gray-200 p-1" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteAssemblyStage({{ stage.id }})" class="text-white hover:text-gray-200 p-1" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4">
                                <div class="space-y-2 text-sm mb-4">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Stage Name:</span>
                                        <span class="font-medium">{{ stage.name }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Processes:</span>
                                        <span class="font-medium text-primary-blue">{{ stage.processes.count }} processes</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Order:</span>
                                        <span class="font-medium">{{ stage.order }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-layer-group text-4xl mb-4"></i>
                    <p class="text-lg font-medium mb-2">No Assembly Stages</p>
                    <p>Create assembly stages to organize your production workflow</p>
                    <button onclick="openAssemblyStageModal()" class="mt-4 bg-primary-blue hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                        <i class="fas fa-plus mr-2"></i> Create First Stage
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- Step 2: Assembly Processes -->
            <div id="step2" class="step-content hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Assembly Processes</h3>
                    <button onclick="openAssemblyProcessModal()" class="bg-primary-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-plus mr-2"></i>
                        Add Process
                    </button>
                </div>
                
                {% if product_data.assembly_stages %}
                    {% for stage in product_data.assembly_stages %}
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden mb-6">
                        <div class="bg-[#DF2427] text-white p-4">
                            <h4 class="font-semibold flex items-center">
                                <span class="bg-white text-primary-blue w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold mr-2">{{ stage.order }}</span>
                                {{ stage.display_name|default:stage.name }}
                                <span class="ml-auto text-sm bg-white bg-opacity-20 px-2 py-1 rounded-full">
                                    {{ stage.processes.count }} processes
                                </span>
                            </h4>
                        </div>
                        <div class="p-4">
                            {% if stage.processes.all %}
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {% for process in stage.processes.all %}
                                    <div class="bg-gray-50 border-l-4 border-primary-red p-3 rounded-r">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex-1">
                                                <span class="font-medium text-gray-800 flex items-center">
                                                    <span class="bg-primary-red text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold mr-2">{{ process.order }}</span>
                                                    {{ process.display_name|default:process.name }}
                                                </span>
                                                {% if process.location %}
                                                    <p class="text-sm text-gray-600 mt-1"><i class="fas fa-map-marker-alt mr-1"></i> {{ process.get_location_display }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="flex space-x-1">
                                                <button onclick="editAssemblyProcess({{ process.id }})" class="text-blue-600 hover:text-blue-800 p-1" title="Edit">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="deleteAssemblyProcess({{ process.id }})" class="text-red-600 hover:text-red-800 p-1" title="Delete">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        {% if process.is_looped %}
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                                <i class="fas fa-sync mr-1"></i> {{ process.loop_group|default:"Loop" }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-cogs text-3xl mb-3"></i>
                                    <p class="font-medium mb-2">No processes defined for this stage</p>
                                    <button onclick="openAssemblyProcessModal({{ stage.id }})" class="text-primary-blue hover:text-blue-800">
                                        <i class="fas fa-plus mr-1"></i> Add Process
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center py-12 text-gray-500">
                    <i class="fas fa-cogs text-4xl mb-4"></i>
                    <p class="text-lg font-medium mb-2">No Assembly Stages Found</p>
                    <p>Please create assembly stages first in Step 1</p>
                    <button onclick="showStep(1)" class="mt-4 bg-primary-blue hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                        <i class="fas fa-arrow-left mr-2"></i> Go to Stages
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- Step 3: BOM Templates -->
            <div id="step3" class="step-content hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">BOM Templates</h3>
                    <div class="flex space-x-2">
                        <button onclick="openBulkUploadModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-file-excel mr-2"></i>
                            Bulk Upload
                        </button>
                        <button onclick="openBOMTemplateModal()" class="bg-primary-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <i class="fas fa-plus mr-2"></i>
                            Add Template
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% if product_data.bom_templates %}
                        {% for template in product_data.bom_templates %}
                        <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-lg transition-all duration-200">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-semibold text-gray-800 flex items-center">
                                    <i class="fas fa-clipboard-list text-primary-blue mr-2"></i>
                                    {{ template.template_name }}
                                </h4>
                                <div class="flex space-x-1">
                                    <button onclick="editBOMTemplate({{ template.id }})" class="text-blue-600 hover:text-blue-800 p-1" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="manageBOMItems({{ template.id }})" class="text-green-600 hover:text-green-800 p-1" title="Manage Items">
                                        <i class="fas fa-list"></i>
                                    </button>
                                    <button onclick="deleteBOMTemplate({{ template.id }})" class="text-red-600 hover:text-red-800 p-1" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="space-y-2 text-sm mb-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Type:</span>
                                    <span class="font-medium">{{ template.get_bom_type_display }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Items:</span>
                                    <span class="font-medium text-primary-blue">{{ template.bom_items.count }}</span>
                                </div>
                                {% if template.stage %}
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Stage:</span>
                                    <span class="font-medium">{{ template.stage.display_name }}</span>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="flex items-center space-x-2 mb-3">
                                {% if template.display_screen_1 %}
                                    <span class="w-3 h-3 bg-green-500 rounded-full" title="Screen 1"></span>
                                {% endif %}
                                {% if template.display_screen_2 %}
                                    <span class="w-3 h-3 bg-blue-500 rounded-full" title="Screen 2"></span>
                                {% endif %}
                                {% if template.display_screen_3 %}
                                    <span class="w-3 h-3 bg-red-500 rounded-full" title="Screen 3"></span>
                                {% endif %}
                            </div>
                            
                            {% if template.description %}
                            <p class="text-sm text-gray-600">{{ template.description|truncatechars:100 }}</p>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fas fa-clipboard-list text-4xl mb-4"></i>
                        <p class="text-lg font-medium mb-2">No BOM Templates</p>
                        <p>Create your first BOM template to get started</p>
                        <button onclick="openBOMTemplateModal()" class="mt-4 bg-primary-blue hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                            <i class="fas fa-plus mr-2"></i> Create Template
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Step 4: Product Media (Enhanced Styling) -->
            <div id="step4" class="step-content hidden">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-semibold text-gray-800">Product Media</h3>
                    <div class="flex space-x-2">
                        <button onclick="openZipUploadModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-200 hover:scale-105">
                            <i class="fas fa-file-archive mr-2"></i>
                            ZIP Upload
                        </button>
                        <button onclick="openProductMediaModal()" class="bg-primary-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition-all duration-200 hover:scale-105">
                            <i class="fas fa-plus mr-2"></i>
                            Add Media
                        </button>
                    </div>
                </div>
                
                {% if product_data.media_by_type %}
                    {% for media_type, media_list in product_data.media_by_type.items %}
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-700 flex items-center">
                                <i class="fas fa-folder-open text-primary-blue mr-3"></i>
                                {{ media_type }}
                                <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">{{ media_list|length }}</span>
                            </h4>
                            <div class="text-sm text-gray-500">
                                Total: {{ media_list|length }} file{{ media_list|length|pluralize }}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            {% for media in media_list %}
                            <div class="bg-white border border-gray-200 rounded-xl overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1 group">
                                <!-- Media Preview Section -->
                                <div class="relative h-40 bg-gradient-to-br from-gray-50 to-gray-100 flex items-center justify-center overflow-hidden">
                                    {% if media.file %}
                                        {% if media.media_type == 'PDF' %}
                                            <div class="text-center">
                                                <i class="fas fa-file-pdf text-5xl text-red-500 mb-2 group-hover:scale-110 transition-transform duration-300"></i>
                                                <p class="text-xs text-gray-600 font-medium">PDF Document</p>
                                            </div>
                                        {% elif media.media_type == 'VIDEO' %}
                                            <div class="text-center">
                                                <i class="fas fa-play-circle text-5xl text-blue-500 mb-2 group-hover:scale-110 transition-transform duration-300"></i>
                                                <p class="text-xs text-gray-600 font-medium">Video File</p>
                                            </div>
                                        {% elif media.media_type == 'IMAGE' %}
                                            <div class="text-center">
                                                <i class="fas fa-image text-5xl text-green-500 mb-2 group-hover:scale-110 transition-transform duration-300"></i>
                                                <p class="text-xs text-gray-600 font-medium">Image File</p>
                                            </div>
                                        {% else %}
                                            <div class="text-center">
                                                <i class="fas fa-file text-5xl text-gray-400 mb-2 group-hover:scale-110 transition-transform duration-300"></i>
                                                <p class="text-xs text-gray-600 font-medium">{{ media.get_media_type_display }}</p>
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="text-center">
                                            <i class="fas fa-database text-5xl text-purple-500 mb-2 group-hover:scale-110 transition-transform duration-300"></i>
                                            <p class="text-xs text-gray-600 font-medium">Database Media</p>
                                        </div>
                                    {% endif %}
                                    
                                    <!-- Screen Indicators Overlay -->
                                    <div class="absolute top-2 right-2 flex space-x-1">
                                        {% if media.display_screen_1 %}
                                            <span class="w-3 h-3 bg-green-500 rounded-full border-2 border-white shadow-sm" title="Screen 1"></span>
                                        {% endif %}
                                        {% if media.display_screen_2 %}
                                            <span class="w-3 h-3 bg-blue-500 rounded-full border-2 border-white shadow-sm" title="Screen 2"></span>
                                        {% endif %}
                                        {% if media.display_screen_3 %}
                                            <span class="w-3 h-3 bg-red-500 rounded-full border-2 border-white shadow-sm" title="Screen 3"></span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Duration Badge -->
                                    {% if media.duration %}
                                    <div class="absolute bottom-2 left-2">
                                        <span class="bg-black bg-opacity-70 text-white px-2 py-1 rounded-full text-xs font-medium">
                                            <i class="fas fa-clock mr-1"></i>{{ media.duration }}s
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Media Info Section -->
                                <div class="p-4">
                                    <div class="flex items-start justify-between mb-3">
                                    <div class="flex-1 min-w-0">
                                        <h5 class="font-semibold text-gray-800 text-sm break-words whitespace-normal" 
                                            title="{{ media.file.name|default:'Database Media' }}">
                                            {{ media.file.name|default:"Database Media" }}
                                        </h5>
                                        
                                        <p class="text-xs text-gray-500 mt-1">
                                            {{ media.get_media_type_display }}
                                        </p>
                                    </div>
                                        <div class="flex space-x-1 ml-2">
                                            <button onclick="editProductMedia({{ media.id }})" class="text-blue-600 hover:text-blue-800 p-1.5 rounded-full hover:bg-blue-50 transition-all duration-200" title="Edit">
                                                <i class="fas fa-edit text-sm"></i>
                                            </button>
                                            <button onclick="deleteProductMedia({{ media.id }})" class="text-red-600 hover:text-red-800 p-1.5 rounded-full hover:bg-red-50 transition-all duration-200" title="Delete">
                                                <i class="fas fa-trash text-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Process Information -->
                                    {% if media.process %}
                                    <div class="bg-gray-50 rounded-lg p-3 mb-3">
                                        <div class="text-xs text-gray-600 space-y-1">
                                            <div class="flex items-center">
                                                <i class="fas fa-cog text-primary-blue mr-2"></i>
                                                <span class="font-medium">{{ media.process.display_name|default:media.process.name|truncatechars:15 }}</span>
                                            </div>
                                            <div class="flex items-center">
                                                <i class="fas fa-layer-group text-primary-red mr-2"></i>
                                                <span>{{ media.process.stage.display_name|default:media.process.stage.name|truncatechars:15 }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <!-- Action Buttons -->
                                    <div class="flex items-center justify-between">
                                        {% if media.file %}
                                        <a href="{{ media.file.url }}" target="_blank" class="flex items-center text-primary-blue hover:text-blue-700 text-xs font-medium transition-colors duration-200">
                                            <i class="fas fa-external-link-alt mr-1"></i>
                                            View File
                                        </a>
                                        {% else %}
                                        <span class="text-xs text-gray-400">No file attached</span>
                                        {% endif %}
                                        
                                        <div class="text-xs text-gray-400">
                                            ID: {{ media.id }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="text-center py-16 text-gray-500">
                    <div class="max-w-md mx-auto">
                        <i class="fas fa-images text-6xl mb-6 text-gray-300"></i>
                        <h4 class="text-xl font-semibold mb-3">No Media Files</h4>
                        <p class="text-gray-400 mb-6">Upload your first media files to get started with product documentation</p>
                        <div class="flex flex-col sm:flex-row gap-3 justify-center">
                            <button onclick="openProductMediaModal()" class="bg-primary-blue hover:bg-blue-700 text-white px-6 py-3 rounded-lg flex items-center justify-center transition-all duration-200 hover:scale-105">
                                <i class="fas fa-plus mr-2"></i> Add Media File
                            </button>
                            <button onclick="openZipUploadModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg flex items-center justify-center transition-all duration-200 hover:scale-105">
                                <i class="fas fa-file-archive mr-2"></i> Bulk Upload ZIP
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="bg-white rounded-lg shadow-md p-12 text-center">
            <i class="fas fa-arrow-up text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">Select a Product</h3>
            <p class="text-gray-500">Choose a product from above to view and manage its production workflow</p>
        </div>
        {% endif %}
    </div>

    <!-- Create Product Modal -->
    <div id="createProductModal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-[500px] shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-plus-circle text-green-600 mr-2"></i>
                    Create New Product
                </h3>
                <form id="createProductForm">
                    {% csrf_token %}
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product Code</label>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 uppercase" id="productCode" name="code" placeholder="e.g., PROD001" required>
                        <small class="text-gray-500">Unique product identifier (will be converted to uppercase)</small>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Product Name</label>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" id="productName" name="name" placeholder="e.g., Industrial Motor Assembly" required>
                        <small class="text-gray-500">Descriptive name for the product</small>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('createProductModal')" class="px-4 py-2 text-gray-500 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors duration-200">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors duration-200">
                            <i class="fas fa-plus mr-2"></i>Create Product
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Assembly Stage Modal -->
    <div id="assemblyStageModal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-[600px] shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4" id="assemblyStageModalTitle">Add Assembly Stage</h3>
                <form id="assemblyStageForm">
                    {% csrf_token %}
                    <input type="hidden" id="assemblyStageId" name="stage_id">
                    <input type="hidden" name="product_id" value="{{ selected_product.id }}">
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Stage Name</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="stageName" name="name" placeholder="Stage Name" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="stageDisplayName" name="display_name" placeholder="Display Name">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Order</label>
                        <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="stageOrder" name="order" placeholder="Order" value="1" required>
                        <small class="text-gray-500">Order within the product workflow</small>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('assemblyStageModal')" class="px-4 py-2 text-gray-500 border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-primary-blue text-white rounded-md hover:bg-blue-700">Save Stage</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Assembly Process Modal -->
    <div id="assemblyProcessModal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-[600px] shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4" id="assemblyProcessModalTitle">Add Assembly Process</h3>
                <form id="assemblyProcessForm">
                    {% csrf_token %}
                    <input type="hidden" id="assemblyProcessId" name="process_id">
                    <input type="hidden" name="product_id" value="{{ selected_product.id }}">
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Assembly Stage</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="processStageId" name="stage_id" required>
                                <option value="">Select Stage</option>
                                {% for stage in assembly_stages %}
                                    <option value="{{ stage.id }}">{{ stage.order }}. {{ stage.display_name|default:stage.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Order</label>
                            <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="processOrder" name="order" placeholder="Order" value="1" required>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Process Name</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="processName" name="name" placeholder="Process Name" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Display Name</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="processDisplayName" name="display_name" placeholder="Display Name">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="processLocation" name="location">
                                <option value="">Select Location</option>
                                <option value="ASSEMBLY_ROOM">Assembly Room</option>
                                <option value="OUTSIDE_ASSEMBLY_ROOM">Outside Assembly Room</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Loop Group</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="loopGroup" name="loop_group" placeholder="Loop Group">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="flex items-center">
                            <input class="mr-2" type="checkbox" id="isLooped" name="is_looped">
                            <span class="text-sm text-gray-700">Is Looped Process</span>
                        </label>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('assemblyProcessModal')" class="px-4 py-2 text-gray-500 border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-primary-blue text-white rounded-md hover:bg-blue-700">Save Process</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- BOM Template Modal -->
    <div id="bomTemplateModal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-[600px] shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4" id="bomTemplateModalTitle">Add BOM Template</h3>
                <form id="bomTemplateForm">
                    {% csrf_token %}
                    <input type="hidden" id="bomTemplateId" name="template_id">
                    <input type="hidden" name="product_id" value="{{ selected_product.id }}">
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Template Name</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="templateName" name="template_name" placeholder="Template Name" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">BOM Type</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="bomType" name="bom_type" required>
                                <option value="">Select BOM Type</option>
                                {% for value, label in bom_type_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Assembly Stage</label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="stageId" name="stage_id">
                                <option value="">Select Stage (Optional)</option>
                                {% for stage in assembly_stages %}
                                    <option value="{{ stage.id }}">{{ stage.order }}. {{ stage.display_name|default:stage.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Duration (seconds)</label>
                            <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="duration" name="duration" placeholder="Duration" value="20">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="description" name="description" placeholder="Description" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Screens:</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input class="mr-2" type="checkbox" id="displayScreen1" name="display_screen_1">
                                <span class="w-3 h-3 bg-green-500 rounded-full mr-1"></span>
                                Screen 1
                            </label>
                            <label class="flex items-center">
                                <input class="mr-2" type="checkbox" id="displayScreen2" name="display_screen_2">
                                <span class="w-3 h-3 bg-blue-500 rounded-full mr-1"></span>
                                Screen 2
                            </label>
                            <label class="flex items-center">
                                <input class="mr-2" type="checkbox" id="displayScreen3" name="display_screen_3">
                                <span class="w-3 h-3 bg-red-500 rounded-full mr-1"></span>
                                Screen 3
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="flex items-center">
                            <input class="mr-2" type="checkbox" id="isDurationActive" name="is_duration_active">
                            <span class="text-sm text-gray-700">Duration Active (Auto-advance after duration)</span>
                        </label>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('bomTemplateModal')" class="px-4 py-2 text-gray-500 border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-primary-blue text-white rounded-md hover:bg-blue-700">Save Template</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- BOM Items Management Modal -->
    <div id="bomItemsModal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-[1000px] shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4" id="bomItemsModalTitle">Manage BOM Items</h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div>
                        <h4 class="font-medium text-gray-800 mb-3">Add New Item</h4>
                        <form id="bomItemForm">
                            {% csrf_token %}
                            <input type="hidden" id="bomItemTemplateId" name="template_id">
                            <input type="hidden" id="bomItemId" name="item_id_edit">
                            
                            <div class="mb-3">
                                <label class="block text-sm font-medium text-gray-700 mb-2">BOM Item</label>
                                <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="bomItemSelect" name="item_id" required>
                                    <option value="">Select Item</option>
                                    {% for item in bom_items %}
                                        <option value="{{ item.id }}">{{ item.item_description }} ({{ item.part_number }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-2 mb-3">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Serial Number</label>
                                    <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="serialNumber" name="serial_number" placeholder="S.No" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Base Quantity</label>
                                    <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="baseQuantity" name="base_quantity" placeholder="Quantity" step="0.0001" value="1" required>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                                <textarea class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="itemNotes" name="notes" placeholder="Notes" rows="2"></textarea>
                            </div>
                            
                            <button type="submit" class="w-full px-4 py-2 bg-primary-blue text-white rounded-md hover:bg-blue-700" id="bomItemSubmitBtn">Add Item</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2">
                        <h4 class="font-medium text-gray-800 mb-3">Current Items</h4>
                        <div id="bomItemsList" class="max-h-96 overflow-y-auto">
                            <!-- Items will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal for BOM Items -->
    <div id="bulkUploadModal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-[600px] shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Select BOM Template for Bulk Upload</h3>
                
                <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                        <div>
                            <strong class="text-blue-800">Excel Format:</strong>
                            <p class="text-sm text-blue-700">Your Excel file should have columns: 
                            <code class="bg-white px-1 rounded">S. NO</code>, <code class="bg-white px-1 rounded">Code</code>, 
                            <code class="bg-white px-1 rounded">ITEM DESCRIPTION</code>, <code class="bg-white px-1 rounded">PART NO.</code>, 
                            <code class="bg-white px-1 rounded">QTY</code>,
                            <code class="bg-white px-1 rounded">UOM</code>,
                            
                            <code class="bg-white px-1 rounded">ITEM PHOTO</code></p>
                        </div>
                    </div>
                </div>
                
                <form id="bulkUploadForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select BOM Template</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="bulkTemplateSelect" name="template_id" required>
                            <option value="">Select Template</option>
                            {% for template in product_data.bom_templates %}
                                <option value="{{ template.id }}">{{ template.template_name }} ({{ template.get_bom_type_display }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Excel File</label>
                            <input type="file" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="excelFile" name="excel_file" accept=".xlsx,.xls" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Default Unit of Measure</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="unitOfMeasure" name="unit_of_measure" value="NO." placeholder="Unit">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Default Supplier (Optional)</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="supplier" name="supplier" placeholder="Supplier">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="flex items-center">
                            <input class="mr-2" type="checkbox" id="overwriteExisting" name="overwrite_existing">
                            <span class="text-sm text-gray-700">Overwrite existing items with same item code</span>
                        </label>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('bulkUploadModal')" class="px-4 py-2 text-gray-500 border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-upload mr-2"></i> Upload & Process
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Product Media Modal -->
    <div id="productMediaModal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-[800px] shadow-lg rounded-md bg-white max-h-[90vh] overflow-y-auto">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4" id="productMediaModalTitle">Add Product Media</h3>
                <form id="productMediaForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" id="productMediaId" name="media_id">
                    <input type="hidden" name="product_id" value="{{ selected_product.id }}">
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Form Fields Column -->
                        <div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Media Type</label>
                                    <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="mediaType" name="media_type" required>
                                        <option value="">Select Media Type</option>
                                        {% for value, label in media_type_choices %}
                                            <option value="{{ value }}">{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Duration (seconds)</label>
                                    <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="mediaDuration" name="duration" placeholder="Duration" value="15">
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Assembly Process</label>
                                <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="processId" name="process_id">
                                    <option value="">Select Process (Optional)</option>
                                    {% for process in assembly_processes %}
                                        <option value="{{ process.id }}">{{ process.stage.display_name|default:process.stage.name }}  {{ process.display_name|default:process.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Media File</label>
                                <input type="file" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="mediaFile" name="file" accept=".pdf,.mp4,.mov,.xlsx,.docx,.avi,.mkv,.wmv">
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Display Screens:</label>
                                <div class="flex space-x-4">
                                    <label class="flex items-center">
                                        <input class="mr-2" type="checkbox" id="mediaDisplayScreen1" name="display_screen_1">
                                        <span class="w-3 h-3 bg-green-500 rounded-full mr-1"></span>
                                        Screen 1
                                    </label>
                                    <label class="flex items-center">
                                        <input class="mr-2" type="checkbox" id="mediaDisplayScreen2" name="display_screen_2">
                                        <span class="w-3 h-3 bg-blue-500 rounded-full mr-1"></span>
                                        Screen 2
                                    </label>
                                    <label class="flex items-center">
                                        <input class="mr-2" type="checkbox" id="mediaDisplayScreen3" name="display_screen_3">
                                        <span class="w-3 h-3 bg-red-500 rounded-full mr-1"></span>
                                        Screen 3
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preview Column -->
                        <div>
                            <div class="bg-gray-50 rounded-lg h-80 flex items-center justify-center" id="mediaPreviewContainer">
                                <div class="text-center text-gray-500" id="noPreviewMessage">
                                    <i class="fas fa-file text-4xl mb-3"></i>
                                    <p>No file selected</p>
                                    <small>Upload a file to see preview</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeModal('productMediaModal')" class="px-4 py-2 text-gray-500 border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-primary-blue text-white rounded-md hover:bg-blue-700">Save Media</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ZIP Upload Modal for Product Media -->
    <div id="zipUploadModal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-[600px] shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Bulk Upload Media from ZIP</h3>
                <form id="zipUploadForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" value="{{ selected_product.id }}">
                    
                    <div class="bg-green-50 border border-green-200 p-4 rounded-lg mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-info-circle text-green-600 mr-2"></i>
                            <div>
                                <strong class="text-green-800">ZIP Contents:</strong>
                                <p class="text-sm text-green-700">PDFs will be marked as Process Documents, Videos (.mp4, .mov, .avi, etc.) as Videos.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ZIP File</label>
                            <input type="file" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="zipFile" name="zip_file" accept=".zip" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Default Duration (seconds)</label>
                            <input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="zipDefaultDuration" name="default_duration" value="30" min="1">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Assign to Process</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-blue" id="zipProcessId" name="process_id">
                            <option value="">Select Process (Optional)</option>
                            {% for process in assembly_processes %}
                                <option value="{{ process.id }}">{{ process.stage.display_name|default:process.stage.name }}  {{ process.display_name|default:process.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Screens:</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input class="mr-2" type="checkbox" id="zipDisplayScreen1" name="display_screen_1">
                                <span class="w-3 h-3 bg-green-500 rounded-full mr-1"></span>
                                Screen 1
                            </label>
                            <label class="flex items-center">
                                <input class="mr-2" type="checkbox" id="zipDisplayScreen2" name="display_screen_2">
                                <span class="w-3 h-3 bg-blue-500 rounded-full mr-1"></span>
                                Screen 2
                            </label>
                            <label class="flex items-center">
                                <input class="mr-2" type="checkbox" id="zipDisplayScreen3" name="display_screen_3">
                                <span class="w-3 h-3 bg-red-500 rounded-full mr-1"></span>
                                Screen 3
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeModal('zipUploadModal')" class="px-4 py-2 text-gray-500 border border-gray-300 rounded-md hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-upload mr-2"></i> Upload & Extract
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentStep = 1;

        // Product selection
        function loadProductData() {
            const productId = document.getElementById('productSelect').value;
            if (productId) {
                document.getElementById('productForm').submit();
            }
        }

        // Step navigation
        function showStep(stepNumber) {
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
                document.getElementById(`step${i}-btn`).classList.remove('active');
            }
            
            // Show selected step
            document.getElementById(`step${stepNumber}`).classList.remove('hidden');
            document.getElementById(`step${stepNumber}-btn`).classList.add('active');
            currentStep = stepNumber;
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Create Product Functions
        function openCreateProductModal() {
            const form = document.getElementById('createProductForm');
            form.reset();
            openModal('createProductModal');
        }

        // Assembly Stage Functions
        function openAssemblyStageModal(stageId = null) {
            const title = document.getElementById('assemblyStageModalTitle');
            const form = document.getElementById('assemblyStageForm');
            
            if (stageId) {
                title.textContent = 'Edit Assembly Stage';
                loadAssemblyStageData(stageId);
            } else {
                title.textContent = 'Add Assembly Stage';
                form.reset();
                document.getElementById('assemblyStageId').value = '';
            }
            
            openModal('assemblyStageModal');
        }

        function editAssemblyStage(stageId) {
            openAssemblyStageModal(stageId);
        }

        function deleteAssemblyStage(stageId) {
            if (confirm('Are you sure you want to delete this assembly stage? This will also delete all associated processes.')) {
                fetch(`/station/assembly-stage/${stageId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
            }
        }

        // Assembly Process Functions  
        function openAssemblyProcessModal(processId = null, preSelectedStageId = null) {
            const title = document.getElementById('assemblyProcessModalTitle');
            const form = document.getElementById('assemblyProcessForm');
            
            if (processId) {
                title.textContent = 'Edit Assembly Process';
                loadAssemblyProcessData(processId);
            } else {
                title.textContent = 'Add Assembly Process';
                form.reset();
                document.getElementById('assemblyProcessId').value = '';
                if (preSelectedStageId) {
                    document.getElementById('processStageId').value = preSelectedStageId;
                }
            }
            
            openModal('assemblyProcessModal');
        }

        function editAssemblyProcess(processId) {
            openAssemblyProcessModal(processId);
        }

        function deleteAssemblyProcess(processId) {
            if (confirm('Are you sure you want to delete this assembly process?')) {
                fetch(`/station/assembly-process/${processId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
            }
        }

        // BOM Template Functions
        function openBOMTemplateModal(templateId = null) {
            const title = document.getElementById('bomTemplateModalTitle');
            const form = document.getElementById('bomTemplateForm');
            
            if (templateId) {
                title.textContent = 'Edit BOM Template';
                loadBOMTemplateData(templateId);
            } else {
                title.textContent = 'Add BOM Template';
                form.reset();
                document.getElementById('bomTemplateId').value = '';
            }
            
            openModal('bomTemplateModal');
        }

        function editBOMTemplate(templateId) {
            openBOMTemplateModal(templateId);
        }

        function deleteBOMTemplate(templateId) {
            if (confirm('Are you sure you want to delete this BOM template? This will also delete all associated items.')) {
                fetch(`/station/bom-template/${templateId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
            }
        }

        function manageBOMItems(templateId) {
            document.getElementById('bomItemTemplateId').value = templateId;
            loadBOMItems(templateId);
            openModal('bomItemsModal');
        }

        function loadBOMItems(templateId) {
            fetch(`/station/bom-template/${templateId}/items/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const itemsList = document.getElementById('bomItemsList');
                        itemsList.innerHTML = data.items.map(item => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3">
                                <div class="flex items-start justify-between">
                                    <div class="flex gap-3">
                                        ${item.has_photo ? `
                                            <img src="${item.item_photo_url}" 
                                                 alt="${item.item_description}" 
                                                 class="w-16 h-16 object-cover rounded-lg border-2 border-primary-red cursor-pointer"
                                                 onclick="showImageModal('${item.item_photo_url}', '${item.item_description}')"
                                                 title="Click to view full size">
                                        ` : `
                                            <div class="w-16 h-16 bg-gray-100 border-2 border-dashed border-gray-400 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-image text-gray-400"></i>
                                            </div>
                                        `}
                                        <div class="flex-1">
                                            <div class="font-semibold text-primary-red">
                                                ${item.serial_number}. ${item.item_code}
                                            </div>
                                            <div class="text-gray-700 mb-1">${item.item_description}</div>
                                            <div class="text-sm text-gray-500">
                                                <i class="fas fa-tag mr-1"></i> ${item.part_number} | 
                                                <i class="fas fa-cube mr-1"></i> ${item.base_quantity} ${item.unit_of_measure}
                                            </div>
                                            ${item.notes ? `
                                                <div class="text-sm text-gray-600 italic mt-1">
                                                    <i class="fas fa-sticky-note mr-1"></i> ${item.notes}
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="flex space-x-1">
                                        <button onclick="editBOMItem(${item.id})" class="text-blue-600 hover:text-blue-800 p-1" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteBOMItem(${item.id})" class="text-red-600 hover:text-red-800 p-1" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    }
                })
                .catch(error => {
                    console.error('Error loading BOM items:', error);
                });
        }

        // Bulk Upload Functions
        function openBulkUploadModal() {
            openModal('bulkUploadModal');
        }

        // Product Media Functions
        function openProductMediaModal(mediaId = null) {
            const title = document.getElementById('productMediaModalTitle');
            const form = document.getElementById('productMediaForm');
            
            if (mediaId) {
                title.textContent = 'Edit Product Media';
                loadProductMediaData(mediaId);
            } else {
                title.textContent = 'Add Product Media';
                form.reset();
                document.getElementById('productMediaId').value = '';
                clearMediaPreview();
            }
            
            openModal('productMediaModal');
        }

        function editProductMedia(mediaId) {
            openProductMediaModal(mediaId);
        }

        function deleteProductMedia(mediaId) {
            if (confirm('Are you sure you want to delete this media file?')) {
                fetch(`/station/product-media/${mediaId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
            }
        }

        function openZipUploadModal() {
            openModal('zipUploadModal');
        }

        // Form Submissions
        document.getElementById('createProductForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Creating...';
            submitBtn.disabled = true;
            
            fetch('/station/product/create/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closeModal('createProductModal');
                    
                    // Add new product to select dropdown
                    const productSelect = document.getElementById('productSelect');
                    const newOption = document.createElement('option');
                    newOption.value = data.product_id;
                    newOption.textContent = `${data.product_code} - ${data.product_name}`;
                    newOption.selected = true;
                    productSelect.appendChild(newOption);
                    
                    // Optionally reload the page to show the new product
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error creating product: ' + error);
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });

        document.getElementById('assemblyStageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const stageId = document.getElementById('assemblyStageId').value;
            const url = stageId ? 
                `/station/assembly-stage/${stageId}/update/` : 
                '/station/assembly-stage/create/';
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closeModal('assemblyStageModal');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            });
        });

        document.getElementById('assemblyProcessForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const processId = document.getElementById('assemblyProcessId').value;
            const url = processId ? 
                `/station/assembly-process/${processId}/update/` : 
                '/station/assembly-process/create/';
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closeModal('assemblyProcessModal');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            });
        });

        document.getElementById('bomTemplateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const templateId = document.getElementById('bomTemplateId').value;
            const url = templateId ? 
                `/station/bom-template/${templateId}/update/` : 
                '/station/bom-template/create/';
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closeModal('bomTemplateModal');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            });
        });

        document.getElementById('bomItemForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const itemId = document.getElementById('bomItemId').value;
            const url = itemId ? 
                `/station/bom-item/${itemId}/update/` : 
                '/station/bom-item/create/';
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    this.reset();
                    document.getElementById('bomItemId').value = '';
                    document.getElementById('bomItemSubmitBtn').textContent = 'Add Item';
                    loadBOMItems(document.getElementById('bomItemTemplateId').value);
                } else {
                    alert('Error: ' + data.error);
                }
            });
        });

        document.getElementById('bulkUploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const templateId = document.getElementById('bulkTemplateSelect').value;
            
            if (!templateId) {
                alert('Please select a BOM template');
                return;
            }
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
            submitBtn.disabled = true;
            
            fetch(`/station/bom-template/${templateId}/upload-excel/`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    if (data.errors) {
                        console.warn('Upload warnings:', data.errors);
                    }
                    closeModal('bulkUploadModal');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error processing file: ' + error);
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });

        document.getElementById('productMediaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const mediaId = document.getElementById('productMediaId').value;
            const url = mediaId ? 
                `/station/product-media/${mediaId}/update/` : 
                '/station/product-media/create/';
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closeModal('productMediaModal');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            });
        });

        document.getElementById('zipUploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            formData.set('display_screen_1', document.getElementById('zipDisplayScreen1').checked ? 'true' : 'false');
            formData.set('display_screen_2', document.getElementById('zipDisplayScreen2').checked ? 'true' : 'false');
            formData.set('display_screen_3', document.getElementById('zipDisplayScreen3').checked ? 'true' : 'false');
            
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Extracting...';
            submitBtn.disabled = true;
            
            fetch('/station/product-media/upload-zip/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    if (data.errors) {
                        console.warn('Upload warnings:', data.errors);
                    }
                    closeModal('zipUploadModal');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error processing ZIP file: ' + error);
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });

        // Helper functions for loading data
        function loadAssemblyStageData(stageId) {
            fetch(`/station/assembly-stage/${stageId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const stage = data.stage;
                        document.getElementById('assemblyStageId').value = stage.id;
                        document.getElementById('stageName').value = stage.name;
                        document.getElementById('stageDisplayName').value = stage.display_name || '';
                        document.getElementById('stageOrder').value = stage.order;
                    }
                });
        }

        function loadAssemblyProcessData(processId) {
            fetch(`/station/assembly-process/${processId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const process = data.process;
                        document.getElementById('assemblyProcessId').value = process.id;
                        document.getElementById('processStageId').value = process.stage_id;
                        document.getElementById('processOrder').value = process.order;
                        document.getElementById('processName').value = process.name;
                        document.getElementById('processDisplayName').value = process.display_name || '';
                        document.getElementById('processLocation').value = process.location || '';
                        document.getElementById('loopGroup').value = process.loop_group || '';
                        document.getElementById('isLooped').checked = process.is_looped;
                    }
                });
        }

        function loadBOMTemplateData(templateId) {
            fetch(`/station/bom-template/${templateId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const template = data.template;
                        document.getElementById('bomTemplateId').value = template.id;
                        document.getElementById('templateName').value = template.template_name;
                        document.getElementById('bomType').value = template.bom_type;
                        document.getElementById('stageId').value = template.stage_id || '';
                        document.getElementById('duration').value = template.duration;
                        document.getElementById('description').value = template.description || '';
                        document.getElementById('displayScreen1').checked = template.display_screen_1;
                        document.getElementById('displayScreen2').checked = template.display_screen_2;
                        document.getElementById('displayScreen3').checked = template.display_screen_3;
                        document.getElementById('isDurationActive').checked = template.is_duration_active;
                    }
                });
        }

        function loadProductMediaData(mediaId) {
            fetch(`/station/product-media/${mediaId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const media = data.media;
                        document.getElementById('productMediaId').value = media.id;
                        document.getElementById('mediaType').value = media.media_type;
                        document.getElementById('mediaDuration').value = media.duration;
                        document.getElementById('processId').value = media.process_id || '';
                        document.getElementById('mediaDisplayScreen1').checked = media.display_screen_1;
                        document.getElementById('mediaDisplayScreen2').checked = media.display_screen_2;
                        document.getElementById('mediaDisplayScreen3').checked = media.display_screen_3;
                        
                        if (media.has_file) {
                            showMediaPreview(media.file_url, media.file_type, media.file_name, media.file_size);
                        } else {
                            clearMediaPreview();
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading media data:', error);
                });
        }

        function editBOMItem(itemId) {
            fetch(`/station/bom-item/${itemId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const item = data.item;
                        document.getElementById('bomItemId').value = item.id;
                        document.getElementById('bomItemSelect').value = item.item_id;
                        document.getElementById('serialNumber').value = item.serial_number;
                        document.getElementById('baseQuantity').value = item.base_quantity;
                        document.getElementById('itemNotes').value = item.notes || '';
                        document.getElementById('bomItemSubmitBtn').textContent = 'Update Item';
                    }
                });
        }

        function deleteBOMItem(itemId) {
            if (confirm('Are you sure you want to remove this item from the BOM?')) {
                fetch(`/station/bom-item/${itemId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        loadBOMItems(document.getElementById('bomItemTemplateId').value);
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
            }
        }

        // Media preview functions
        function showMediaPreview(fileUrl, fileType, fileName, fileSize) {
            const previewContainer = document.getElementById('mediaPreviewContainer');
            const sizeText = fileSize ? formatFileSize(fileSize) : '';
            
            let previewHTML = '';
            
            switch (fileType) {
                case 'pdf':
                    previewHTML = `
                        <div class="text-center w-full">
                            <div class="mb-3">
                                <i class="fas fa-file-pdf text-6xl text-red-600"></i>
                            </div>
                            <h6 class="font-medium mb-2">${fileName}</h6>
                            ${sizeText ? `<small class="text-gray-500 block mb-3">${sizeText}</small>` : ''}
                            <button type="button" onclick="window.open('${fileUrl}', '_blank')" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-eye mr-2"></i> View PDF
                            </button>
                        </div>
                    `;
                    break;
                    
                case 'video':
                    previewHTML = `
                        <div class="w-full">
                            <video controls class="w-full max-h-60 rounded-lg" preload="metadata">
                                <source src="${fileUrl}" type="video/mp4">
                                <source src="${fileUrl}" type="video/quicktime">
                                <source src="${fileUrl}" type="video/x-msvideo">
                                Your browser does not support the video tag.
                            </video>
                            <div class="text-center mt-2">
                                <h6 class="font-medium mb-1">${fileName}</h6>
                                ${sizeText ? `<small class="text-gray-500">${sizeText}</small>` : ''}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'image':
                    previewHTML = `
                        <div class="text-center w-full">
                            <img src="${fileUrl}" alt="${fileName}" 
                                 class="max-w-full max-h-60 object-contain rounded-lg cursor-pointer"
                                 onclick="showImageModal('${fileUrl}', '${fileName}')">
                            <div class="mt-2">
                                <h6 class="font-medium mb-1">${fileName}</h6>
                                ${sizeText ? `<small class="text-gray-500">${sizeText}</small>` : ''}
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    previewHTML = `
                        <div class="text-center w-full">
                            <div class="mb-3">
                                <i class="fas fa-file text-6xl text-gray-400"></i>
                            </div>
                            <h6 class="font-medium mb-2">${fileName}</h6>
                            ${sizeText ? `<small class="text-gray-500 block mb-3">${sizeText}</small>` : ''}
                            <a href="${fileUrl}" download class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-download mr-2"></i> Download File
                            </a>
                        </div>
                    `;
            }
            
            previewContainer.innerHTML = previewHTML;
        }

        function clearMediaPreview() {
            const previewContainer = document.getElementById('mediaPreviewContainer');
            previewContainer.innerHTML = `
                <div class="text-center text-gray-500" id="noPreviewMessage">
                    <i class="fas fa-file text-4xl mb-3"></i>
                    <p>No file selected</p>
                    <small>Upload a file to see preview</small>
                </div>
            `;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showImageModal(imageUrl, itemDescription) {
            const modalHTML = `
                <div id="imageViewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center">
                    <div class="bg-white rounded-lg max-w-4xl max-h-[90vh] overflow-auto m-4">
                        <div class="flex items-center justify-between p-4 border-b">
                            <h3 class="text-lg font-medium">${itemDescription}</h3>
                            <button onclick="document.getElementById('imageViewModal').remove()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-4 text-center">
                            <img src="${imageUrl}" alt="${itemDescription}" class="max-w-full max-h-[70vh] object-contain rounded-lg shadow-lg">
                        </div>
                        <div class="flex justify-between p-4 border-t">
                            <a href="${imageUrl}" download class="bg-primary-blue hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-download mr-2"></i> Download Image
                            </a>
                            <button onclick="document.getElementById('imageViewModal').remove()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function getFileTypeFromName(fileName) {
            const name = fileName.toLowerCase();
            if (name.endsWith('.pdf')) return 'pdf';
            if (name.endsWith('.mp4') || name.endsWith('.mov') || name.endsWith('.avi') || 
                name.endsWith('.mkv') || name.endsWith('.wmv') || name.endsWith('.flv') || 
                name.endsWith('.webm')) return 'video';
            if (name.endsWith('.jpg') || name.endsWith('.jpeg') || name.endsWith('.png') || 
                name.endsWith('.gif') || name.endsWith('.bmp') || name.endsWith('.webp')) return 'image';
            return 'other';
        }

        // File input change handler for preview
        document.addEventListener('DOMContentLoaded', function() {
            const mediaFileInput = document.getElementById('mediaFile');
            if (mediaFileInput) {
                mediaFileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const tempUrl = URL.createObjectURL(file);
                        const fileType = getFileTypeFromName(file.name);
                        
                        showMediaPreview(tempUrl, fileType, file.name, file.size);
                        
                        setTimeout(() => {
                            URL.revokeObjectURL(tempUrl);
                        }, 60000);
                    } else {
                        clearMediaPreview();
                    }
                });
            }

            // Auto-uppercase product code input
            const productCodeInput = document.getElementById('productCode');
            if (productCodeInput) {
                productCodeInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.toUpperCase();
                });
            }
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.classList.add('hidden');
                }
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            {% if selected_product %}
            showStep(1);
            {% endif %}
        });
    </script>

    <style>
        .step-btn {
            background: #e5e7eb;
            color: #6b7280;
            transition: all 0.3s ease;
        }
        
        .step-btn.active {
            background: #5783C3;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        
        .step-btn:hover:not(.active) {
            background: #d1d5db;
            transform: translateY(-2px);
        }
        
        .modal {
            backdrop-filter: blur(4px);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .step-content {
            animation: fadeIn 0.3s ease-out;
        }
        
        .overflow-y-auto::-webkit-scrollbar {
            width: 6px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Enhanced hover effects for media cards */
        .group:hover .group-hover\:scale-110 {
            transform: scale(1.1);
        }

        .group:hover {
            transform: translateY(-4px);
        }

        /* Smooth transitions for all interactive elements */
        button, .step-btn, input, select, textarea {
            transition: all 0.2s ease-in-out;
        }

        /* Focus states for better accessibility */
        input:focus, select:focus, textarea:focus {
            ring-width: 2px;
            ring-color: #2563eb;
            border-color: #2563eb;
        }

        /* Media card enhancements */
        .media-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .media-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</body>
</html>