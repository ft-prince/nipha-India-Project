<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRG Assembly 40K - Supervisor Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        /* Enhanced Bulk Controls Section */
        .bulk-controls {
            background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #2196f3;
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.1);
        }

        .bulk-controls h3 {
            color: #1976d2;
            margin-bottom: 20px;
            font-size: 1.6em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-setup-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .quick-setup-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        /* Enhanced BOM Type Selection for Bulk */
        .bom-type-selection {
            background: #fff9c4;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
        }

        .bom-type-selection h4 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .bom-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .bom-option {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .bom-option:hover {
            border-color: #ffc107;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.2);
        }

        .bom-option.selected {
            border-color: #28a745;
            background: #f8fff8;
        }

        .bom-option-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .bom-option-title {
            font-weight: bold;
            font-size: 1.1em;
            color: #2c3e50;
        }

        .bom-option-description {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .bom-split-indicator {
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
        }

        .bom-split-indicator.complete {
            background: #e8f5e8;
            color: #27ae60;
        }

        .stage-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stage-btn {
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
            position: relative;
        }

        .stage-btn:hover {
            border-color: #3498db;
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
        }

        .stage-btn.selected {
            border-color: #27ae60;
            background: #e8f5e8;
            color: #27ae60;
        }

        .stage-btn .stage-name {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .stage-btn .stage-info {
            font-size: 0.9em;
            color: #666;
        }

        .process-selection {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .checkbox-group {
            display: flex;
            gap: 25px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            border-color: #3498db;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3498db;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .control-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .control-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            font-size: 1.5em;
        }

        .status-overview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .display-status {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 4px solid;
        }

        .display-1 { border-top-color: #FF6B6B; }
        .display-2 { border-top-color: #4ECDC4; }
        .display-3 { border-top-color: #45B7D1; }

        .display-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .display-type {
            color: #666;
            margin-bottom: 15px;
        }

        .current-process {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            color: #2d5a2d;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            border-color: #3498db;
            outline: none;
        }

        .form-control.auto-selected {
            background: #e8f5e8;
            border-color: #27ae60;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            margin: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-large {
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 12px;
        }

        .process-navigation {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #b8daff;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .loop-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .loop-active {
            background: #fff3cd;
            color: #856404;
        }

        .loop-inactive {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online { background: #27ae60; }
        .status-offline { background: #e74c3c; }
        .status-loading { background: #f39c12; }

        .loop-toggle {
            background: #f39c12;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .loop-toggle:hover {
            background: #e67e22;
        }

        .loop-toggle.active {
            background: #27ae60;
        }

        .auto-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #2d5a2d;
            margin-bottom: 15px;
        }

        .bulk-action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .quantity-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .quantity-input-group label {
            font-weight: 600;
            color: #2c3e50;
            min-width: 80px;
        }

        .quantity-input-group input {
            flex: 1;
            max-width: 120px;
        }

        @media (max-width: 768px) {
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .status-overview {
                grid-template-columns: 1fr;
            }
            
            .process-navigation {
                flex-direction: column;
            }

            .stage-buttons {
                grid-template-columns: 1fr;
            }

            .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }

            .bom-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üè≠ BRG Assembly 40K - Supervisor Dashboard</h1>
            <p>Easy assembly control with BOM split functionality and bulk operations</p>
        </div>

        <div class="main-content">
            <!-- Display Status Overview -->
            <div class="status-overview">
                <div class="display-status display-1">
                    <div class="display-number">1</div>
                    <div class="display-type">BOMs & Reference</div>
                    <div class="current-process" id="display1-process">Loading...</div>
                    <div style="margin-top: 10px;">
                        <span class="status-indicator status-loading" id="display1-status"></span>
                        <span id="display1-connection">Checking...</span>
                    </div>
                </div>
                <div class="display-status display-2">
                    <div class="display-number">2</div>
                    <div class="display-type">Process Instructions</div>
                    <div class="current-process" id="display2-process">Loading...</div>
                    <div style="margin-top: 10px;">
                        <span class="status-indicator status-loading" id="display2-status"></span>
                        <span id="display2-connection">Checking...</span>
                    </div>
                </div>
                <div class="display-status display-3">
                    <div class="display-number">3</div>
                    <div class="display-type">Instructional Videos</div>
                    <div class="current-process" id="display3-process">Loading...</div>
                    <div style="margin-top: 10px;">
                        <span class="status-indicator status-loading" id="display3-status"></span>
                        <span id="display3-connection">Checking...</span>
                    </div>
                </div>
            </div>

            <!-- Enhanced Bulk Control Section -->
            <div class="bulk-controls">
                <h3>üéõÔ∏è Easy Bulk Operations</h3>
                


                <div class="quick-setup-section">
                    <h4>üìã Quick Stage Selection</h4>
                    <div class="auto-info">
                        ‚ú® <strong>Auto-Selection:</strong> Click a stage below and the first process will be automatically selected. You can change the process if needed.
                    </div>
                    
                    <div class="stage-buttons" id="stage-buttons">
                        <!-- Stage buttons will be populated here -->
                    </div>
                    
                    <div class="process-selection" id="process-selection" style="display: none;">
                        <label><strong>Selected Process (auto-selected first, change if needed):</strong></label>
                        <select class="form-control" id="bulk-process-select">
                            <option value="">Loading processes...</option>
                        </select>
                    </div>
                </div>

                <div class="quick-setup-section">
                    <h4>‚öôÔ∏è Bulk Settings</h4>
                    
                    <div class="quantity-input-group">
                        <label>Quantity:</label>
                        <input type="number" class="form-control" id="bulk-quantity-input" value="50" min="1" max="1000">
                        <span style="font-size: 0.9em; color: #666;">This quantity will be applied to all selected displays</span>
                    </div>
                    
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="bulk-display-1" checked>
                            <label for="bulk-display-1"><strong>Display 1</strong> - BOMs & Reference</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="bulk-display-2" checked>
                            <label for="bulk-display-2"><strong>Display 2</strong> - Process Instructions</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="bulk-display-3" checked>
                            <label for="bulk-display-3"><strong>Display 3</strong> - Instructional Videos</label>
                        </div>
                    </div>
                </div>

                <div class="bulk-action-buttons">
                    <button class="btn btn-success btn-large" onclick="applyBulkConfiguration()">
                        üì° Apply to Selected Displays
                    </button>
                    <button class="btn btn-warning btn-large" onclick="refreshAllDisplays()">
                        üîÑ Refresh All
                    </button>
                    <button class="btn btn-primary btn-large" onclick="syncAllDisplays()">
                        üîó Sync All to Same Process
                    </button>
                </div>

                <div class="alert alert-info" style="margin-top: 15px;">
                    <strong>üí° How to use:</strong> 
                    1. Select BOM type (how BOMs are displayed across screens)
                    2. Set quantity and click a stage ‚Üí First process auto-selected
                    3. Select displays to update
                    4. Click "Apply to Selected Displays" ‚Üí Done!
                </div>
            </div>

            <!-- Individual Display Controls -->
            <div class="control-grid">
                <!-- Display 1 Control -->
                <div class="control-card">
                    <h3><span class="icon">üì∫</span>Display 1 - BOMs & Reference</h3>
                    
                    <div class="auto-info">
                        ‚ú® Stage selection auto-selects first process<br>
                        üìã Shows BOMs and reference materials
                    </div>
                    
                    <div class="form-group">
                        <label>Assembly Stage:</label>
                        <select class="form-control" id="stage-select-1" onchange="handleStageChange(1)">
                            <option value="">Loading stages...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Process (auto-selected):</label>
                        <select class="form-control" id="process-select-1">
                            <option value="">Select stage first</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Quantity:</label>
                        <input type="number" class="form-control" id="quantity-input-1" value="50" min="1" max="1000">
                    </div>

                    <div class="process-navigation">
                        <button class="btn btn-primary" onclick="previousProcess(1)">‚¨ÖÔ∏è Previous</button>
                        <button class="btn btn-primary" onclick="nextProcess(1)">‚û°Ô∏è Next</button>
                        <button class="btn btn-warning" onclick="updateConfiguration(1)">üíæ Update</button>
                        <button class="btn btn-success" onclick="testDisplay(1)">üß™ Test</button>
                    </div>

                    <div style="margin-top: 15px;">
                        <span class="loop-status loop-inactive" id="loop-status-1">üîÑ Loop: Inactive</span>
                        <button class="loop-toggle" id="loop-toggle-btn-1" onclick="toggleLoopMode(1)">Toggle Loop</button>
                    </div>
                </div>

                <!-- Display 2 Control -->
                <div class="control-card">
                    <h3><span class="icon">üì∫</span>Display 2 - Process Instructions</h3>
                    
                    <div class="auto-info">
                        ‚ú® Stage selection auto-selects first process<br>
                        üìã Shows process instructions and materials
                    </div>
                    
                    <div class="form-group">
                        <label>Assembly Stage:</label>
                        <select class="form-control" id="stage-select-2" onchange="handleStageChange(2)">
                            <option value="">Loading stages...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Process (auto-selected):</label>
                        <select class="form-control" id="process-select-2">
                            <option value="">Select stage first</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Quantity:</label>
                        <input type="number" class="form-control" id="quantity-input-2" value="50" min="1" max="1000">
                    </div>

                    <div class="process-navigation">
                        <button class="btn btn-primary" onclick="previousProcess(2)">‚¨ÖÔ∏è Previous</button>
                        <button class="btn btn-primary" onclick="nextProcess(2)">‚û°Ô∏è Next</button>
                        <button class="btn btn-warning" onclick="updateConfiguration(2)">üíæ Update</button>
                        <button class="btn btn-success" onclick="testDisplay(2)">üß™ Test</button>
                    </div>

                    <div style="margin-top: 15px;">
                        <span class="loop-status loop-inactive" id="loop-status-2">üîÑ Loop: Inactive</span>
                        <button class="loop-toggle" id="loop-toggle-btn-2" onclick="toggleLoopMode(2)">Toggle Loop</button>
                    </div>
                </div>

                <!-- Display 3 Control -->
                <div class="control-card">
                    <h3><span class="icon">üì∫</span>Display 3 - Instructional Videos</h3>
                    
                    <div class="auto-info">
                        ‚ú® Stage selection auto-selects first process<br>
                        üìã Shows instructional videos and guides
                    </div>
                    
                    <div class="form-group">
                        <label>Assembly Stage:</label>
                        <select class="form-control" id="stage-select-3" onchange="handleStageChange(3)">
                            <option value="">Loading stages...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Process (auto-selected):</label>
                        <select class="form-control" id="process-select-3">
                            <option value="">Select stage first</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Quantity:</label>
                        <input type="number" class="form-control" id="quantity-input-3" value="50" min="1" max="1000">
                    </div>

                    <div class="process-navigation">
                        <button class="btn btn-primary" onclick="previousProcess(3)">‚¨ÖÔ∏è Previous</button>
                        <button class="btn btn-primary" onclick="nextProcess(3)">‚û°Ô∏è Next</button>
                        <button class="btn btn-warning" onclick="updateConfiguration(3)">üíæ Update</button>
                        <button class="btn btn-success" onclick="testDisplay(3)">üß™ Test</button>
                    </div>

                    <div style="margin-top: 15px;">
                        <span class="loop-status loop-inactive" id="loop-status-3">üîÑ Loop: Inactive</span>
                        <button class="loop-toggle" id="loop-toggle-btn-3" onclick="toggleLoopMode(3)">Toggle Loop</button>
                    </div>
                </div>
            </div>

            <!-- Quick Links -->
            <div class="alert alert-info">
                <strong>üîó Quick Links:</strong>
                <div class="quick-actions">
                    <a href="workflow-guide.html" class="btn btn-primary">üìã View Workflow Guide</a>
                    <a href="/admin/" class="btn btn-warning">‚öôÔ∏è Admin Panel</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStationData = {};
        let isUserEditing = false;
        let editingTimeouts = {};
        let selectedBulkStage = null;
        let selectedBulkProcess = null;
        let selectedBulkBomType = 'batch_50';

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadStationData();
            loadAssemblyOptions();
            startStatusUpdates();
            addEditingProtectionToInputs();
        });

        // Select BOM type for bulk operations
        function selectBulkBomType(bomType) {
            document.querySelectorAll('.bom-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById(`bulk-bom-${bomType.replace('_', '-')}`).classList.add('selected');
            
            selectedBulkBomType = bomType;
            
            let message = '';
            switch(bomType) {
                case 'single_unit':
                    message = 'Single Unit BOM selected - will be split across displays 2 & 3';
                    break;
                case 'batch_50':
                    message = '50 Units BOM selected - will be split across displays 2 & 3';
                    break;
                case 'stage_specific':
                    message = 'Stage-Specific BOM selected - complete BOM will show only on Display 1';
                    break;
            }
            
            showSystemAlert(message, 'info');
        }

        // Enhanced stage change handler with auto-selection for individual displays
        function handleStageChange(displayNum) {
            const stageSelect = document.getElementById(`stage-select-${displayNum}`);
            const processSelect = document.getElementById(`process-select-${displayNum}`);
            const quantityInput = document.getElementById(`quantity-input-${displayNum}`);
            const stageId = stageSelect.value;
            
            if (!stageId) {
                processSelect.innerHTML = '<option value="">Select stage first</option>';
                processSelect.classList.remove('auto-selected');
                return;
            }

            const selectedStage = window.stagesData.find(s => s.id == stageId);
            if (!selectedStage || !selectedStage.processes.length) {
                processSelect.innerHTML = '<option value="">No processes available</option>';
                return;
            }

            processSelect.innerHTML = '';
            selectedStage.processes.forEach(process => {
                const option = document.createElement('option');
                option.value = process.id;
                option.textContent = `${process.name} - ${process.display_name}`;
                processSelect.appendChild(option);
            });

            const firstProcess = selectedStage.processes[0];
            processSelect.value = firstProcess.id;
            processSelect.classList.add('auto-selected');
            
            quantityInput.classList.add('auto-selected');
            
            showSystemAlert(`Display ${displayNum}: Auto-selected "${firstProcess.name}"`, 'success');
            
            setEditingMode(displayNum, true);
        }

        // Enhanced bulk stage selection with visual buttons
        function createStageButtons() {
            const stageButtonsContainer = document.getElementById('stage-buttons');
            stageButtonsContainer.innerHTML = '';

            if (!window.stagesData) return;

            window.stagesData.forEach(stage => {
                const button = document.createElement('div');
                button.className = 'stage-btn';
                button.onclick = () => selectBulkStage(stage, button);
                
                button.innerHTML = `
                    <div class="stage-name">${stage.display_name}</div>
                    <div class="stage-info">${stage.processes.length} processes</div>
                `;
                
                stageButtonsContainer.appendChild(button);
            });
        }

        // Handle bulk stage selection
        function selectBulkStage(stage, buttonElement) {
            document.querySelectorAll('.stage-btn').forEach(btn => btn.classList.remove('selected'));
            buttonElement.classList.add('selected');
            
            selectedBulkStage = stage;
            
            const processSelectionDiv = document.getElementById('process-selection');
            processSelectionDiv.style.display = 'block';
            
            const bulkProcessSelect = document.getElementById('bulk-process-select');
            bulkProcessSelect.innerHTML = '';
            
            stage.processes.forEach(process => {
                const option = document.createElement('option');
                option.value = process.id;
                option.textContent = `${process.name} - ${process.display_name}`;
                bulkProcessSelect.appendChild(option);
            });

            if (stage.processes.length > 0) {
                const firstProcess = stage.processes[0];
                bulkProcessSelect.value = firstProcess.id;
                bulkProcessSelect.classList.add('auto-selected');
                selectedBulkProcess = firstProcess;
                
                showSystemAlert(`Bulk: Auto-selected "${firstProcess.name}"`, 'info');
            }

            // Add event listener for manual process changes
            bulkProcessSelect.addEventListener('change', function() {
                const selectedProcessId = this.value;
                selectedBulkProcess = selectedBulkStage.processes.find(p => p.id == selectedProcessId);
                
                if (selectedBulkProcess) {
                    showSystemAlert(`Bulk: Manually selected "${selectedBulkProcess.name}"`, 'info');
                    this.classList.remove('auto-selected');
                }
            });
        }
        // Load assembly options with stage buttons
        async function loadAssemblyOptions() {
            try {
                const response = await fetch('/station/1/assembly/options/');
                const data = await response.json();
                
                window.stagesData = data.stages;
                
                createStageButtons();
                
                // Populate all three displays
                for (let i = 1; i <= 3; i++) {
                    populateStageSelect(data.stages, i);
                }
                
                // Update current config for all displays
                for (let i = 1; i <= 3; i++) {
                    const displayResponse = await fetch(`/station/${i}/assembly/options/`);
                    const displayData = await displayResponse.json();
                    updateCurrentConfig(displayData.current_config, i);
                }
            } catch (error) {
                console.error('Error loading assembly options:', error);
                showSystemAlert('Error loading assembly options', 'danger');
            }
        }

        // Populate stage select for individual displays
        function populateStageSelect(stages, displayNum) {
            const stageSelect = document.getElementById(`stage-select-${displayNum}`);
            stageSelect.innerHTML = '<option value="">Select Stage</option>';
            
            stages.forEach(stage => {
                const option = document.createElement('option');
                option.value = stage.id;
                option.textContent = stage.display_name;
                stageSelect.appendChild(option);
            });

            stageSelect.addEventListener('focus', function() {
                setEditingMode(displayNum, true);
            });

            stageSelect.addEventListener('blur', function() {
                setTimeout(() => {
                    setEditingMode(displayNum, false);
                }, 2000);
            });
        }

        // Enhanced apply bulk configuration with BOM type support
        async function applyBulkConfiguration() {
            const selectedDisplays = [];
            for (let i = 1; i <= 3; i++) {
                if (document.getElementById(`bulk-display-${i}`).checked) {
                    selectedDisplays.push(i);
                }
            }

            if (selectedDisplays.length === 0) {
                alert('Please select at least one display to update');
                return;
            }

            if (!selectedBulkStage || !selectedBulkProcess) {
                alert('Please select a stage first (stages auto-select the first process)');
                return;
            }

            let bomSettings = {};
            switch(selectedBulkBomType) {
                case 'single_unit':
                    bomSettings = {
                        show_single_unit_bom: true,
                        show_batch_bom: false
                    };
                    break;
                case 'batch_50':
                    bomSettings = {
                        show_single_unit_bom: false,
                        show_batch_bom: true
                    };
                    break;
                case 'stage_specific':
                    bomSettings = {
                        show_single_unit_bom: false,
                        show_batch_bom: false
                    };
                    break;
            }

            const bulkQuantity = parseInt(document.getElementById('bulk-quantity-input').value) || 50;

            const config = {
                stage_id: selectedBulkStage.id,
                process_id: selectedBulkProcess.id,
                quantity: bulkQuantity,
                ...bomSettings
            };

            try {
                showSystemAlert('Applying configuration to selected displays...', 'info');
                
                const promises = selectedDisplays.map(displayNum => 
                    fetch(`/station/${displayNum}/assembly/config/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    })
                );

                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));
                
                if (results.every(r => r.success)) {
                    const bomTypeText = selectedBulkBomType.replace('_', ' ').toUpperCase();
                    showSystemAlert(`‚úÖ ${bomTypeText} configuration applied successfully to displays: ${selectedDisplays.join(', ')} with quantity ${bulkQuantity}`, 'success');
                    
                    // Update individual display quantities to match bulk
                    selectedDisplays.forEach(displayNum => {
                        const quantityInput = document.getElementById(`quantity-input-${displayNum}`);
                        if (quantityInput) {
                            quantityInput.value = bulkQuantity;
                        }
                    });
                    
                    loadStationData();
                    loadAssemblyOptions();
                } else {
                    showSystemAlert('‚ö†Ô∏è Some displays failed to update', 'warning');
                }
            } catch (error) {
                showSystemAlert('‚ùå Error applying bulk configuration', 'danger');
            }
        }

        // Sync all displays to the same process
        async function syncAllDisplays() {
            // Use bulk settings for sync
            if (!selectedBulkStage || !selectedBulkProcess) {
                alert('Please set bulk configuration first, then use this to sync all displays to the same settings');
                return;
            }

            let bomSettings = {};
            switch(selectedBulkBomType) {
                case 'single_unit':
                    bomSettings = {
                        show_single_unit_bom: true,
                        show_batch_bom: false
                    };
                    break;
                case 'batch_50':
                    bomSettings = {
                        show_single_unit_bom: false,
                        show_batch_bom: true
                    };
                    break;
                case 'stage_specific':
                    bomSettings = {
                        show_single_unit_bom: false,
                        show_batch_bom: false
                    };
                    break;
            }

            const bulkQuantity = parseInt(document.getElementById('bulk-quantity-input').value) || 50;

            const config = {
                stage_id: selectedBulkStage.id,
                process_id: selectedBulkProcess.id,
                quantity: bulkQuantity,
                ...bomSettings
            };

            try {
                showSystemAlert('Syncing all displays to bulk configuration...', 'info');
                
                const promises = [1, 2, 3].map(displayNum => 
                    fetch(`/station/${displayNum}/assembly/config/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    })
                );

                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));
                
                if (results.every(r => r.success)) {
                    showSystemAlert('‚úÖ All displays synced successfully!', 'success');
                    
                    // Update individual display quantities
                    [2, 3].forEach(displayNum => {
                        const quantityInput = document.getElementById(`quantity-input-${displayNum}`);
                        if (quantityInput) {
                            quantityInput.value = bulkQuantity;
                        }
                    });
                    
                    loadStationData();
                    loadAssemblyOptions();
                } else {
                    showSystemAlert('‚ö†Ô∏è Some displays failed to sync', 'warning');
                }
            } catch (error) {
                showSystemAlert('‚ùå Error syncing displays', 'danger');
            }
        }

        // Load current station data
        async function loadStationData() {
            if (isAnyDisplayBeingEdited()) {
                return;
            }

            try {
                const responses = await Promise.all([
                    fetch('/station/1/media/'),
                    fetch('/station/2/media/'),
                    fetch('/station/3/media/')
                ]);

                for (let i = 0; i < responses.length; i++) {
                    const data = await responses[i].json();
                    updateDisplayStatus(i + 1, data);
                }
            } catch (error) {
                console.error('Error loading station data:', error);
            }
        }

        // Update display status with real-time data and BOM split info
        function updateDisplayStatus(displayNum, data) {
            const processElement = document.getElementById(`display${displayNum}-process`);
            const statusElement = document.getElementById(`display${displayNum}-status`);
            const connectionElement = document.getElementById(`display${displayNum}-connection`);
            
            if (data.station_info) {
                const station = data.station_info;
                
                let processText = 'No process selected';
                if (station.current_process && station.current_stage) {
                    processText = `${station.current_stage.name} - ${station.current_process.name}`;
                    
                    if (station.bom_settings) {
                        if (station.bom_settings.show_single_unit) {
                            processText += ' | Single Unit BOM';
                            if (displayNum > 1) processText += ' (Split)';
                        } else if (station.bom_settings.show_batch) {
                            processText += ' | 50 Units BOM';
                            if (displayNum > 1) processText += ' (Split)';
                        }
                    }
                    
                    if (station.loop_mode) {
                        processText += ' üîÑ';
                    }
                    
                    if (!station.clicker_enabled) {
                        processText += ' üö´';
                    }
                }
                
                processElement.textContent = processText;
                statusElement.className = 'status-indicator status-online';
                connectionElement.textContent = 'Connected';
                
                updateControlsFromStatus(station, displayNum);
                
            } else {
                processElement.textContent = 'Connection error';
                statusElement.className = 'status-indicator status-offline';
                connectionElement.textContent = 'Offline';
            }
        }

        // Update controls based on current station status
        function updateControlsFromStatus(station, displayNum) {
            if (editingTimeouts[displayNum]) {
                return; // Skip displays being edited
            }

            const stageSelect = document.getElementById(`stage-select-${displayNum}`);
            if (station.current_stage && stageSelect && stageSelect.value != station.current_stage.id) {
                stageSelect.value = station.current_stage.id;
                
                if (window.stagesData) {
                    const selectedStage = window.stagesData.find(s => s.id == station.current_stage.id);
                    if (selectedStage) {
                        populateProcessSelect(selectedStage.processes, displayNum);
                    }
                }
            }
            
            const processSelect = document.getElementById(`process-select-${displayNum}`);
            if (station.current_process && processSelect && processSelect.value != station.current_process.id) {
                processSelect.value = station.current_process.id;
            }
            
            const quantityInput = document.getElementById(`quantity-input-${displayNum}`);
            if (quantityInput && quantityInput.value != station.quantity) {
                quantityInput.value = station.quantity;
            }
            
            updateLoopStatus(station.loop_mode, displayNum);
        }

        // Populate process select for individual displays
        function populateProcessSelect(processes, displayNum) {
            const processSelect = document.getElementById(`process-select-${displayNum}`);
            const currentValue = processSelect.value;
            processSelect.innerHTML = '<option value="">Select Process</option>';
            
            processes.forEach(process => {
                const option = document.createElement('option');
                option.value = process.id;
                option.textContent = `${process.name} - ${process.display_name}`;
                processSelect.appendChild(option);
            });
            
            if (currentValue && processSelect.querySelector(`option[value="${currentValue}"]`)) {
                processSelect.value = currentValue;
            }

            processSelect.addEventListener('focus', function() {
                setEditingMode(displayNum, true);
            });

            processSelect.addEventListener('change', function() {
                setEditingMode(displayNum, true);
            });

            processSelect.addEventListener('blur', function() {
                setTimeout(() => {
                    setEditingMode(displayNum, false);
                }, 1000);
            });
        }

        // Update current configuration for specific display
        function updateCurrentConfig(config, displayNum) {
            const stageSelect = document.getElementById(`stage-select-${displayNum}`);
            if (stageSelect) {
                stageSelect.value = config.stage_id || '';
            }
            
            if (config.stage_id && window.stagesData) {
                const selectedStage = window.stagesData.find(s => s.id == config.stage_id);
                if (selectedStage) {
                    populateProcessSelect(selectedStage.processes, displayNum);
                    setTimeout(() => {
                        const processSelect = document.getElementById(`process-select-${displayNum}`);
                        if (processSelect) {
                            processSelect.value = config.process_id || '';
                        }
                    }, 100);
                }
            }
            
            const quantityInput = document.getElementById(`quantity-input-${displayNum}`);
            if (quantityInput) {
                const currentQuantity = config.quantity || 50;
                quantityInput.value = currentQuantity;
            }
            
            updateLoopStatus(config.loop_mode, displayNum);
        }

        // Set editing mode for specific display
        function setEditingMode(displayNum, editing) {
            if (editing) {
                editingTimeouts[displayNum] = true;
                if (editingTimeouts[`timeout_${displayNum}`]) {
                    clearTimeout(editingTimeouts[`timeout_${displayNum}`]);
                }
                editingTimeouts[`timeout_${displayNum}`] = setTimeout(() => {
                    editingTimeouts[displayNum] = false;
                }, 5000);
            } else {
                editingTimeouts[displayNum] = false;
                if (editingTimeouts[`timeout_${displayNum}`]) {
                    clearTimeout(editingTimeouts[`timeout_${displayNum}`]);
                }
            }
        }

        // Check if any display is being edited
        function isAnyDisplayBeingEdited() {
            return isUserEditing || Object.keys(editingTimeouts).some(key => 
                !key.startsWith('timeout_') && editingTimeouts[key] === true
            );
        }

        // Add editing protection for inputs
        function addEditingProtectionToInputs() {
            for (let i = 1; i <= 3; i++) {
                const quantityInput = document.getElementById(`quantity-input-${i}`);
                if (quantityInput) {
                    quantityInput.addEventListener('focus', function() {
                        setEditingMode(i, true);
                    });
                    quantityInput.addEventListener('blur', function() {
                        setTimeout(() => {
                            setEditingMode(i, false);
                        }, 1000);
                    });
                }
            }

            // Add listener for bulk quantity input
            const bulkQuantityInput = document.getElementById('bulk-quantity-input');
            if (bulkQuantityInput) {
                bulkQuantityInput.addEventListener('change', function() {
                    const newQuantity = parseInt(this.value);
                    if (newQuantity && newQuantity > 0) {
                        showSystemAlert(`‚úÖ Bulk quantity set to ${newQuantity}`, 'success');
                    }
                });
            }
        }

        // Process navigation functions
        async function previousProcess(displayNum) {
            await sendClickerAction('backward', displayNum);
        }

        async function nextProcess(displayNum) {
            await sendClickerAction('forward', displayNum);
        }

        async function toggleLoopMode(displayNum) {
            await sendClickerAction('toggle_loop', displayNum);
        }

        // Send clicker actions
        async function sendClickerAction(action, displayNum) {
            try {
                const actionBtns = document.querySelectorAll(`button[onclick*="${action}(${displayNum})"]`);
                actionBtns.forEach(btn => {
                    btn.style.opacity = '0.6';
                    btn.disabled = true;
                });

                const response = await fetch(`/station/${displayNum}/clicker/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSystemAlert(`Display ${displayNum}: ${action} successful`, 'success');
                    await refreshSingleDisplay(displayNum);
                } else {
                    showSystemAlert(`Display ${displayNum}: ${result.error || 'Action failed'}`, 'warning');
                }
            } catch (error) {
                showSystemAlert(`Display ${displayNum}: Error sending command`, 'danger');
            } finally {
                const actionBtns = document.querySelectorAll(`button[onclick*="${action}(${displayNum})"]`);
                actionBtns.forEach(btn => {
                    btn.style.opacity = '1';
                    btn.disabled = false;
                });
            }
        }

        // Update configuration for individual display
        async function updateConfiguration(displayNum) {
            const stageId = document.getElementById(`stage-select-${displayNum}`).value;
            const processId = document.getElementById(`process-select-${displayNum}`).value;
            const quantity = document.getElementById(`quantity-input-${displayNum}`).value;
            
            if (!stageId || !processId) {
                alert('Please select both stage and process');
                return;
            }
            
            // Use current bulk BOM settings
            let bomSettings = {};
            switch(selectedBulkBomType) {
                case 'single_unit':
                    bomSettings = {
                        show_single_unit_bom: true,
                        show_batch_bom: false
                    };
                    break;
                case 'batch_50':
                    bomSettings = {
                        show_single_unit_bom: false,
                        show_batch_bom: true
                    };
                    break;
                case 'stage_specific':
                    bomSettings = {
                        show_single_unit_bom: false,
                        show_batch_bom: false
                    };
                    break;
            }

            const config = {
                stage_id: stageId,
                process_id: processId,
                quantity: parseInt(quantity),
                ...bomSettings
            };

            const updateBtn = document.querySelector(`button[onclick="updateConfiguration(${displayNum})"]`);
            const originalText = updateBtn ? updateBtn.textContent : 'üíæ Update';

            try {
                if (updateBtn) {
                    updateBtn.textContent = '‚è≥ Updating...';
                    updateBtn.disabled = true;
                }

                const response = await fetch(`/station/${displayNum}/assembly/config/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                
                if (result.success) {
                    showSystemAlert(`Display ${displayNum} updated successfully`, 'success');
                    await refreshSingleDisplay(displayNum);
                } else {
                    showSystemAlert(`Display ${displayNum} update failed: ${result.error}`, 'danger');
                }
            } catch (error) {
                showSystemAlert(`Display ${displayNum}: Error updating configuration`, 'danger');
            } finally {
                if (updateBtn) {
                    updateBtn.textContent = originalText;
                    updateBtn.disabled = false;
                }
            }
        }

        // Refresh single display
        async function refreshSingleDisplay(displayNum) {
            try {
                const response = await fetch(`/station/${displayNum}/media/`);
                const data = await response.json();
                updateDisplayStatus(displayNum, data);
            } catch (error) {
                console.error(`Error refreshing display ${displayNum}:`, error);
            }
        }

        // Update loop status display
        function updateLoopStatus(isActive, displayNum) {
            const loopStatus = document.getElementById(`loop-status-${displayNum}`);
            const loopToggleBtn = document.getElementById(`loop-toggle-btn-${displayNum}`);
            
            if (loopStatus && loopToggleBtn) {
                if (isActive) {
                    loopStatus.textContent = 'üîÑ Loop: Active';
                    loopStatus.className = 'loop-status loop-active';
                    loopToggleBtn.classList.add('active');
                    loopToggleBtn.textContent = 'Disable Loop';
                } else {
                    loopStatus.textContent = 'üîÑ Loop: Inactive';
                    loopStatus.className = 'loop-status loop-inactive';
                    loopToggleBtn.classList.remove('active');
                    loopToggleBtn.textContent = 'Enable Loop';
                }
            }
        }

        // Refresh all displays
        function refreshAllDisplays() {
            loadStationData();
            loadAssemblyOptions();
            showSystemAlert('Refreshing all displays...', 'info');
        }

        // Test display
        function testDisplay(displayNum) {
            window.open(`/station/${displayNum}/slider/`, '_blank');
        }

        // Show system alerts
        function showSystemAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.maxWidth = '400px';
            alertDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            alertDiv.innerHTML = `
                <strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">√ó</button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Start periodic status updates
        function startStatusUpdates() {
            setInterval(async () => {
                await loadStationData();
            }, 3000);
            
            setInterval(async () => {
                await loadAssemblyOptions();
            }, 30000);
        }
    </script>
</body>
</html>