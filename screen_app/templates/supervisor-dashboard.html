<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRG Assembly 40K - Supervisor Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        /* Enhanced Bulk Controls Section */
        .bulk-controls {
            background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #2196f3;
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.1);
        }

        .bulk-controls h3 {
            color: #1976d2;
            margin-bottom: 20px;
            font-size: 1.6em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quick-setup-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .quick-setup-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        /* NEW: BOM Type Selection */
        .bom-type-selection {
            background: #fff9c4;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
        }

        .bom-type-selection h4 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .bom-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .bom-option {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .bom-option:hover {
            border-color: #ffc107;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.2);
        }

        .bom-option.selected {
            border-color: #28a745;
            background: #f8fff8;
        }

        .bom-option-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .bom-option-title {
            font-weight: bold;
            font-size: 1.1em;
            color: #2c3e50;
        }

        .bom-option-description {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .bom-split-indicator {
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
        }

        .bom-split-indicator.complete {
            background: #e8f5e8;
            color: #27ae60;
        }

        .stage-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stage-btn {
            padding: 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
            position: relative;
        }

        .stage-btn:hover {
            border-color: #3498db;
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
        }

        .stage-btn.selected {
            border-color: #27ae60;
            background: #e8f5e8;
            color: #27ae60;
        }

        .stage-btn .stage-name {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .stage-btn .stage-info {
            font-size: 0.9em;
            color: #666;
        }

        .process-selection {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .checkbox-group {
            display: flex;
            gap: 25px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            border-color: #3498db;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3498db;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .control-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }

        .control-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            font-size: 1.5em;
        }

        .status-overview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .display-status {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 4px solid;
        }

        .display-1 { border-top-color: #FF6B6B; }
        .display-2 { border-top-color: #4ECDC4; }
        .display-3 { border-top-color: #45B7D1; }

        .display-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .display-type {
            color: #666;
            margin-bottom: 15px;
        }

        .current-process {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            color: #2d5a2d;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            border-color: #3498db;
            outline: none;
        }

        .form-control.auto-selected {
            background: #e8f5e8;
            border-color: #27ae60;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            margin: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-large {
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 12px;
        }

        .process-navigation {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #b8daff;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .loop-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .loop-active {
            background: #fff3cd;
            color: #856404;
        }

        .loop-inactive {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online { background: #27ae60; }
        .status-offline { background: #e74c3c; }
        .status-loading { background: #f39c12; }

        .loop-toggle {
            background: #f39c12;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .loop-toggle:hover {
            background: #e67e22;
        }

        .loop-toggle.active {
            background: #27ae60;
        }

        .auto-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #2d5a2d;
            margin-bottom: 15px;
        }

        .bulk-action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        /* NEW: Individual BOM controls for Display 1 */
        .bom-controls {
            background: #fff9c4;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ffc107;
            margin-bottom: 15px;
        }

        .bom-controls h5 {
            color: #856404;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .bom-radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bom-radio-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .bom-radio-item:hover {
            border-color: #ffc107;
        }

        .bom-radio-item.selected {
            border-color: #28a745;
            background: #f8fff8;
        }

        .bom-radio-item input[type="radio"] {
            width: 16px;
            height: 16px;
            accent-color: #ffc107;
        }

        .bom-description {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .status-overview {
                grid-template-columns: 1fr;
            }
            
            .process-navigation {
                flex-direction: column;
            }

            .stage-buttons {
                grid-template-columns: 1fr;
            }

            .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }

            .bom-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üè≠ BRG Assembly 40K - Supervisor Dashboard</h1>
            <p>Easy assembly control with BOM split functionality and bulk operations</p>
        </div>

        <div class="main-content">
            <!-- Display Status Overview -->
            <div class="status-overview">
                <div class="display-status display-1">
                    <div class="display-number">1</div>
                    <div class="display-type">BOMs & Reference</div>
                    <div class="current-process" id="display1-process">Loading...</div>
                    <div style="margin-top: 10px;">
                        <span class="status-indicator status-loading" id="display1-status"></span>
                        <span id="display1-connection">Checking...</span>
                    </div>
                </div>
                <div class="display-status display-2">
                    <div class="display-number">2</div>
                    <div class="display-type">Process Instructions</div>
                    <div class="current-process" id="display2-process">Loading...</div>
                    <div style="margin-top: 10px;">
                        <span class="status-indicator status-loading" id="display2-status"></span>
                        <span id="display2-connection">Checking...</span>
                    </div>
                </div>
                <div class="display-status display-3">
                    <div class="display-number">3</div>
                    <div class="display-type">Instructional Videos</div>
                    <div class="current-process" id="display3-process">Loading...</div>
                    <div style="margin-top: 10px;">
                        <span class="status-indicator status-loading" id="display3-status"></span>
                        <span id="display3-connection">Checking...</span>
                    </div>
                </div>
            </div>

            <!-- Enhanced Bulk Control Section -->
            <div class="bulk-controls">
                <h3>üéõÔ∏è Easy Bulk Operations</h3>
                
                <!-- NEW: BOM Type Selection for Bulk Operations -->
                <div class="bom-type-selection">
                    <h4>üìã Select BOM Type for All Displays</h4>
                    <div class="bom-options" id="bulk-bom-options">
                        <div class="bom-option" onclick="selectBulkBomType('single_unit')" id="bulk-bom-single">
                            <div class="bom-option-header">
                                <span style="font-size: 1.5em;">üìÑ</span>
                                <span class="bom-option-title">Single Unit BOM</span>
                            </div>
                            <div class="bom-option-description">
                                Shows BOM for 1 unit only. Great for reference and training.
                            </div>
                            <div class="bom-split-indicator">
                                üîÑ Split across Displays 1, 2, 3
                            </div>
                        </div>
                        
                        <div class="bom-option selected" onclick="selectBulkBomType('batch_50')" id="bulk-bom-batch">
                            <div class="bom-option-header">
                                <span style="font-size: 1.5em;">üì¶</span>
                                <span class="bom-option-title">50 Units BOM</span>
                            </div>
                            <div class="bom-option-description">
                                Shows BOM for production batch. Quantities multiplied by batch size.
                            </div>
                            <div class="bom-split-indicator">
                                üîÑ Split across Displays 1, 2, 3
                            </div>
                        </div>
                        
                        <div class="bom-option" onclick="selectBulkBomType('stage_specific')" id="bulk-bom-stage">
                            <div class="bom-option-header">
                                <span style="font-size: 1.5em;">üéØ</span>
                                <span class="bom-option-title">Stage-Specific BOM</span>
                            </div>
                            <div class="bom-option-description">
                                Shows BOM specific to current assembly stage only.
                            </div>
                            <div class="bom-split-indicator complete">
                                üì∫ Complete on Display 1 only
                            </div>
                        </div>
                    </div>
                </div>

                <div class="quick-setup-section">
                    <h4>üìã Quick Stage Selection</h4>
                    <div class="auto-info">
                        ‚ú® <strong>Auto-Selection:</strong> Click a stage below and the first process will be automatically selected. You can change the process if needed.
                    </div>
                    
                    <div class="stage-buttons" id="stage-buttons">
                        <!-- Stage buttons will be populated here -->
                    </div>
                    
                    <div class="process-selection" id="process-selection" style="display: none;">
                        <label><strong>Selected Process (auto-selected first, change if needed):</strong></label>
                        <select class="form-control" id="bulk-process-select">
                            <option value="">Loading processes...</option>
                        </select>
                    </div>
                </div>

                <div class="quick-setup-section">
                    <h4>üì∫ Select Displays to Update</h4>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="bulk-display-1" checked>
                            <label for="bulk-display-1"><strong>Display 1</strong> - BOMs & Reference</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="bulk-display-2" checked>
                            <label for="bulk-display-2"><strong>Display 2</strong> - Process Instructions</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="bulk-display-3" checked>
                            <label for="bulk-display-3"><strong>Display 3</strong> - Instructional Videos</label>
                        </div>
                    </div>
                </div>

                <div class="bulk-action-buttons">
                    <button class="btn btn-success btn-large" onclick="applyBulkConfiguration()">
                        üì° Apply to Selected Displays
                    </button>
                    <button class="btn btn-warning btn-large" onclick="refreshAllDisplays()">
                        üîÑ Refresh All
                    </button>
                    <button class="btn btn-primary btn-large" onclick="syncAllDisplays()">
                        üîó Sync All to Same Process
                    </button>
                </div>

                <div class="alert alert-info" style="margin-top: 15px;">
                    <strong>üí° How to use:</strong> 
                    1. Select BOM type (Single Unit/50 Units split across all displays, or Stage-specific on Display 1)
                    2. Click a stage ‚Üí First process auto-selected
                    3. Select displays to update
                    4. Click "Apply to Selected Displays" ‚Üí Done!
                </div>
            </div>

            <!-- Individual Display Controls -->
            <div class="control-grid">
                <!-- Display 1 Control -->
                <div class="control-card">
                    <h3><span class="icon">üì∫</span>Display 1 - BOMs & Reference</h3>
                    
                    <div class="auto-info">
                        ‚ú® Stage selection auto-selects first process
                    </div>
                    
                    <!-- NEW: Enhanced BOM Controls for Display 1 -->
                    <div class="bom-controls">
                        <h5>üìã BOM Display Type</h5>
                        <div class="bom-radio-group">
                            <div class="bom-radio-item" onclick="selectBomType(1, 'single')">
                                <input type="radio" name="bom-type-1" value="single" id="bom-single-1">
                                <div>
                                    <strong>Single Unit BOM (Split)</strong>
                                    <div class="bom-description">Part of items shown here, rest on Displays 2 & 3</div>
                                </div>
                            </div>
                            <div class="bom-radio-item selected" onclick="selectBomType(1, 'batch')">
                                <input type="radio" name="bom-type-1" value="batch" id="bom-batch-1" checked>
                                <div>
                                    <strong>50 Units BOM (Split)</strong>
                                    <div class="bom-description">Part of items shown here, rest on Displays 2 & 3</div>
                                </div>
                            </div>
                            <div class="bom-radio-item" onclick="selectBomType(1, 'stage')">
                                <input type="radio" name="bom-type-1" value="stage" id="bom-stage-1">
                                <div>
                                    <strong>Stage-Specific BOM (Complete)</strong>
                                    <div class="bom-description">All stage items shown only on Display 1</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Assembly Stage:</label>
                        <select class="form-control" id="stage-select-1" onchange="handleStageChange(1)">
                            <option value="">Loading stages...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Process (auto-selected):</label>
                        <select class="form-control" id="process-select-1">
                            <option value="">Select stage first</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Quantity:</label>
                        <input type="number" class="form-control" id="quantity-input-1" value="50" min="1" max="1000">
                    </div>

                    <div class="process-navigation">
                        <button class="btn btn-primary" onclick="previousProcess(1)">‚¨ÖÔ∏è Previous</button>
                        <button class="btn btn-primary" onclick="nextProcess(1)">‚û°Ô∏è Next</button>
                        <button class="btn btn-warning" onclick="updateConfiguration(1)">üíæ Update</button>
                        <button class="btn btn-success" onclick="testDisplay(1)">üß™ Test</button>
                    </div>

                    <div style="margin-top: 15px;">
                        <span class="loop-status loop-inactive" id="loop-status-1">üîÑ Loop: Inactive</span>
                        <button class="loop-toggle" id="loop-toggle-btn-1" onclick="toggleLoopMode(1)">Toggle Loop</button>
                    </div>
                </div>

                <!-- Display 2 Control -->
                <div class="control-card">
                    <h3><span class="icon">üì∫</span>Display 2 - Process Instructions</h3>
                    
                    <div class="auto-info">
                        ‚ú® Stage selection auto-selects first process<br>
                        üìã Shows split BOM items when Single Unit or 50 Units BOM is selected
                    </div>
                    
                    <div class="form-group">
                        <label>Assembly Stage:</label>
                        <select class="form-control" id="stage-select-2" onchange="handleStageChange(2)">
                            <option value="">Loading stages...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Process (auto-selected):</label>
                        <select class="form-control" id="process-select-2">
                            <option value="">Select stage first</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Quantity:</label>
                        <input type="number" class="form-control" id="quantity-input-2" value="50" min="1" max="1000">
                    </div>

                    <div class="process-navigation">
                        <button class="btn btn-primary" onclick="previousProcess(2)">‚¨ÖÔ∏è Previous</button>
                        <button class="btn btn-primary" onclick="nextProcess(2)">‚û°Ô∏è Next</button>
                        <button class="btn btn-warning" onclick="updateConfiguration(2)">üíæ Update</button>
                        <button class="btn btn-success" onclick="testDisplay(2)">üß™ Test</button>
                    </div>

                    <div style="margin-top: 15px;">
                        <span class="loop-status loop-inactive" id="loop-status-2">üîÑ Loop: Inactive</span>
                        <button class="loop-toggle" id="loop-toggle-btn-2" onclick="toggleLoopMode(2)">Toggle Loop</button>
                    </div>
                </div>

                <!-- Display 3 Control -->
                <div class="control-card">
                    <h3><span class="icon">üì∫</span>Display 3 - Instructional Videos</h3>
                    
                    <div class="auto-info">
                        ‚ú® Stage selection auto-selects first process<br>
                        üìã Shows split BOM items when Single Unit or 50 Units BOM is selected
                    </div>
                    
                    <div class="form-group">
                        <label>Assembly Stage:</label>
                        <select class="form-control" id="stage-select-3" onchange="handleStageChange(3)">
                            <option value="">Loading stages...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Process (auto-selected):</label>
                        <select class="form-control" id="process-select-3">
                            <option value="">Select stage first</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Quantity:</label>
                        <input type="number" class="form-control" id="quantity-input-3" value="50" min="1" max="1000">
                    </div>

<div class="process-navigation">
                        <button class="btn btn-primary" onclick="previousProcess(3)">‚¨ÖÔ∏è Previous</button>
                        <button class="btn btn-primary" onclick="nextProcess(3)">‚û°Ô∏è Next</button>
                        <button class="btn btn-warning" onclick="updateConfiguration(3)">üíæ Update</button>
                        <button class="btn btn-success" onclick="testDisplay(3)">üß™ Test</button>
                    </div>

                    <div style="margin-top: 15px;">
                        <span class="loop-status loop-inactive" id="loop-status-3">üîÑ Loop: Inactive</span>
                        <button class="loop-toggle" id="loop-toggle-btn-3" onclick="toggleLoopMode(3)">Toggle Loop</button>
                    </div>
                </div>
            </div>

            <!-- Quick Links -->
            <div class="alert alert-info">
                <strong>üîó Quick Links:</strong>
                <div class="quick-actions">
                    <a href="workflow-guide.html" class="btn btn-primary">üìã View Workflow Guide</a>
                    <a href="/admin/" class="btn btn-warning">‚öôÔ∏è Admin Panel</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStationData = {};
        let isUserEditing = false;
        let editingTimeouts = {};
        let selectedBulkStage = null;
        let selectedBulkProcess = null;
        let selectedBulkBomType = 'batch_50'; // Default to 50 Units BOM
        let lastUsedQuantities = {
            1: 50,  // Default for Display 1
            2: 50,  // Default for Display 2
            3: 50,  // Default for Display 3
            bulk: 50 // Default for bulk operations
        };

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadStationData();
            loadAssemblyOptions();
            startStatusUpdates();
            addEditingProtectionToInputs();
        });

        // NEW: Select BOM type for bulk operations
        function selectBulkBomType(bomType) {
            // Update visual selection
            document.querySelectorAll('.bom-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById(`bulk-bom-${bomType.replace('_', '-')}`).classList.add('selected');
            
            selectedBulkBomType = bomType;
            
            let message = '';
            switch(bomType) {
                case 'single_unit':
                    message = 'Single Unit BOM selected - will be split across all displays';
                    break;
                case 'batch_50':
                    message = '50 Units BOM selected - will be split across all displays';
                    break;
                case 'stage_specific':
                    message = 'Stage-Specific BOM selected - complete BOM will show only on Display 1';
                    break;
            }
            
            showSystemAlert(message, 'info');
        }

        // NEW: Select BOM type for individual Display 1
        function selectBomType(displayNum, bomType) {
            if (displayNum !== 1) return; // Only Display 1 has individual BOM controls
            
            // Update visual selection
            document.querySelectorAll('.bom-radio-item').forEach(item => item.classList.remove('selected'));
            document.querySelector(`input[name="bom-type-1"][value="${bomType}"]`).closest('.bom-radio-item').classList.add('selected');
            
            // Update radio button
            document.querySelector(`input[name="bom-type-1"][value="${bomType}"]`).checked = true;
            
            let message = '';
            switch(bomType) {
                case 'single':
                    message = 'Display 1: Single Unit BOM (Split) - shows part of items';
                    break;
                case 'batch':
                    message = 'Display 1: 50 Units BOM (Split) - shows part of items';
                    break;
                case 'stage':
                    message = 'Display 1: Stage-Specific BOM (Complete) - shows all stage items';
                    break;
            }
            
            showSystemAlert(message, 'success');
            setEditingMode(displayNum, true);
        }

        // Enhanced stage change handler with auto-selection for individual displays
        function handleStageChange(displayNum) {
            const stageSelect = document.getElementById(`stage-select-${displayNum}`);
            const processSelect = document.getElementById(`process-select-${displayNum}`);
            const quantityInput = document.getElementById(`quantity-input-${displayNum}`);
            const stageId = stageSelect.value;
            
            if (!stageId) {
                processSelect.innerHTML = '<option value="">Select stage first</option>';
                processSelect.classList.remove('auto-selected');
                return;
            }

            // Find the selected stage
            const selectedStage = window.stagesData.find(s => s.id == stageId);
            if (!selectedStage || !selectedStage.processes.length) {
                processSelect.innerHTML = '<option value="">No processes available</option>';
                return;
            }

            // Populate processes
            processSelect.innerHTML = '';
            selectedStage.processes.forEach(process => {
                const option = document.createElement('option');
                option.value = process.id;
                option.textContent = `${process.name} - ${process.display_name}`;
                processSelect.appendChild(option);
            });

            // AUTO-SELECT the first process
            const firstProcess = selectedStage.processes[0];
            processSelect.value = firstProcess.id;
            processSelect.classList.add('auto-selected');
            
            // USE LAST USED QUANTITY instead of default 50
            quantityInput.value = lastUsedQuantities[displayNum];
            quantityInput.classList.add('auto-selected');
            
            // Show visual feedback
            showSystemAlert(`Display ${displayNum}: Auto-selected "${firstProcess.name}" with quantity ${lastUsedQuantities[displayNum]}`, 'success');
            
            setEditingMode(displayNum, true);
        }

        // Enhanced bulk stage selection with visual buttons
        function createStageButtons() {
            const stageButtonsContainer = document.getElementById('stage-buttons');
            stageButtonsContainer.innerHTML = '';

            if (!window.stagesData) return;

            window.stagesData.forEach(stage => {
                const button = document.createElement('div');
                button.className = 'stage-btn';
                button.onclick = () => selectBulkStage(stage, button);
                
                button.innerHTML = `
                    <div class="stage-name">${stage.display_name}</div>
                    <div class="stage-info">${stage.processes.length} processes</div>
                `;
                
                stageButtonsContainer.appendChild(button);
            });
        }

        // Handle bulk stage selection
        function selectBulkStage(stage, buttonElement) {
            // Update visual selection
            document.querySelectorAll('.stage-btn').forEach(btn => btn.classList.remove('selected'));
            buttonElement.classList.add('selected');
            
            selectedBulkStage = stage;
            
            // Show process selection
            const processSelectionDiv = document.getElementById('process-selection');
            processSelectionDiv.style.display = 'block';
            
            // Populate processes
            const bulkProcessSelect = document.getElementById('bulk-process-select');
            bulkProcessSelect.innerHTML = '';
            
            stage.processes.forEach(process => {
                const option = document.createElement('option');
                option.value = process.id;
                option.textContent = `${process.name} - ${process.display_name}`;
                bulkProcessSelect.appendChild(option);
            });

            // AUTO-SELECT the first process
            if (stage.processes.length > 0) {
                const firstProcess = stage.processes[0];
                bulkProcessSelect.value = firstProcess.id;
                bulkProcessSelect.classList.add('auto-selected');
                selectedBulkProcess = firstProcess;
                
                showSystemAlert(`Bulk: Auto-selected "${firstProcess.name}" with quantity ${lastUsedQuantities.bulk}`, 'info');
            }
        }

        // Load assembly options with stage buttons
        async function loadAssemblyOptions() {
            try {
                const response = await fetch('/station/1/assembly/options/');
                const data = await response.json();
                
                window.stagesData = data.stages;
                
                // Create stage buttons for bulk operations
                createStageButtons();
                
                // Populate individual display selects
                for (let i = 1; i <= 3; i++) {
                    populateStageSelect(data.stages, i);
                }
                
                // Update current config for each display
                for (let i = 1; i <= 3; i++) {
                    const displayResponse = await fetch(`/station/${i}/assembly/options/`);
                    const displayData = await displayResponse.json();
                    updateCurrentConfig(displayData.current_config, i);
                }
            } catch (error) {
                console.error('Error loading assembly options:', error);
                showSystemAlert('Error loading assembly options', 'danger');
            }
        }

        // Populate stage select for individual displays
        function populateStageSelect(stages, displayNum) {
            const stageSelect = document.getElementById(`stage-select-${displayNum}`);
            stageSelect.innerHTML = '<option value="">Select Stage</option>';
            
            stages.forEach(stage => {
                const option = document.createElement('option');
                option.value = stage.id;
                option.textContent = stage.display_name;
                stageSelect.appendChild(option);
            });

            stageSelect.addEventListener('focus', function() {
                setEditingMode(displayNum, true);
            });

            stageSelect.addEventListener('blur', function() {
                setTimeout(() => {
                    setEditingMode(displayNum, false);
                }, 2000);
            });
        }

        // Enhanced apply bulk configuration with BOM type support
        async function applyBulkConfiguration() {
            const selectedDisplays = [];
            for (let i = 1; i <= 3; i++) {
                if (document.getElementById(`bulk-display-${i}`).checked) {
                    selectedDisplays.push(i);
                }
            }

            if (selectedDisplays.length === 0) {
                alert('Please select at least one display to update');
                return;
            }

            if (!selectedBulkStage || !selectedBulkProcess) {
                alert('Please select a stage first (stages auto-select the first process)');
                return;
            }

            // Determine BOM settings based on selected BOM type
            let bomSettings = {};
            switch(selectedBulkBomType) {
                case 'single_unit':
                    bomSettings = {
                        show_single_unit_bom: true,
                        show_batch_bom: false
                    };
                    break;
                case 'batch_50':
                    bomSettings = {
                        show_single_unit_bom: false,
                        show_batch_bom: true
                    };
                    break;
                case 'stage_specific':
                    bomSettings = {
                        show_single_unit_bom: false,
                        show_batch_bom: false
                    };
                    break;
            }

            const config = {
                stage_id: selectedBulkStage.id,
                process_id: selectedBulkProcess.id,
                quantity: lastUsedQuantities.bulk,
                ...bomSettings
            };

            try {
                showSystemAlert('Applying configuration to selected displays...', 'info');
                
                const promises = selectedDisplays.map(displayNum => 
                    fetch(`/station/${displayNum}/assembly/config/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    })
                );

                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));
                
                if (results.every(r => r.success)) {
                    const bomTypeText = selectedBulkBomType.replace('_', ' ').toUpperCase();
                    showSystemAlert(`‚úÖ ${bomTypeText} configuration applied successfully to displays: ${selectedDisplays.join(', ')} with quantity ${lastUsedQuantities.bulk}`, 'success');
                    loadStationData();
                    loadAssemblyOptions();
                } else {
                    showSystemAlert('‚ö†Ô∏è Some displays failed to update', 'warning');
                }
            } catch (error) {
                showSystemAlert('‚ùå Error applying bulk configuration', 'danger');
            }
        }

        // Sync all displays to the same process
        async function syncAllDisplays() {
            // Get the configuration from Display 1
            const stage1 = document.getElementById('stage-select-1').value;
            const process1 = document.getElementById('process-select-1').value;
            const quantity1 = document.getElementById('quantity-input-1').value;

            if (!stage1 || !process1) {
                alert('Please set Display 1 configuration first, then use this to sync all displays to the same settings');
                return;
            }

            // Get BOM type from Display 1
            const bomType1 = document.querySelector('input[name="bom-type-1"]:checked').value;
            let bomSettings = {};
            switch(bomType1) {
                case 'single':
                    bomSettings = {
                        show_single_unit_bom: true,
                        show_batch_bom: false
                    };
                    break;
                case 'batch':
                    bomSettings = {
                        show_single_unit_bom: false,
                        show_batch_bom: true
                    };
                    break;
                case 'stage':
                    bomSettings = {
                        show_single_unit_bom: false,
                        show_batch_bom: false
                    };
                    break;
            }

            const config = {
                stage_id: stage1,
                process_id: process1,
                quantity: parseInt(quantity1),
                ...bomSettings
            };

            try {
                showSystemAlert('Syncing all displays to Display 1 configuration...', 'info');
                
                const promises = [2, 3].map(displayNum => 
                    fetch(`/station/${displayNum}/assembly/config/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    })
                );

                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));
                
                if (results.every(r => r.success)) {
                    showSystemAlert('‚úÖ All displays synced successfully!', 'success');
                    loadStationData();
                    loadAssemblyOptions();
                } else {
                    showSystemAlert('‚ö†Ô∏è Some displays failed to sync', 'warning');
                }
            } catch (error) {
                showSystemAlert('‚ùå Error syncing displays', 'danger');
            }
        }

        // Load current station data
        async function loadStationData() {
            // Skip auto-refresh if user is editing
            if (isAnyDisplayBeingEdited()) {
                return;
            }

            try {
                const responses = await Promise.all([
                    fetch('/station/1/media/'),
                    fetch('/station/2/media/'),
                    fetch('/station/3/media/')
                ]);

                for (let i = 0; i < responses.length; i++) {
                    const data = await responses[i].json();
                    updateDisplayStatus(i + 1, data);
                }
            } catch (error) {
                console.error('Error loading station data:', error);
            }
        }

        // Update display status with real-time data and BOM split info
        function updateDisplayStatus(displayNum, data) {
            const processElement = document.getElementById(`display${displayNum}-process`);
            const statusElement = document.getElementById(`display${displayNum}-status`);
            const connectionElement = document.getElementById(`display${displayNum}-connection`);
            
            if (data.station_info) {
                const station = data.station_info;
                
                // Update process display with BOM info
                let processText = 'No process selected';
                if (station.current_process && station.current_stage) {
                    processText = `${station.current_stage.name} - ${station.current_process.name}`;
                    
                    // Add BOM type indicator
                    if (station.bom_settings) {
                        if (station.bom_settings.show_single_unit) {
                            processText += ' | Single Unit BOM';
                            if (displayNum > 1) processText += ' (Split)';
                        } else if (station.bom_settings.show_batch) {
                            processText += ' | 50 Units BOM';
                            if (displayNum > 1) processText += ' (Split)';
                        }
                    }
                    
                    if (station.loop_mode) {
                        processText += ' üîÑ';
                    }
                    
                    if (!station.clicker_enabled) {
                        processText += ' üö´';
                    }
                }
                
                processElement.textContent = processText;
                statusElement.className = 'status-indicator status-online';
                connectionElement.textContent = 'Connected';
                
                updateControlsFromStatus(station, displayNum);
                
            } else {
                processElement.textContent = 'Connection error';
                statusElement.className = 'status-indicator status-offline';
                connectionElement.textContent = 'Offline';
            }
        }

        // Update controls based on current station status
        function updateControlsFromStatus(station, displayNum) {
            if (editingTimeouts[displayNum]) {
                return;
            }

            const stageSelect = document.getElementById(`stage-select-${displayNum}`);
            if (station.current_stage && stageSelect.value != station.current_stage.id) {
                stageSelect.value = station.current_stage.id;
                
                if (window.stagesData) {
                    const selectedStage = window.stagesData.find(s => s.id == station.current_stage.id);
                    if (selectedStage) {
                        populateProcessSelect(selectedStage.processes, displayNum);
                    }
                }
            }
            
            const processSelect = document.getElementById(`process-select-${displayNum}`);
            if (station.current_process && processSelect.value != station.current_process.id) {
                processSelect.value = station.current_process.id;
            }
            
            const quantityInput = document.getElementById(`quantity-input-${displayNum}`);
            if (quantityInput.value != station.quantity) {
                quantityInput.value = station.quantity;
            }
            
            updateLoopStatus(station.loop_mode, displayNum);
            
            // Update BOM type for Display 1
            if (displayNum === 1 && station.bom_settings) {
                let bomType = 'batch'; // Default
                if (station.bom_settings.show_single_unit) {
                    bomType = 'single';
                } else if (!station.bom_settings.show_single_unit && !station.bom_settings.show_batch) {
                    bomType = 'stage';
                }
                
                const bomRadio = document.querySelector(`input[name="bom-type-1"][value="${bomType}"]`);
                if (bomRadio && !bomRadio.checked) {
                    bomRadio.checked = true;
                    selectBomType(1, bomType);
                }
            }
        }

        // Populate process select for individual displays
        function populateProcessSelect(processes, displayNum) {
            const processSelect = document.getElementById(`process-select-${displayNum}`);
            const currentValue = processSelect.value;
            processSelect.innerHTML = '<option value="">Select Process</option>';
            
            processes.forEach(process => {
                const option = document.createElement('option');
                option.value = process.id;
                option.textContent = `${process.name} - ${process.display_name}`;
                processSelect.appendChild(option);
            });
            
            if (currentValue && processSelect.querySelector(`option[value="${currentValue}"]`)) {
                processSelect.value = currentValue;
            }

            processSelect.addEventListener('focus', function() {
                setEditingMode(displayNum, true);
            });

            processSelect.addEventListener('change', function() {
                setEditingMode(displayNum, true);
            });

            processSelect.addEventListener('blur', function() {
                setTimeout(() => {
                    setEditingMode(displayNum, false);
                }, 1000);
            });
        }

        // Update current configuration for specific display
        function updateCurrentConfig(config, displayNum) {
            const stageSelect = document.getElementById(`stage-select-${displayNum}`);
            stageSelect.value = config.stage_id || '';
            
            if (config.stage_id && window.stagesData) {
                const selectedStage = window.stagesData.find(s => s.id == config.stage_id);
                if (selectedStage) {
                    populateProcessSelect(selectedStage.processes, displayNum);
                    setTimeout(() => {
                        document.getElementById(`process-select-${displayNum}`).value = config.process_id || '';
                    }, 100);
                }
            }
            
            // Update quantity and remember it
            const currentQuantity = config.quantity || 50;
            document.getElementById(`quantity-input-${displayNum}`).value = currentQuantity;
            lastUsedQuantities[displayNum] = currentQuantity;
            lastUsedQuantities.bulk = currentQuantity; // Also update bulk default
            
            updateLoopStatus(config.loop_mode, displayNum);
            
            // Update BOM type for Display 1
            if (displayNum === 1 && config.bom_settings) {
                let bomType = 'batch'; // Default
                if (config.bom_settings.show_single_unit) {
                    bomType = 'single';
                } else if (!config.bom_settings.show_single_unit && !config.bom_settings.show_batch) {
                    bomType = 'stage';
                }
                
                const bomRadio = document.querySelector(`input[name="bom-type-1"][value="${bomType}"]`);
                if (bomRadio) {
                    bomRadio.checked = true;
                    selectBomType(1, bomType);
                }
            }
        }

        // Set editing mode for specific display
        function setEditingMode(displayNum, editing) {
            if (editing) {
                editingTimeouts[displayNum] = true;
                if (editingTimeouts[`timeout_${displayNum}`]) {
                    clearTimeout(editingTimeouts[`timeout_${displayNum}`]);
                }
                editingTimeouts[`timeout_${displayNum}`] = setTimeout(() => {
                    editingTimeouts[displayNum] = false;
                }, 5000);
            } else {
                editingTimeouts[displayNum] = false;
                if (editingTimeouts[`timeout_${displayNum}`]) {
                    clearTimeout(editingTimeouts[`timeout_${displayNum}`]);
                }
            }
        }

        // Check if any display is being edited
        function isAnyDisplayBeingEdited() {
            return isUserEditing || Object.keys(editingTimeouts).some(key => 
                !key.startsWith('timeout_') && editingTimeouts[key] === true
            );
        }

        // Add editing protection for inputs
        function addEditingProtectionToInputs() {
            for (let i = 1; i <= 3; i++) {
                const quantityInput = document.getElementById(`quantity-input-${i}`);
                if (quantityInput) {
                    quantityInput.addEventListener('focus', function() {
                        setEditingMode(i, true);
                    });
                    quantityInput.addEventListener('blur', function() {
                        setTimeout(() => {
                            setEditingMode(i, false);
                        }, 1000);
                    });
                    
                    // REMEMBER LAST USED QUANTITY when user changes it
                    quantityInput.addEventListener('change', function() {
                        const newQuantity = parseInt(this.value);
                        if (newQuantity && newQuantity > 0) {
                            lastUsedQuantities[i] = newQuantity;
                            lastUsedQuantities.bulk = newQuantity; // Also update bulk default
                            showSystemAlert(`‚úÖ Quantity ${newQuantity} saved for Display ${i} and bulk operations`, 'success');
                        }
                    });
                }
            }

            // Add editing protection for BOM radio buttons
            const bomRadios = document.querySelectorAll('input[name="bom-type-1"]');
            bomRadios.forEach(radio => {
                radio.addEventListener('focus', function() {
                    setEditingMode(1, true);
                });
                radio.addEventListener('change', function() {
                    setEditingMode(1, true);
                    setTimeout(() => {
                        setEditingMode(1, false);
                    }, 2000);
                });
            });
        }

        // Process navigation functions
        async function previousProcess(displayNum) {
            await sendClickerAction('backward', displayNum);
        }

        async function nextProcess(displayNum) {
            await sendClickerAction('forward', displayNum);
        }

        async function toggleLoopMode(displayNum) {
            await sendClickerAction('toggle_loop', displayNum);
        }

        // Send clicker actions
        async function sendClickerAction(action, displayNum) {
            try {
                const actionBtns = document.querySelectorAll(`button[onclick*="${action}(${displayNum})"]`);
                actionBtns.forEach(btn => {
                    btn.style.opacity = '0.6';
                    btn.disabled = true;
                });

                const response = await fetch(`/station/${displayNum}/clicker/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSystemAlert(`Display ${displayNum}: ${action} successful`, 'success');
                    await refreshSingleDisplay(displayNum);
                } else {
                    showSystemAlert(`Display ${displayNum}: ${result.error || 'Action failed'}`, 'warning');
                }
            } catch (error) {
                showSystemAlert(`Display ${displayNum}: Error sending command`, 'danger');
            } finally {
                const actionBtns = document.querySelectorAll(`button[onclick*="${action}(${displayNum})"]`);
                actionBtns.forEach(btn => {
                    btn.style.opacity = '1';
                    btn.disabled = false;
                });
            }
        }

        // Update configuration for individual display with enhanced BOM support
        async function updateConfiguration(displayNum) {
            const stageId = document.getElementById(`stage-select-${displayNum}`).value;
            const processId = document.getElementById(`process-select-${displayNum}`).value;
            const quantity = document.getElementById(`quantity-input-${displayNum}`).value;
            
            if (!stageId || !processId) {
                alert('Please select both stage and process');
                return;
            }
            
            // Get BOM settings
            let bomSettings = {};
            if (displayNum === 1) {
                const bomType = document.querySelector('input[name="bom-type-1"]:checked').value;
                switch(bomType) {
                    case 'single':
                        bomSettings = {
                            show_single_unit_bom: true,
                            show_batch_bom: false
                        };
                        break;
                    case 'batch':
                        bomSettings = {
                            show_single_unit_bom: false,
                            show_batch_bom: true
                        };
                        break;
                    case 'stage':
                        bomSettings = {
                            show_single_unit_bom: false,
                            show_batch_bom: false
                        };
                        break;
                }
            } else {
                // For displays 2 and 3, inherit BOM settings from Display 1
                const display1BomType = document.querySelector('input[name="bom-type-1"]:checked').value;
                switch(display1BomType) {
                    case 'single':
                        bomSettings = {
                            show_single_unit_bom: true,
                            show_batch_bom: false
                        };
                        break;
                    case 'batch':
                        bomSettings = {
                            show_single_unit_bom: false,
                            show_batch_bom: true
                        };
                        break;
                    case 'stage':
                        bomSettings = {
                            show_single_unit_bom: false,
                            show_batch_bom: false
                        };
                        break;
                }
            }

            const config = {
                stage_id: stageId,
                process_id: processId,
                quantity: parseInt(quantity),
                ...bomSettings
            };

            const updateBtn = document.querySelector(`button[onclick="updateConfiguration(${displayNum})"]`);
            const originalText = updateBtn ? updateBtn.textContent : 'üíæ Update';

            try {
                if (updateBtn) {
                    updateBtn.textContent = '‚è≥ Updating...';
                    updateBtn.disabled = true;
                }

                const response = await fetch(`/station/${displayNum}/assembly/config/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                
                if (result.success) {
                    showSystemAlert(`Display ${displayNum} updated successfully with BOM settings`, 'success');
                    await refreshSingleDisplay(displayNum);
                } else {
                    showSystemAlert(`Display ${displayNum} update failed: ${result.error}`, 'danger');
                }
            } catch (error) {
                showSystemAlert(`Display ${displayNum}: Error updating configuration`, 'danger');
            } finally {
                if (updateBtn) {
                    updateBtn.textContent = originalText;
                    updateBtn.disabled = false;
                }
            }
        }

        // Refresh single display
        async function refreshSingleDisplay(displayNum) {
            try {
                const response = await fetch(`/station/${displayNum}/media/`);
                const data = await response.json();
                updateDisplayStatus(displayNum, data);
            } catch (error) {
                console.error(`Error refreshing display ${displayNum}:`, error);
            }
        }

        // Update loop status display
        function updateLoopStatus(isActive, displayNum) {
            const loopStatus = document.getElementById(`loop-status-${displayNum}`);
            const loopToggleBtn = document.getElementById(`loop-toggle-btn-${displayNum}`);
            
if (isActive) {
            loopStatus.textContent = 'üîÑ Loop: Active';
            loopStatus.className = 'loop-status loop-active';
            loopToggleBtn.classList.add('active');
            loopToggleBtn.textContent = 'Disable Loop';
        } else {
            loopStatus.textContent = 'üîÑ Loop: Inactive';
            loopStatus.className = 'loop-status loop-inactive';
            loopToggleBtn.classList.remove('active');
            loopToggleBtn.textContent = 'Enable Loop';
        }
    }

    // Refresh all displays
    function refreshAllDisplays() {
        loadStationData();
        loadAssemblyOptions();
        showSystemAlert('Refreshing all displays...', 'info');
    }

    // Test display
    function testDisplay(displayNum) {
        window.open(`/station/${displayNum}/slider/`, '_blank');
    }

    // Show system alerts with enhanced BOM information
    function showSystemAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '20px';
        alertDiv.style.right = '20px';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.maxWidth = '400px';
        alertDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        alertDiv.innerHTML = `
            <strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}
            <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">√ó</button>
        `;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv.parentElement) {
                alertDiv.remove();
            }
        }, 5000);
    }

    // Start periodic status updates
    function startStatusUpdates() {
        setInterval(async () => {
            await loadStationData();
        }, 3000);
        
        setInterval(async () => {
            await loadAssemblyOptions();
        }, 30000);
    }

    // NEW: BOM Split Testing Functions
    function testBomSplit() {
        showSystemAlert('Testing BOM split functionality across all displays...', 'info');
        
        // Open all three displays in new tabs for testing
        for (let i = 1; i <= 3; i++) {
            setTimeout(() => {
                window.open(`/station/${i}/slider/`, '_blank');
            }, i * 1000); // Stagger opening by 1 second each
        }
        
        setTimeout(() => {
            showSystemAlert('‚úÖ All displays opened for BOM split testing', 'success');
        }, 4000);
    }

    // NEW: Quick BOM Type Switch Functions
    function quickSwitchToSingleUnit() {
        selectBulkBomType('single_unit');
        showSystemAlert('Quick switch: Single Unit BOM selected for bulk operations', 'info');
    }

    function quickSwitchToBatch50() {
        selectBulkBomType('batch_50');
        showSystemAlert('Quick switch: 50 Units BOM selected for bulk operations', 'info');
    }

    function quickSwitchToStageSpecific() {
        selectBulkBomType('stage_specific');
        showSystemAlert('Quick switch: Stage-Specific BOM selected for bulk operations', 'info');
    }

    // NEW: BOM Information Display
    function showBomSplitInfo() {
        const infoMessage = `
            <strong>üìã BOM Split Information:</strong><br><br>
            <strong>Single Unit BOM & 50 Units BOM:</strong><br>
            ‚Ä¢ Items are automatically split across all 3 displays<br>
            ‚Ä¢ Display 1: First portion of items<br>
            ‚Ä¢ Display 2: Middle portion of items<br>
            ‚Ä¢ Display 3: Last portion of items<br><br>
            <strong>Stage-Specific BOMs:</strong><br>
            ‚Ä¢ Sub Assembly 1 BOM: Complete list only on Display 1<br>
            ‚Ä¢ Sub Assembly 2 BOM: Complete list only on Display 1<br>
            ‚Ä¢ Final Assembly BOM: Complete list only on Display 1<br><br>
            <strong>Benefits:</strong><br>
            ‚Ä¢ Better visibility across workstation<br>
            ‚Ä¢ Reduces eye strain and scrolling<br>
            ‚Ä¢ Each operator can focus on their section
        `;
        
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-info';
        alertDiv.style.position = 'fixed';
        alertDiv.style.top = '50%';
        alertDiv.style.left = '50%';
        alertDiv.style.transform = 'translate(-50%, -50%)';
        alertDiv.style.zIndex = '10000';
        alertDiv.style.maxWidth = '600px';
        alertDiv.style.maxHeight = '500px';
        alertDiv.style.overflow = 'auto';
        alertDiv.style.boxShadow = '0 8px 30px rgba(0,0,0,0.3)';
        alertDiv.innerHTML = `
            ${infoMessage}
            <button onclick="this.parentElement.remove()" style="float: right; background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 15px;">Close</button>
        `;
        
        document.body.appendChild(alertDiv);
    }

    // NEW: Bulk quantity update function
    function updateBulkQuantity() {
        const quantity = prompt('Enter quantity for bulk operations:', lastUsedQuantities.bulk);
        if (quantity && !isNaN(quantity) && parseInt(quantity) > 0) {
            const newQuantity = parseInt(quantity);
            lastUsedQuantities.bulk = newQuantity;
            
            // Update all display quantities
            for (let i = 1; i <= 3; i++) {
                lastUsedQuantities[i] = newQuantity;
                document.getElementById(`quantity-input-${i}`).value = newQuantity;
            }
            
            showSystemAlert(`‚úÖ Bulk quantity updated to ${newQuantity} for all displays`, 'success');
        }
    }

    // NEW: Export current configuration
    function exportConfiguration() {
        const config = {
            timestamp: new Date().toISOString(),
            displays: {},
            bulkSettings: {
                bomType: selectedBulkBomType,
                stage: selectedBulkStage ? selectedBulkStage.id : null,
                process: selectedBulkProcess ? selectedBulkProcess.id : null,
                quantity: lastUsedQuantities.bulk
            }
        };

        for (let i = 1; i <= 3; i++) {
            config.displays[i] = {
                stage: document.getElementById(`stage-select-${i}`).value,
                process: document.getElementById(`process-select-${i}`).value,
                quantity: document.getElementById(`quantity-input-${i}`).value,
                bomType: i === 1 ? document.querySelector('input[name="bom-type-1"]:checked')?.value : 'inherited'
            };
        }

        const dataStr = JSON.stringify(config, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `brg_assembly_config_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        URL.revokeObjectURL(url);
        showSystemAlert('‚úÖ Configuration exported successfully', 'success');
    }

    // NEW: Import configuration
    function importConfiguration() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const config = JSON.parse(e.target.result);
                        loadConfigurationFromData(config);
                        showSystemAlert('‚úÖ Configuration imported successfully', 'success');
                    } catch (error) {
                        showSystemAlert('‚ùå Error importing configuration: Invalid file format', 'danger');
                    }
                };
                reader.readAsText(file);
            }
        };
        input.click();
    }

    // NEW: Load configuration from imported data
    function loadConfigurationFromData(config) {
        // Load bulk settings
        if (config.bulkSettings) {
            if (config.bulkSettings.bomType) {
                selectBulkBomType(config.bulkSettings.bomType);
            }
            if (config.bulkSettings.quantity) {
                lastUsedQuantities.bulk = config.bulkSettings.quantity;
            }
        }

        // Load display settings
        if (config.displays) {
            for (let i = 1; i <= 3; i++) {
                const displayConfig = config.displays[i];
                if (displayConfig) {
                    if (displayConfig.stage) {
                        document.getElementById(`stage-select-${i}`).value = displayConfig.stage;
                        handleStageChange(i);
                    }
                    setTimeout(() => {
                        if (displayConfig.process) {
                            document.getElementById(`process-select-${i}`).value = displayConfig.process;
                        }
                        if (displayConfig.quantity) {
                            document.getElementById(`quantity-input-${i}`).value = displayConfig.quantity;
                            lastUsedQuantities[i] = parseInt(displayConfig.quantity);
                        }
                        if (i === 1 && displayConfig.bomType && displayConfig.bomType !== 'inherited') {
                            selectBomType(1, displayConfig.bomType);
                        }
                    }, 500);
                }
            }
        }
    }

    // NEW: Reset to default configuration
    function resetToDefaults() {
        if (confirm('Are you sure you want to reset all settings to defaults?')) {
            // Reset bulk settings
            selectBulkBomType('batch_50');
            lastUsedQuantities = {
                1: 50,
                2: 50,
                3: 50,
                bulk: 50
            };

            // Reset display settings
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`stage-select-${i}`).value = '';
                document.getElementById(`process-select-${i}`).innerHTML = '<option value="">Select stage first</option>';
                document.getElementById(`quantity-input-${i}`).value = 50;
            }

            // Reset Display 1 BOM type
            document.querySelector('input[name="bom-type-1"][value="batch"]').checked = true;
            selectBomType(1, 'batch');

            // Clear bulk stage selection
            document.querySelectorAll('.stage-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('process-selection').style.display = 'none';
            selectedBulkStage = null;
            selectedBulkProcess = null;

            showSystemAlert('‚úÖ All settings reset to defaults', 'success');
        }
    }

    // NEW: Advanced debugging function
    function debugBomSplit() {
        console.log('=== BOM Split Debug Information ===');
        console.log('Selected Bulk BOM Type:', selectedBulkBomType);
        console.log('Last Used Quantities:', lastUsedQuantities);
        
        for (let i = 1; i <= 3; i++) {
            console.log(`Display ${i} Configuration:`, {
                stage: document.getElementById(`stage-select-${i}`).value,
                process: document.getElementById(`process-select-${i}`).value,
                quantity: document.getElementById(`quantity-input-${i}`).value,
                bomType: i === 1 ? document.querySelector('input[name="bom-type-1"]:checked')?.value : 'inherited'
            });
        }
        
        showSystemAlert('üîß Debug information logged to console', 'info');
    }

    // NEW: Quick action buttons setup
    function setupQuickActions() {
        // Add quick action buttons to the page
        const quickActionsHtml = `
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <h4 style="margin-bottom: 15px; color: #2c3e50;">üöÄ Quick Actions</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="testBomSplit()">üß™ Test BOM Split</button>
                    <button class="btn btn-info" onclick="showBomSplitInfo()">‚ÑπÔ∏è BOM Info</button>
                    <button class="btn btn-warning" onclick="updateBulkQuantity()">üìù Bulk Quantity</button>
                    <button class="btn btn-success" onclick="exportConfiguration()">üíæ Export Config</button>
                    <button class="btn btn-primary" onclick="importConfiguration()">üìÅ Import Config</button>
                    <button class="btn btn-danger" onclick="resetToDefaults()">üîÑ Reset Defaults</button>
                    <button class="btn btn-secondary" onclick="debugBomSplit()">üîß Debug</button>
                </div>
            </div>
        `;
        
        // Add to the page after the bulk controls
        const bulkControls = document.querySelector('.bulk-controls');
        if (bulkControls) {
            bulkControls.insertAdjacentHTML('afterend', quickActionsHtml);
        }
    }

    // Initialize quick actions when page loads
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(setupQuickActions, 1000); // Add after other initialization
    });

    // NEW: Keyboard shortcuts
    document.addEventListener('keydown', function(event) {
        // Ctrl + 1, 2, 3 to focus on displays
        if (event.ctrlKey && event.key >= '1' && event.key <= '3') {
            const displayNum = parseInt(event.key);
            document.getElementById(`stage-select-${displayNum}`).focus();
            showSystemAlert(`Focused on Display ${displayNum}`, 'info');
            event.preventDefault();
        }
        
        // Ctrl + B for BOM info
        if (event.ctrlKey && event.key === 'b') {
            showBomSplitInfo();
            event.preventDefault();
        }
        
        // Ctrl + T for test all displays
        if (event.ctrlKey && event.key === 't') {
            testBomSplit();
            event.preventDefault();
        }
        
        // Ctrl + R for refresh all
        if (event.ctrlKey && event.key === 'r') {
            refreshAllDisplays();
            event.preventDefault();
        }
        
        // Escape to close any open modals
        if (event.key === 'Escape') {
            document.querySelectorAll('.alert').forEach(alert => {
                if (alert.style.position === 'fixed') {
                    alert.remove();
                }
            });
        }
    });

    // NEW: Auto-save functionality
    function autoSaveConfiguration() {
        const config = {
            timestamp: new Date().toISOString(),
            displays: {},
            bulkSettings: {
                bomType: selectedBulkBomType,
                quantity: lastUsedQuantities.bulk
            }
        };

        for (let i = 1; i <= 3; i++) {
            config.displays[i] = {
                stage: document.getElementById(`stage-select-${i}`).value,
                process: document.getElementById(`process-select-${i}`).value,
                quantity: document.getElementById(`quantity-input-${i}`).value,
                bomType: i === 1 ? document.querySelector('input[name="bom-type-1"]:checked')?.value : 'inherited'
            };
        }

        localStorage.setItem('brg_supervisor_config', JSON.stringify(config));
    }

    // NEW: Auto-load saved configuration
    function autoLoadConfiguration() {
        try {
            const savedConfig = localStorage.getItem('brg_supervisor_config');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                // Only auto-load if it's recent (within last 24 hours)
                const saveTime = new Date(config.timestamp);
                const now = new Date();
                const hoursDiff = (now - saveTime) / (1000 * 60 * 60);
                
                if (hoursDiff < 24) {
                    setTimeout(() => {
                        loadConfigurationFromData(config);
                        showSystemAlert('‚úÖ Auto-loaded saved configuration', 'info');
                    }, 2000);
                }
            }
        } catch (error) {
            console.log('No valid saved configuration found');
        }
    }

    // Start auto-save every 30 seconds
    setInterval(autoSaveConfiguration, 30000);

    // Auto-load on page load
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(autoLoadConfiguration, 3000);
    });

    // NEW: Status indicator for BOM split
    function updateBomSplitStatus() {
        const statusHtml = `
            <div style="position: fixed; bottom: 20px; left: 20px; background: rgba(0,0,0,0.8); color: white; padding: 10px 15px; border-radius: 20px; font-size: 12px; z-index: 1000;">
                BOM: ${selectedBulkBomType.replace('_', ' ').toUpperCase()} | 
                Auto-save: Active | 
                Keyboard shortcuts: Ctrl+B (info), Ctrl+T (test)
            </div>
        `;
        
        // Remove existing status
        const existingStatus = document.getElementById('bom-split-status');
        if (existingStatus) {
            existingStatus.remove();
        }
        
        // Add new status
        const statusDiv = document.createElement('div');
        statusDiv.id = 'bom-split-status';
        statusDiv.innerHTML = statusHtml;
        document.body.appendChild(statusDiv);
    }

    // Update status every 5 seconds
    setInterval(updateBomSplitStatus, 5000);

    // Show initial status
    setTimeout(updateBomSplitStatus, 2000);
    
    </script>
</body>
</html>