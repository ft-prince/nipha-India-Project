{% load static %}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Management - BRG Assembly System</title>
        <meta name="csrf-token" content="{{ csrf_token }}">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .product-selector {
            background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
            padding: 30px;
            border-bottom: 3px solid #3498db;
        }

        .product-selector h2 {
            color: #1976d2;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .product-select-wrapper {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 20px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .form-control {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1.1em;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .content-area {
            display: none;
            padding: 30px;
        }

        .content-area.active {
            display: block;
        }

        .product-overview {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #6c757d;
        }

        .product-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .info-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .info-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            white-space: nowrap;
            min-width: 150px;
        }

        .tab.active {
            background: #3498db;
            color: white;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .tab:hover:not(.active) {
            background: #e9ecef;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .section-header h3 {
            color: #2c3e50;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* BOM Items Table */
        .data-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .table-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            padding: 10px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            width: 300px;
        }

        .search-input:focus {
            border-color: #3498db;
            outline: none;
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .item-photo {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 6px;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-header h3 {
            color: #2c3e50;
            font-size: 1.5em;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .file-upload {
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9fa;
        }

        .file-upload:hover {
            background: #e3f2fd;
            border-color: #2980b9;
        }

        .file-upload.dragover {
            background: #e3f2fd;
            border-color: #2980b9;
        }

        .upload-icon {
            font-size: 3em;
            color: #3498db;
            margin-bottom: 15px;
        }

        /* Station Cards */
        .station-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .station-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-top: 4px solid;
            transition: transform 0.3s ease;
        }

        .station-card:hover {
            transform: translateY(-3px);
        }

        .station-card.display-1 { border-top-color: #FF6B6B; }
        .station-card.display-2 { border-top-color: #4ECDC4; }
        .station-card.display-3 { border-top-color: #45B7D1; }

        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .station-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
        }

        .display-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }

        .display-1 .display-badge { background: #FF6B6B; }
        .display-2 .display-badge { background: #4ECDC4; }
        .display-3 .display-badge { background: #45B7D1; }

        .station-info {
            margin-bottom: 20px;
        }

        .station-info p {
            color: #666;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .station-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Alert Messages */
        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #b8daff;
            color: #0c5460;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .product-select-wrapper {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: center;
            }
            
            .station-grid {
                grid-template-columns: 1fr;
            }
            
            .search-input {
                width: 100%;
            }
            
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .actions {
                justify-content: center;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-3 { margin-top: 1rem; }
        .mb-3 { margin-bottom: 1rem; }
        .ml-2 { margin-left: 0.5rem; }
        .mr-2 { margin-right: 0.5rem; }
        .d-flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .gap-2 { gap: 0.5rem; }
        .w-100 { width: 100%; }
    </style>
 
    <style>
/* Media Management Specific Styles */
.display-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
    color: white;
    margin: 2px;
    display: inline-block;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: all 0.3s;
}

.checkbox-label:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
}

.checkbox-label input[type="checkbox"] {
    margin: 0;
}

.media-select {
    transform: scale(1.2);
    margin: 0;
}

.file-upload {
    border: 2px dashed #007bff;
    border-radius: 10px;
    padding: 30px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8f9fa;
    margin-bottom: 15px;
}

.file-upload:hover {
    background: #e3f2fd;
    border-color: #0056b3;
}

.file-upload.dragover {
    background: #e3f2fd;
    border-color: #0056b3;
}

.upload-icon {
    font-size: 2.5em;
    color: #007bff;
    margin-bottom: 10px;
}

.badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: bold;
    color: white;
}

/* Media table improvements */
#media-files-table th {
    background: #f8f9fa;
    position: sticky;
    top: 0;
    z-index: 10;
}

#media-files-table td {
    vertical-align: middle;
}

.table-container {
    max-height: 600px;
    overflow-y: auto;
}

/* Media preview styles */
#media-preview-content img,
#media-preview-content video {
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

#media-preview-content iframe {
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

/* File size and type indicators */
.file-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

.file-type-icon {
    width: 40px;
    height: 40px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: white;
    cursor: pointer;
    transition: transform 0.2s;
}

.file-type-icon:hover {
    transform: scale(1.1);
}

/* Media type specific colors */
.media-type-BOM { background: #28a745; }
.media-type-PROCESS_DOC { background: #007bff; }
.media-type-VIDEO { background: #dc3545; }
.media-type-INSTRUCTION { background: #ffc107; color: #000; }

/* Responsive design for media management */
@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .checkbox-label {
        flex-direction: column;
        text-align: center;
        padding: 12px;
    }
    
    .table-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .search-box {
        flex-direction: column;
        gap: 10px;
    }
    
    .search-input {
        width: 100%;
    }
}

/* Drag and drop enhancements */
.file-upload.dragover::before {
    content: "Drop file here";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.2em;
    font-weight: bold;
    color: #007bff;
}

/* Loading states */
.media-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
    background: #f8f9fa;
    border-radius: 10px;
    margin: 20px 0;
}

.media-loading .spinner {
    width: 30px;
    height: 30px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 15px;
}

/* Error states */
.media-error {
    background: #f8d7da;
    color: #721c24;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    text-align: center;
}

/* Success states */
.media-success {
    background: #d4edda;
    color: #155724;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    text-align: center;
}

/* Media statistics cards */
.media-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    text-align: center;
    border-top: 4px solid;
}

.stat-card.total { border-top-color: #007bff; }
.stat-card.videos { border-top-color: #dc3545; }
.stat-card.documents { border-top-color: #28a745; }
.stat-card.images { border-top-color: #ffc107; }

.stat-card h3 {
    color: #2c3e50;
    margin-bottom: 10px;
    font-size: 1.2em;
}

.stat-card .value {
    font-size: 2.5em;
    font-weight: bold;
    color: #3498db;
    margin-bottom: 5px;
}

.stat-card .label {
    color: #666;
    font-size: 0.9em;
}
</style>
</head>
<body>

        {% csrf_token %}

    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1>üè≠ Product Management System</h1>
            <p>BRG Assembly Management - Comprehensive Product Control</p>
        </div>

        <!-- Product Selector -->
        <div class="product-selector">
            <h2>üéØ Select Product</h2>
            <div class="product-select-wrapper">
                <div class="form-group">
                    <label for="product-select">Choose Product:</label>
                    <select class="form-control" id="product-select">
                        <option value="">Loading products...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quantity-input">Quantity:</label>
                    <input type="number" class="form-control" id="quantity-input" value="50" min="1" max="1000">
                </div>
                <div class="form-group">
                    <button class="btn btn-primary" id="load-product-btn" onclick="loadProductData()">
                        üîç Load Product Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content-area" id="content-area">
            <!-- Product Overview -->
            <div class="product-overview">
                <h2 id="product-title">Product Overview</h2>
                <div class="product-info">
                    <div class="info-card">
                        <h3>BOM Templates</h3>
                        <div class="value" id="bom-templates-count">0</div>
                    </div>
                    <div class="info-card">
                        <h3>BOM Items</h3>
                        <div class="value" id="bom-items-count">0</div>
                    </div>
                    <div class="info-card">
                        <h3>Assigned Stations</h3>
                        <div class="value" id="stations-count">0</div>
                    </div>
                    <div class="info-card">
                        <h3>Media Files</h3>
                        <div class="value" id="media-count">0</div>
                    </div>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <div class="tabs">
                <button class="tab active" onclick="showTab('bom-items')">üìã BOM Items</button>
                <button class="tab" onclick="showTab('bom-templates')">üìä BOM Templates</button>
                <button class="tab" onclick="showTab('stations')">üñ•Ô∏è Stations</button>
                <button class="tab" onclick="showTab('media')">üìÅ Media Files</button>
                <button class="tab" onclick="showTab('upload')">‚¨ÜÔ∏è Upload BOM</button>
            </div>

            <!-- BOM Items Tab -->
            <div class="tab-content active" id="bom-items-tab">
                <div class="section-header">
                    <h3>üìã BOM Items Management</h3>
                    <div class="actions">
                        <button class="btn btn-success" onclick="showAddItemModal()">‚ûï Add Item</button>
                        <button class="btn btn-warning" onclick="refreshBOMItems()">üîÑ Refresh</button>
                    </div>
                </div>
                
                <div class="data-table">
                    <div class="table-header">
                        <div class="search-box">
                            <input type="text" class="search-input" id="bom-search" placeholder="Search BOM items..." onkeyup="searchBOMItems()">
                            <select class="form-control" id="unit-filter" onchange="filterBOMItems()">
                                <option value="">All Units</option>
                            </select>
                        </div>
                        <div class="actions">
                            <span id="items-count">Loading...</span>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="bom-items-table">
                            <thead>
                                <tr>
                                    <th>Photo</th>
                                    <th>Item Code</th>
                                    <th>Description</th>
                                    <th>Part Number</th>
                                    <th>Unit</th>
                                    <th>Cost</th>
                                    <th>Supplier</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bom-items-tbody">
                                <tr>
                                    <td colspan="9" class="loading">
                                        <div class="spinner"></div>
                                        Loading BOM items...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- BOM Templates Tab -->
            <div class="tab-content" id="bom-templates-tab">
                <div class="section-header">
                    <h3>üìä BOM Templates</h3>
                    <div class="actions">
                        <button class="btn btn-success" onclick="showAddTemplateModal()">‚ûï Create Template</button>
                        <button class="btn btn-primary" onclick="refreshBOMTemplates()">üîÑ Refresh</button>
                    </div>
                </div>
                
                <div id="bom-templates-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading BOM templates...
                    </div>
                </div>
            </div>

            <!-- Stations Tab -->
            <div class="tab-content" id="stations-tab">
                <div class="section-header">
                    <h3>üñ•Ô∏è Station Management</h3>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="refreshStations()">üîÑ Refresh</button>
                        <button class="btn btn-success" onclick="syncAllStations()">üîÑ Sync All</button>
                    </div>
                </div>
                
                <div class="station-grid" id="stations-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading stations...
                    </div>
                </div>
            </div>

            <!-- Media Files Tab -->
            <div class="tab-content" id="media-tab">
                <div class="section-header">
                    <h3>üìÅ Media Files</h3>
                    <div class="actions">
                        <button class="btn btn-success" onclick="showAddMediaModal()">‚ûï Add Media</button>
                        <button class="btn btn-primary" onclick="refreshMedia()">üîÑ Refresh</button>
                    </div>
                </div>
                
                <div id="media-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading media files...
                    </div>
                </div>
            </div>

            <!-- Upload BOM Tab -->
            
            <div class="tab-content" id="upload-tab">
                <button onclick="testExcelEndpoint()" class="btn btn-info">Test Excel Endpoint</button>
                <div class="section-header">
                    <h3>‚¨ÜÔ∏è Upload BOM from Excel</h3>
                </div>
                
                <div class="data-table">
                    <div style="padding: 30px;">
                        {% csrf_token %}
                        <form id="excel-upload-form" enctype="multipart/form-data">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="excel-file">Excel File:</label>
                                    <div class="file-upload" onclick="document.getElementById('excel-file').click()">
                                        <div class="upload-icon">üìÑ</div>
                                        <p><strong>Click to select Excel file</strong></p>
                                        <p>Or drag and drop here</p>
                                        <small>Supports .xlsx and .xls files</small>
                                    </div>
                                    <input type="file" id="excel-file" accept=".xlsx,.xls" style="display: none;" onchange="handleFileSelect(this)">
                                </div>
                                
                                <div class="form-group">
                                    <label for="default-unit">Default Unit of Measure:</label>
                                    <input type="text" class="form-control" id="default-unit" value="NO." placeholder="e.g., NO., KGS, GM">
                                </div>
                                
                                <div class="form-group">
                                    <label for="default-supplier">Default Supplier (Optional):</label>
                                    <input type="text" class="form-control" id="default-supplier" placeholder="Supplier name">
                                </div>
                                
                                <div class="form-group">
                                    <label>
                                        <input type="checkbox" id="overwrite-existing"> 
                                        Overwrite existing items
                                    </label>
                                </div>
                            </div>
                            
                            <div class="actions text-center mt-3">
                                <button type="button" class="btn btn-success" onclick="uploadExcelFile()">
                                    ‚¨ÜÔ∏è Upload and Process
                                </button>
                                <button type="button" class="btn btn-warning" onclick="clearUploadForm()">
                                    üóëÔ∏è Clear Form
                                </button>
                            </div>
                        </form>
                        
                        <div class="alert alert-info mt-3">
                            <strong>üìã Excel Format Requirements:</strong><br>
                            Required columns: S. NO, ITEM DESCRIPTION, PART NO., QTY, ITEM PHOTO<br>
                            The system will automatically extract images from Excel cells and create BOM items.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<div class="modal" id="media-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="media-modal-title">Add Media File</h3>
            <button class="close-btn" onclick="closeModal('media-modal')">&times;</button>
        </div>
        <form id="media-form" onsubmit="handleMediaSubmit(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label for="media-file">Media File:</label>
                    <div class="file-upload" onclick="document.getElementById('media-file').click()">
                        <div class="upload-icon">üìé</div>
                        <p><strong>Click to select media file</strong></p>
                        <p>Or drag and drop here</p>
                        <small>Supports: PDF, MP4, MOV, AVI, XLSX, DOCX, JPG, PNG</small>
                    </div>
                    <input type="file" id="media-file" style="display: none;" 
                           accept=".pdf,.mp4,.mov,.avi,.xlsx,.docx,.jpg,.jpeg,.png,.gif"
                           onchange="handleMediaFileSelect(this)">
                    <div id="media-file-preview" style="margin-top: 10px;"></div>
                </div>
                
                <div class="form-group">
                    <label for="media-type">Media Type:</label>
                    <select class="form-control" id="media-type" required>
                        <option value="PROCESS_DOC">Process Document</option>
                        <option value="VIDEO">Video</option>
                        <option value="INSTRUCTION">Instruction Manual</option>
                        <option value="BOM">Bill of Material</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="media-duration">Duration (seconds):</label>
                    <input type="number" class="form-control" id="media-duration" 
                           value="15" min="1" max="300" required>
                    <small>How long to display this media in the slider</small>
                </div>
                
                <div class="form-group">
                    <label for="media-process">Process Association (Optional):</label>
                    <select class="form-control" id="media-process">
                        <option value="">No Process Association</option>
                    </select>
                    <small>Link this media to a specific assembly process</small>
                </div>
            </div>
            
            <div class="form-group">
                <label>Display Screen Assignment:</label>
                <div class="d-flex gap-3" style="margin-top: 8px;">
                    <label class="checkbox-label">
                        <input type="checkbox" id="media-display-1"> 
                        <span class="display-badge" style="background: #FF6B6B;">Display 1</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="media-display-2"> 
                        <span class="display-badge" style="background: #4ECDC4;">Display 2</span>
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="media-display-3"> 
                        <span class="display-badge" style="background: #45B7D1;">Display 3</span>
                    </label>
                </div>
                <small>Select which display screens should show this media</small>
            </div>
            
            <div class="actions text-center mt-3">
                <button type="submit" class="btn btn-success">üíæ Save Media File</button>
                <button type="button" class="btn btn-warning" onclick="closeModal('media-modal')">‚ùå Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Media Preview Modal -->
<div class="modal" id="media-preview-modal">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h3 id="media-preview-title">Media Preview</h3>
            <button class="close-btn" onclick="closeModal('media-preview-modal')">&times;</button>
        </div>
        <div id="media-preview-content">
            <div class="loading">
                <div class="spinner"></div>
                Loading media preview...
            </div>
        </div>
    </div>
</div>



    <!-- Add/Edit BOM Item Modal -->
    <div class="modal" id="item-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="item-modal-title">Add BOM Item</h3>
                <button class="close-btn" onclick="closeModal('item-modal')">&times;</button>
            </div>
            <form id="item-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="item-code">Item Code:</label>
                        <input type="text" class="form-control" id="item-code" required>
                    </div>
                    <div class="form-group">
                        <label for="item-description">Description:</label>
                        <input type="text" class="form-control" id="item-description" required>
                    </div>
                    <div class="form-group">
                        <label for="part-number">Part Number:</label>
                        <input type="text" class="form-control" id="part-number" required>
                    </div>
                    <div class="form-group">
                        <label for="unit-measure">Unit of Measure:</label>
                        <input type="text" class="form-control" id="unit-measure" value="NO.">
                    </div>
                    <div class="form-group">
                        <label for="cost-per-unit">Cost per Unit:</label>
                        <input type="number" class="form-control" id="cost-per-unit" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="supplier">Supplier:</label>
                        <input type="text" class="form-control" id="supplier">
                    </div>
                </div>
                <div class="form-group">
                    <label for="item-photo">Item Photo:</label>
                    <input type="file" class="form-control" id="item-photo" accept="image/*">
                    <div id="item-photo-preview" style="margin-top: 10px;"></div>

                </div>
                <div class="actions text-center mt-3">
                    <button type="submit" class="btn btn-success">üíæ Save Item</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('item-modal')">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit BOM Template Modal -->
    <div class="modal" id="template-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="template-modal-title">Create BOM Template</h3>
                <button class="close-btn" onclick="closeModal('template-modal')">&times;</button>
            </div>
            <form id="template-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="template-name">Template Name:</label>
                        <input type="text" class="form-control" id="template-name" required>
                    </div>
                    <div class="form-group">
                        <label for="bom-type">BOM Type:</label>
                        <select class="form-control" id="bom-type" required>
                            <option value="">Select Type</option>
                            <option value="SINGLE_UNIT">Single Unit</option>
                            <option value="BATCH_50">Batch 50</option>
                            <option value="STAGE_BOM">Stage BOM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="template-stage">Assembly Stage:</label>
                        <select class="form-control" id="template-stage">
                            <option value="">Select Stage</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="template-description">Description:</label>
                    <textarea class="form-control" id="template-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Display Assignments:</label>
                    <div class="d-flex gap-2">
                        <label><input type="checkbox" id="display-1"> Display 1</label>
                        <label><input type="checkbox" id="display-2"> Display 2</label>
                        <label><input type="checkbox" id="display-3"> Display 3</label>
                    </div>
                </div>
                <div class="actions text-center mt-3">
                    <button type="submit" class="btn btn-success">üíæ Save Template</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('template-modal')">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Station Configuration Modal -->
    <div class="modal" id="station-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="station-modal-title">Configure Station</h3>
                <button class="close-btn" onclick="closeModal('station-modal')">&times;</button>
            </div>
            <form id="station-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="station-stage">Assembly Stage:</label>
                        <select class="form-control" id="station-stage" onchange="updateStationProcesses()">
                            <option value="">Select Stage</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="station-process">Assembly Process:</label>
                        <select class="form-control" id="station-process">
                            <option value="">Select Process</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="station-quantity">Product Quantity:</label>
                        <input type="number" class="form-control" id="station-quantity" value="50" min="1">
                    </div>
                </div>
                <div class="form-group">
                    <label>BOM Display Settings:</label>
                    <div class="d-flex gap-2">
                        <label><input type="checkbox" id="show-single-unit"> Single Unit BOM</label>
                        <label><input type="checkbox" id="show-batch"> Batch BOM</label>
                    </div>
                </div>
                <div class="actions text-center mt-3">
                    <button type="submit" class="btn btn-success">üíæ Update Station</button>
                    <button type="button" class="btn btn-warning" onclick="closeModal('station-modal')">‚ùå Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- BOM Preview Modal -->
    <div class="modal" id="bom-preview-modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h3 id="bom-preview-title">BOM Preview</h3>
                <button class="close-btn" onclick="closeModal('bom-preview-modal')">&times;</button>
            </div>
            <div id="bom-preview-content">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading BOM preview...
                </div>
            </div>
        </div>
    </div>

<script>
  // Complete Fixed JavaScript with comprehensive error handling and all functions

// Enhanced CSRF token handling
function getCsrfToken() {
    // Method 1: From meta tag
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken) {
        return metaToken.getAttribute('content');
    }
    
    // Method 2: From hidden input
    const csrfInput = document.querySelector('[name="csrfmiddlewaretoken"]');
    if (csrfInput) {
        return csrfInput.value;
    }
    
    // Method 3: From cookie
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    
    console.warn('CSRF token not found');
    return '';
}

// Enhanced fetch wrapper with proper error handling
async function makeAPICall(url, options = {}) {
    try {
        // Set default headers
        const defaultHeaders = {};
        
        // Only set Content-Type for JSON requests
        if (options.body && typeof options.body === 'string') {
            defaultHeaders['Content-Type'] = 'application/json';
        }
        
        // Add CSRF token for non-GET requests
        if (options.method && options.method !== 'GET') {
            const csrfToken = getCsrfToken();
            if (csrfToken) {
                defaultHeaders['X-CSRFToken'] = csrfToken;
            }
        }
        
        // Merge headers
        options.headers = {
            ...defaultHeaders,
            ...options.headers
        };
        
        console.log(`Making API call to: ${url}`, {
            method: options.method || 'GET',
            headers: options.headers
        });
        
        const response = await fetch(url, options);
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const textResponse = await response.text();
            console.error('Non-JSON response received:', textResponse.substring(0, 500));
            throw new Error(`Expected JSON response but received ${contentType || 'unknown'}. Check server logs for details.`);
        }
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        if (data.success === false) {
            throw new Error(data.error || 'API returned success: false');
        }
        
        return data;
        
    } catch (error) {
        console.error('API call failed:', error);
        throw error;
    }
}

// Utility functions
function showLoadingState(elementId, message = 'Loading...') {
    const element = document.getElementById(elementId);
    if (element) {
        if (element.tagName === 'SELECT') {
            element.innerHTML = `<option value="">${message}</option>`;
        } else {
            element.innerHTML = `<div class="loading"><div class="spinner"></div>${message}</div>`;
        }
    }
}

function showAlert(message, type = 'info') {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert-notification');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-notification`;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '10000';
    alertDiv.style.maxWidth = '400px';
    alertDiv.style.boxShadow = '0 8px 25px rgba(0,0,0,0.2)';
    alertDiv.style.borderRadius = '10px';
    alertDiv.style.padding = '15px';
    alertDiv.style.transition = 'all 0.3s ease';
    
    const icons = {
        success: '‚úÖ',
        danger: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
    };
    
    alertDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 1.2em;">${icons[type] || icons.info}</span>
            <span style="flex: 1;">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="background: none; border: none; font-size: 18px; cursor: pointer; 
                           opacity: 0.7; padding: 0; width: 24px; height: 24px; 
                           display: flex; align-items: center; justify-content: center;">√ó</button>
        </div>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.style.transform = 'translateX(100%)';
            alertDiv.style.opacity = '0';
            setTimeout(() => alertDiv.remove(), 300);
        }
    }, 5000);
    
    // Animate in
    alertDiv.style.transform = 'translateX(100%)';
    setTimeout(() => {
        alertDiv.style.transform = 'translateX(0)';
    }, 10);
}

// Global variables
let currentProduct = null;
let currentQuantity = 50;
let allBOMItems = [];
let filteredBOMItems = [];
let allStages = [];
let currentEditingItem = null;
let currentEditingStation = null;

// Initialize application
document.addEventListener('DOMContentLoaded', function() {
    loadProducts();
    setupEventListeners();
    setupAutoSave();
});

// Setup event listeners
function setupEventListeners() {
    // File upload drag and drop
    const fileUpload = document.querySelector('.file-upload');
    if (fileUpload) {
        fileUpload.addEventListener('dragover', handleDragOver);
        fileUpload.addEventListener('dragleave', handleDragLeave);
        fileUpload.addEventListener('drop', handleDrop);
    }

    // Form submissions
    const itemForm = document.getElementById('item-form');
    if (itemForm) {
        itemForm.addEventListener('submit', handleItemSubmit);
    }

    const templateForm = document.getElementById('template-form');
    if (templateForm) {
        templateForm.addEventListener('submit', handleTemplateSubmit);
    }

    const stationForm = document.getElementById('station-form');
    if (stationForm) {
        stationForm.addEventListener('submit', handleStationSubmit);
    }

    // Modal close on outside click
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal(modal.id);
            }
        });
    });

    // Search debouncing
    const searchInput = document.getElementById('bom-search');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(searchBOMItems, 300);
        });
    }
}

// Auto-save functionality
function setupAutoSave() {
    // Save user preferences
    window.addEventListener('beforeunload', saveUserPreferences);
    
    // Auto-save on form changes
    document.addEventListener('change', function(e) {
        if (e.target.matches('#product-select, #quantity-input')) {
            saveUserPreferences();
        }
    });
}

// Load products from API
async function loadProducts() {
    try {
        showLoadingState('product-select', 'Loading products...');
        
        const data = await makeAPICall('/station/1/assembly/options/');
        
        const productSelect = document.getElementById('product-select');
        productSelect.innerHTML = '<option value="">Select a product...</option>';
        
        if (data.products && data.products.length > 0) {
            data.products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.code} - ${product.name}`;
                productSelect.appendChild(option);
            });
        } else {
            productSelect.innerHTML = '<option value="">No products available</option>';
        }

        // Store stages for later use
        allStages = data.stages || [];
        
        // Load user preferences
        loadUserPreferences();
        
    } catch (error) {
        console.error('Error loading products:', error);
        showAlert(`Error loading products: ${error.message}`, 'danger');
        
        const productSelect = document.getElementById('product-select');
        productSelect.innerHTML = '<option value="">Error loading products</option>';
    }
}

// Load product data when selected
async function loadProductData() {
    const productSelect = document.getElementById('product-select');
    const quantityInput = document.getElementById('quantity-input');
    const loadBtn = document.getElementById('load-product-btn');
    
    if (!productSelect.value) {
        showAlert('Please select a product first', 'warning');
        return;
    }

    try {
        loadBtn.disabled = true;
        loadBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; margin-right: 8px;"></div>Loading...';

        currentProduct = {
            id: parseInt(productSelect.value),
            name: productSelect.options[productSelect.selectedIndex].textContent
        };
        currentQuantity = parseInt(quantityInput.value) || 50;

        // Show content area
        const contentArea = document.getElementById('content-area');
        if (contentArea) {
            contentArea.classList.add('active');
        }
        
        const productTitle = document.getElementById('product-title');
        if (productTitle) {
            productTitle.textContent = `${currentProduct.name} - Quantity: ${currentQuantity}`;
        }

        // Load all data for the selected product
        await Promise.all([
            loadBOMItems(),
            loadBOMTemplates(),
            loadStations(),
            loadMedia(),
            updateProductOverview()
        ]);

        showAlert(`Product ${currentProduct.name} loaded successfully`, 'success');

    } catch (error) {
        console.error('Error loading product data:', error);
        showAlert(`Error loading product data: ${error.message}`, 'danger');
    } finally {
        loadBtn.disabled = false;
        loadBtn.innerHTML = 'üîç Load Product Data';
    }
}

// Load BOM items for current product
async function loadBOMItems() {
    try {
        const data = await makeAPICall('/station/api/bom-items/');
        
        allBOMItems = data.items || [];
        filteredBOMItems = [...allBOMItems];
        
        renderBOMItems();
        updateBOMFilters();
        
        const bomItemsCount = document.getElementById('bom-items-count');
        if (bomItemsCount) {
            bomItemsCount.textContent = allBOMItems.length;
        }
        
    } catch (error) {
        console.error('Error loading BOM items:', error);
        const tbody = document.getElementById('bom-items-tbody');
        if (tbody) {
            tbody.innerHTML = `
                <tr><td colspan="9" class="text-center" style="color: #e74c3c;">
                    <strong>Error loading BOM items</strong><br>
                    <small>${error.message}</small>
                </td></tr>
            `;
        }
        showAlert(`Error loading BOM items: ${error.message}`, 'danger');
    }
}

// Render BOM items table
function renderBOMItems() {
    const tbody = document.getElementById('bom-items-tbody');
    const itemsCount = document.getElementById('items-count');
    
    if (!tbody) return;
    
    if (filteredBOMItems.length === 0) {
        tbody.innerHTML = `
            <tr><td colspan="9" class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <h3>No BOM items found</h3>
                <p>Add items using the "Add Item" button or upload from Excel</p>
            </td></tr>
        `;
        if (itemsCount) itemsCount.textContent = '0 items';
        return;
    }

    tbody.innerHTML = filteredBOMItems.map(item => `
        <tr>
            <td>
                ${item.item_photo_url ? 
                    `<img src="${item.item_photo_url}" alt="Item Photo" class="item-photo">` : 
                    '<div style="width: 40px; height: 40px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666;">No Image</div>'
                }
            </td>
            <td><strong>${escapeHtml(item.item_code)}</strong></td>
            <td>${escapeHtml(item.item_description)}</td>
            <td>${escapeHtml(item.part_number)}</td>
            <td><span class="badge">${escapeHtml(item.unit_of_measure)}</span></td>
            <td>${item.cost_per_unit ? parseFloat(item.cost_per_unit).toFixed(2) : '-'}</td>
            <td>${escapeHtml(item.supplier) || '-'}</td>
            <td>
                <span class="status-${item.is_active ? 'active' : 'inactive'}">
                    ${item.is_active ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-primary" onclick="editBOMItem(${item.id})" title="Edit">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteBOMItem(${item.id})" title="Delete">üóëÔ∏è</button>
                </div>
            </td>
        </tr>
    `).join('');
    
    if (itemsCount) {
        itemsCount.textContent = `${filteredBOMItems.length} items`;
    }
}

// Utility function to escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
}

// Update BOM filters
function updateBOMFilters() {
    const unitFilter = document.getElementById('unit-filter');
    if (!unitFilter) return;
    
    const units = [...new Set(allBOMItems.map(item => item.unit_of_measure))];
    
    unitFilter.innerHTML = '<option value="">All Units</option>' + 
        units.map(unit => `<option value="${escapeHtml(unit)}">${escapeHtml(unit)}</option>`).join('');
}

// Search BOM items
function searchBOMItems() {
    const searchInput = document.getElementById('bom-search');
    const unitFilter = document.getElementById('unit-filter');
    
    if (!searchInput || !unitFilter) return;
    
    const searchTerm = searchInput.value.toLowerCase();
    const unitFilterValue = unitFilter.value;
    
    filteredBOMItems = allBOMItems.filter(item => {
        const matchesSearch = !searchTerm || 
            item.item_code.toLowerCase().includes(searchTerm) ||
            item.item_description.toLowerCase().includes(searchTerm) ||
            item.part_number.toLowerCase().includes(searchTerm);
        
        const matchesUnit = !unitFilterValue || item.unit_of_measure === unitFilterValue;
        
        return matchesSearch && matchesUnit;
    });
    
    renderBOMItems();
}

// Filter BOM items
function filterBOMItems() {
    searchBOMItems(); // Use the same filtering logic
}

// Show add item modal
function showAddItemModal() {
    currentEditingItem = null;

    const modalTitle = document.getElementById('item-modal-title');
    const itemForm = document.getElementById('item-form');

    if (modalTitle) modalTitle.textContent = 'Add BOM Item';
    if (itemForm) itemForm.reset();

    // Clear file input
    const fileInput = document.getElementById('item-photo');
    if (fileInput) fileInput.value = '';

    // Clear preview
    const previewDiv = document.getElementById('item-photo-preview');
    if (previewDiv) previewDiv.innerHTML = '';

    showModal('item-modal');
}



// Edit BOM item
async function editBOMItem(itemId) {
    try {
        const item = allBOMItems.find(item => item.id === itemId);
        if (!item) {
            showAlert('Item not found', 'danger');
            return;
        }

        currentEditingItem = item;

        const modalTitle = document.getElementById('item-modal-title');
        if (modalTitle) modalTitle.textContent = 'Edit BOM Item';

        // Populate form fields
        const fields = {
            'item-code': item.item_code,
            'item-description': item.item_description,
            'part-number': item.part_number,
            'unit-measure': item.unit_of_measure,
            'cost-per-unit': item.cost_per_unit || '',
            'supplier': item.supplier || ''
        };

        Object.entries(fields).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) element.value = value;
        });

        // ‚úÖ Clear file input
        const fileInput = document.getElementById('item-photo');
        if (fileInput) fileInput.value = '';

        // ‚úÖ Show current photo preview if available
        const previewDiv = document.getElementById('item-photo-preview');
        if (previewDiv) {
            if (item.item_photo_url) {
                previewDiv.innerHTML = `
                    <p>Current Photo:</p>
                    <img src="${item.item_photo_url}" alt="Item Photo" style="max-height: 150px;" />
                `;
            } else {
                previewDiv.innerHTML = '';
            }
        }

        showModal('item-modal');

    } catch (error) {
        console.error('Error editing item:', error);
        showAlert('Error loading item details', 'danger');
    }
}


// Delete BOM item
async function deleteBOMItem(itemId) {
    if (!confirm('Are you sure you want to delete this BOM item?')) {
        return;
    }

    try {
        await makeAPICall(`/station/api/bom-items/${itemId}/`, {
            method: 'DELETE'
        });

        showAlert('BOM item deleted successfully', 'success');
        await loadBOMItems();

    } catch (error) {
        console.error('Error deleting item:', error);
        showAlert(`Error deleting BOM item: ${error.message}`, 'danger');
    }
}

// Handle BOM item form submission
async function handleItemSubmit(e) {
    e.preventDefault();
    
    try {
        const formData = new FormData();

        // Get form values
        const fields = {
            'item_code': document.getElementById('item-code')?.value,
            'item_description': document.getElementById('item-description')?.value,
            'part_number': document.getElementById('part-number')?.value,
            'unit_of_measure': document.getElementById('unit-measure')?.value,
            'cost_per_unit': document.getElementById('cost-per-unit')?.value,
            'supplier': document.getElementById('supplier')?.value
        };

        // Validate required fields
        const requiredFields = ['item_code', 'item_description', 'part_number'];
        const missingFields = requiredFields.filter(field => !fields[field]?.trim());

        if (missingFields.length > 0) {
            showAlert(`Missing required fields: ${missingFields.join(', ')}`, 'warning');
            return;
        }

        // Add fields to FormData
        Object.entries(fields).forEach(([key, value]) => {
            if (value) formData.append(key, value);
        });

        // Add photo if present
        const photoFile = document.getElementById('item-photo')?.files[0];
        if (photoFile) {
            formData.append('item_photo', photoFile);
        }

        // Determine create or update
        let url = '/station/api/bom-items/create/';
        let method = 'POST';

        if (currentEditingItem) {
            url = `/station/api/bom-items/${currentEditingItem.id}/`;
            formData.append('_method', 'PUT'); // Spoof PUT for update
        }

        // Call API
        const result = await makeAPICall(url, {
            method: 'POST', // Always POST, use method spoofing for update
            body: formData,
            headers: {} // Let browser set proper multipart/form-data headers
        });

        showAlert(
            currentEditingItem ? 'BOM item updated successfully' : 'BOM item created successfully',
            'success'
        );

        closeModal('item-modal');
        await loadBOMItems();

    } catch (error) {
        console.error('Error saving item:', error);
        showAlert(`Error saving BOM item: ${error.message}`, 'danger');
    }
}


// Excel upload functionality
async function uploadExcelFile() {
    console.log('uploadExcelFile called');
    
    const fileInput = document.getElementById('excel-file');
    const defaultUnit = document.getElementById('default-unit')?.value || 'NO.';
    const defaultSupplier = document.getElementById('default-supplier')?.value || '';
    const overwriteExisting = document.getElementById('overwrite-existing')?.checked || false;
    
    console.log('Form values:', {
        hasFile: !!fileInput?.files[0],
        fileName: fileInput?.files[0]?.name,
        defaultUnit,
        defaultSupplier,
        overwriteExisting
    });
    
    if (!fileInput?.files[0]) {
        showAlert('Please select an Excel file first', 'warning');
        return;
    }

    // Show loading state
    const uploadBtn = document.querySelector('button[onclick="uploadExcelFile()"]');
    const originalBtnText = uploadBtn?.innerHTML;
    
    if (uploadBtn) {
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; margin-right: 8px;"></div>Processing...';
    }

    try {
        // Create FormData
        const formData = new FormData();
        formData.append('excel_file', fileInput.files[0]);
        formData.append('unit_of_measure', defaultUnit);
        formData.append('supplier', defaultSupplier);
        formData.append('overwrite_existing', overwriteExisting.toString());
        
        // Add CSRF token
        const csrfToken = getCsrfToken();
        if (csrfToken) {
            formData.append('csrfmiddlewaretoken', csrfToken);
        }

        console.log('Making API call to Excel upload endpoint...');
        console.log('FormData entries:');
        for (let [key, value] of formData.entries()) {
            if (key === 'excel_file') {
                console.log(`${key}: ${value.name} (${value.size} bytes)`);
            } else {
                console.log(`${key}: ${value}`);
            }
        }

        // Make the API call with proper headers
        const response = await fetch('/station/upload-excel/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                // Don't set Content-Type - let browser set it for FormData
            }
        });

        console.log('Response received:', {
            status: response.status,
            statusText: response.statusText,
            contentType: response.headers.get('content-type')
        });

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const textResponse = await response.text();
            console.error('Non-JSON response received:', textResponse.substring(0, 1000));
            
            // Try to extract error message from HTML
            let errorMessage = 'Server returned HTML instead of JSON';
            if (textResponse.includes('<title>')) {
                const titleMatch = textResponse.match(/<title>(.*?)<\/title>/i);
                if (titleMatch) {
                    errorMessage = `Server Error: ${titleMatch[1]}`;
                }
            }
            
            throw new Error(`${errorMessage}. Check Django server logs for details.`);
        }

        const result = await response.json();
        console.log('JSON response:', result);

        if (!response.ok) {
            throw new Error(result.error || `HTTP ${response.status}: ${response.statusText}`);
        }

        if (result.success === false) {
            throw new Error(result.error || 'Upload failed');
        }

        // Success!
        const message = `Excel processed successfully!\n` +
                       `Created: ${result.created}\n` +
                       `Updated: ${result.updated}\n` +
                       `Skipped: ${result.skipped}` +
                       (result.errors > 0 ? `\nErrors: ${result.errors}` : '');
        
        showAlert(message, 'success');
        clearUploadForm();
        
        // Reload BOM items if we're in the context of a product
        if (typeof currentProduct !== 'undefined' && currentProduct) {
            await loadBOMItems();
        }

    } catch (error) {
        console.error('Excel upload error:', error);
        
        let errorMessage = error.message;
        
        // Provide more helpful error messages
        if (errorMessage.includes('Failed to fetch')) {
            errorMessage = 'Network error. Please check your internet connection and try again.';
        } else if (errorMessage.includes('CSRF')) {
            errorMessage = 'Security token error. Please refresh the page and try again.';
        } else if (errorMessage.includes('Server Error')) {
            errorMessage += '\n\nThis usually means there\'s an issue with the Excel file format or server configuration.';
        }
        
        showAlert(`Error uploading Excel file: ${errorMessage}`, 'danger');
        
    } finally {
        // Reset button state
        if (uploadBtn && originalBtnText) {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = originalBtnText;
        }
    }
}


function clearUploadForm() {
    const form = document.getElementById('excel-upload-form');
    if (form) form.reset();
    
    const fileUpload = document.querySelector('.file-upload');
    if (fileUpload) {
        fileUpload.innerHTML = `
            <div class="upload-icon">üìÑ</div>
            <p><strong>Click to select Excel file</strong></p>
            <p>Or drag and drop here</p>
            <small>Supports .xlsx and .xls files</small>
        `;
    }
}

// File drag and drop handlers
function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const fileInput = document.getElementById('excel-file');
        if (fileInput) {
            fileInput.files = files;
            handleFileSelect(fileInput);
        }
    }
}

function handleFileSelect(input) {
    const file = input.files[0];
    if (file) {
        const fileUpload = document.querySelector('.file-upload');
        if (fileUpload) {
            fileUpload.innerHTML = `
                <div class="upload-icon">‚úÖ</div>
                <p><strong>${escapeHtml(file.name)}</strong></p>
                <p>File selected successfully</p>
                <small>Click "Upload and Process" to continue</small>
            `;
        }
    }
}

// Tab management
function showTab(tabName) {
    // Remove active class from all tabs and contents
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // Add active class to selected tab and content
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    const tabContent = document.getElementById(`${tabName}-tab`);
    if (tabContent) {
        tabContent.classList.add('active');
    }
    
    // Load data if needed
    switch(tabName) {
        case 'bom-templates':
            if (currentProduct) loadBOMTemplates();
            break;
        case 'stations':
            loadStations();
            break;
        case 'media':
            if (currentProduct) loadMedia();
            break;
    }
}


async function testExcelEndpoint() {
    try {
        console.log('Testing Excel endpoint...');
        
        const response = await fetch('/admin/screen_app/bomitem/upload-excel/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        
        const contentType = response.headers.get('content-type');
        console.log('Test response:', {
            status: response.status,
            contentType: contentType
        });
        
        if (contentType && contentType.includes('application/json')) {
            const data = await response.json();
            console.log('JSON response:', data);
            showAlert('Excel endpoint test successful!', 'success');
        } else {
            const text = await response.text();
            console.log('HTML response (first 500 chars):', text.substring(0, 500));
            showAlert('Excel endpoint returned HTML - check URL configuration', 'warning');
        }
        
    } catch (error) {
        console.error('Test failed:', error);
        showAlert(`Endpoint test failed: ${error.message}`, 'danger');
    }
}


// Modal management
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
}

// Load BOM templates (placeholder)
async function loadBOMTemplates() {
    try {
        if (!currentProduct) return;
        
        const data = await makeAPICall(`/station/api/bom-templates/?product=${currentProduct.id}`);
        renderBOMTemplates(data.templates || []);
        
        const bomTemplatesCount = document.getElementById('bom-templates-count');
        if (bomTemplatesCount) {
            bomTemplatesCount.textContent = data.templates?.length || 0;
        }
        
    } catch (error) {
        console.error('Error loading BOM templates:', error);
        const container = document.getElementById('bom-templates-container');
        if (container) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <h3>Error loading BOM templates</h3>
                    <p>${error.message}</p>
                </div>
            `;
        }
        showAlert(`Error loading BOM templates: ${error.message}`, 'danger');
    }
}

function renderBOMTemplates(templates) {
    const container = document.getElementById('bom-templates-container');
    if (!container) return;
    
    if (templates.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <h3>No BOM templates found</h3>
                <p>Create templates to organize your BOMs by type and stage</p>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <div class="data-table">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Template Name</th>
                            <th>BOM Type</th>
                            <th>Stage</th>
                            <th>Items</th>
                            <th>Displays</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${templates.map(template => `
                            <tr>
                                <td><strong>${escapeHtml(template.name)}</strong></td>
                                <td><span class="badge">${escapeHtml(template.bom_type_display)}</span></td>
                                <td>${escapeHtml(template.stage_display) || '-'}</td>
                                <td>${template.item_count}</td>
                                <td>
                                    ${template.displays.screen_1 ? '<span class="display-badge" style="background: #FF6B6B;">D1</span>' : ''}
                                    ${template.displays.screen_2 ? '<span class="display-badge" style="background: #4ECDC4;">D2</span>' : ''}
                                    ${template.displays.screen_3 ? '<span class="display-badge" style="background: #45B7D1;">D3</span>' : ''}
                                </td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-primary" onclick="previewBOMTemplate(${template.id})" title="Preview">üëÅÔ∏è</button>
                                        <button class="btn btn-sm btn-success" onclick="exportBOMTemplate(${template.id})" title="Export">üì§</button>
                                        <button class="btn btn-sm btn-warning" onclick="editBOMTemplate(${template.id})" title="Edit">‚úèÔ∏è</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteBOMTemplate(${template.id})" title="Delete">üóëÔ∏è</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// Load stations (placeholder)
async function loadStations() {
    try {
        const data = await makeAPICall('/station/api/stations/');
        renderStations(data.stations || []);
        
        const stationsCount = document.getElementById('stations-count');
        if (stationsCount) {
            stationsCount.textContent = data.stations?.length || 0;
        }
        
    } catch (error) {
        console.error('Error loading stations:', error);
        const container = document.getElementById('stations-container');
        if (container) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <h3>Error loading stations</h3>
                    <p>${error.message}</p>
                </div>
            `;
        }
        showAlert(`Error loading stations: ${error.message}`, 'danger');
    }
}

function renderStations(stationsData) {
    const container = document.getElementById('stations-container');
    if (!container) return;
    
    if (!stationsData || stationsData.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üñ•Ô∏è</div>
                <h3>No stations found</h3>
                <p>Configure stations to manage displays</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = stationsData.map(station => {
        const displayNum = station.display_number || station.id;
        const status = station.status || 'unknown';
        
        return `
            <div class="station-card display-${displayNum}">
                <div class="station-header">
                    <div class="station-name">${escapeHtml(station.name || `Display ${displayNum}`)}</div>
                    <div class="display-badge ${status === 'online' ? '' : 'offline'}">${status.toUpperCase()}</div>
                </div>
                <div class="station-info">
                    <p><strong>Product:</strong> <span>${station.current_product ? escapeHtml(station.current_product.name) : 'None'}</span></p>
                    <p><strong>Stage:</strong> <span>${station.current_stage ? escapeHtml(station.current_stage.display_name) : 'None'}</span></p>
                    <p><strong>Process:</strong> <span>${station.current_process ? escapeHtml(station.current_process.display_name) : 'None'}</span></p>
                    <p><strong>Quantity:</strong> <span>${station.quantity || 0}</span></p>
                    <p><strong>Loop Mode:</strong> <span class="status-${station.loop_mode ? 'active' : 'inactive'}">${station.loop_mode ? 'ON' : 'OFF'}</span></p>
                </div>
                <div class="station-actions">
                    <button class="btn btn-sm btn-primary" onclick="configureStation(${displayNum})" title="Configure">‚öôÔ∏è</button>
                    <button class="btn btn-sm btn-success" onclick="openStation(${displayNum})" title="Open">üì∫</button>
                    <button class="btn btn-sm btn-warning" onclick="testStation(${displayNum})" title="Test">üß™</button>
                </div>
            </div>
        `;
    }).join('');
}

// Load media (placeholder)
async function loadMedia() {
    try {
        if (!currentProduct) {
            const container = document.getElementById('media-container');
            if (container) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÅ</div>
                        <h3>No Product Selected</h3>
                        <p>Please select a product to view media files</p>
                    </div>
                `;
            }
            return;
        }

        showLoadingState('media-container', 'Loading media files...');
        
        const data = await makeAPICall(`/station/api/product-media/?product=${currentProduct.id}`);
        
        renderMediaFiles(data.media || [], data.filters || {});
        updateMediaCount(data.media?.length || 0);
        
    } catch (error) {
        console.error('Error loading media:', error);
        const container = document.getElementById('media-container');
        if (container) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <h3>Error loading media files</h3>
                    <p>${error.message}</p>
                </div>
            `;
        }
        showAlert(`Error loading media files: ${error.message}`, 'danger');
    }
}


// Render media files
function renderMediaFiles(mediaFiles, filters = {}) {
    const container = document.getElementById('media-container');
    if (!container) return;
    
    if (mediaFiles.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìÅ</div>
                <h3>No Media Files Found</h3>
                <p>Upload media files using the "Add Media" button</p>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <div class="data-table">
            <div class="table-header">
                <div class="search-box">
                    <input type="text" class="search-input" id="media-search" placeholder="Search media files..." onkeyup="searchMedia()">
                    <select class="form-control" id="media-type-filter" onchange="filterMedia()">
                        <option value="">All Types</option>
                        <option value="BOM">Bill of Material</option>
                        <option value="PROCESS_DOC">Process Document</option>
                        <option value="VIDEO">Video</option>
                        <option value="INSTRUCTION">Instruction Manual</option>
                    </select>
                    <select class="form-control" id="display-filter" onchange="filterMedia()">
                        <option value="">All Displays</option>
                        <option value="1">Display 1</option>
                        <option value="2">Display 2</option>
                        <option value="3">Display 3</option>
                    </select>
                </div>
                <div class="actions">
                    <button class="btn btn-sm btn-warning" onclick="bulkUpdateDisplays()">üì∫ Bulk Update Displays</button>
                    <button class="btn btn-sm btn-danger" onclick="bulkDeleteMedia()">üóëÔ∏è Bulk Delete</button>
                    <span id="media-count">${mediaFiles.length} files</span>
                </div>
            </div>
            <div class="table-container">
                <table id="media-files-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-media" onchange="toggleSelectAllMedia()"></th>
                            <th>Preview</th>
                            <th>File Name</th>
                            <th>Type</th>
                            <th>Size</th>
                            <th>Duration</th>
                            <th>Process</th>
                            <th>Displays</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="media-files-tbody">
                        ${renderMediaRows(mediaFiles)}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// Render media file rows
function renderMediaRows(mediaFiles) {
    return mediaFiles.map(media => `
        <tr>
            <td>
                <input type="checkbox" class="media-select" value="${media.id}">
            </td>
            <td>
                ${renderMediaPreview(media)}
            </td>
            <td>
                <strong>${escapeHtml(media.file_name)}</strong>
                <br><small>${formatFileSize(media.file_size)}</small>
            </td>
            <td>
                <span class="badge" style="background: ${getMediaTypeColor(media.media_type)};">
                    ${escapeHtml(media.media_type_display)}
                </span>
            </td>
            <td>${formatFileSize(media.file_size)}</td>
            <td>${media.duration}s</td>
            <td>
                ${media.process ? 
                    `<span title="${escapeHtml(media.process.stage)}">${escapeHtml(media.process.display_name)}</span>` : 
                    '<span style="color: #999;">None</span>'
                }
            </td>
            <td>
                ${renderDisplayAssignment(media.display_assignment)}
            </td>
            <td>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-primary" onclick="previewMedia(${media.id})" title="Preview">üëÅÔ∏è</button>
                    <button class="btn btn-sm btn-success" onclick="downloadMedia(${media.id})" title="Download">üì•</button>
                    <button class="btn btn-sm btn-warning" onclick="editMedia(${media.id})" title="Edit">‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteMedia(${media.id})" title="Delete">üóëÔ∏è</button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Render media preview
function renderMediaPreview(media) {
    if (!media.file_url) {
        return '<div style="width: 40px; height: 40px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #666;">No File</div>';
    }
    
    const fileType = media.file_type || '';
    
    if (['jpg', 'jpeg', 'png', 'gif'].includes(fileType)) {
        return `<img src="${media.file_url}" alt="Preview" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px;" onclick="previewMedia(${media.id})">`;
    } else if (['mp4', 'mov', 'avi'].includes(fileType)) {
        return `<div style="width: 40px; height: 40px; background: #007bff; color: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer;" onclick="previewMedia(${media.id})">‚ñ∂Ô∏è</div>`;
    } else if (fileType === 'pdf') {
        return `<div style="width: 40px; height: 40px; background: #dc3545; color: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer;" onclick="previewMedia(${media.id})">üìÑ</div>`;
    } else {
        return `<div style="width: 40px; height: 40px; background: #6c757d; color: white; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer;" onclick="previewMedia(${media.id})">üìÅ</div>`;
    }
}

// Render display assignment
function renderDisplayAssignment(assignment) {
    const displays = [];
    if (assignment.display_1) displays.push('<span class="display-badge" style="background: #FF6B6B;">D1</span>');
    if (assignment.display_2) displays.push('<span class="display-badge" style="background: #4ECDC4;">D2</span>');
    if (assignment.display_3) displays.push('<span class="display-badge" style="background: #45B7D1;">D3</span>');
    
    return displays.length > 0 ? displays.join(' ') : '<span style="color: #999;">None</span>';
}

// Get media type color
function getMediaTypeColor(mediaType) {
    const colors = {
        'BOM': '#28a745',
        'PROCESS_DOC': '#007bff',
        'VIDEO': '#dc3545',
        'INSTRUCTION': '#ffc107'
    };
    return colors[mediaType] || '#6c757d';
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Update media count
function updateMediaCount(count) {
    const mediaCountElement = document.getElementById('media-count');
    if (mediaCountElement) {
        mediaCountElement.textContent = count;
    }
}


// Update product overview
async function updateProductOverview() {
    try {
        if (!currentProduct) return;
        
        // Update counters (these will be updated by individual load functions)
        const elements = {
            'bom-templates-count': '0',
            'bom-items-count': allBOMItems.length.toString(),
            'stations-count': '3',
            'media-count': '0'
        };
        
        Object.entries(elements).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        });
        
    } catch (error) {
        console.error('Error updating overview:', error);
    }
}

// Station management functions
function configureStation(stationId) {
    currentEditingStation = stationId;
    const modalTitle = document.getElementById('station-modal-title');
    if (modalTitle) {
        modalTitle.textContent = `Configure Display ${stationId}`;
    }
    
    // Populate stage dropdown
    const stageSelect = document.getElementById('station-stage');
    if (stageSelect) {
        stageSelect.innerHTML = '<option value="">Select Stage</option>' +
            allStages.map(stage => `<option value="${stage.id}">${escapeHtml(stage.display_name)}</option>`).join('');
    }
    
    showModal('station-modal');
}

function updateStationProcesses() {
    const stageSelect = document.getElementById('station-stage');
    const processSelect = document.getElementById('station-process');
    
    if (!stageSelect || !processSelect) return;
    
    const stageId = stageSelect.value;
    
    if (!stageId) {
        processSelect.innerHTML = '<option value="">Select stage first</option>';
        return;
    }

    const selectedStage = allStages.find(stage => stage.id == stageId);
    if (selectedStage && selectedStage.processes) {
        processSelect.innerHTML = '<option value="">Select Process</option>' +
            selectedStage.processes.map(process => 
                `<option value="${process.id}">${escapeHtml(process.name)} - ${escapeHtml(process.display_name)}</option>`
            ).join('');
    }
}

function openStation(stationId) {
    window.open(`/station/${stationId}/slider/`, '_blank');
}

function testStation(stationId) {
    window.open(`/station/${stationId}/slider/`, '_blank');
}

async function syncAllStations() {
    if (!currentProduct) {
        showAlert('Please select a product first', 'warning');
        return;
    }

    try {
        const config = {
            product_id: currentProduct.id,
            quantity: currentQuantity
        };

        const result = await makeAPICall('/station/api/stations/bulk-update/', {
            method: 'POST',
            body: JSON.stringify({
                station_ids: [1, 2, 3],
                config: config
            })
        });

        showAlert(`${result.message}`, 'success');
        await loadStations();

    } catch (error) {
        console.error('Error syncing stations:', error);
        showAlert(`Error synchronizing stations: ${error.message}`, 'danger');
    }
}

// Handle station form submission
async function handleStationSubmit(e) {
    e.preventDefault();
    
    if (!currentEditingStation) return;

    try {
        const config = {
            product_id: currentProduct?.id,
            stage_id: document.getElementById('station-stage')?.value,
            process_id: document.getElementById('station-process')?.value,
            quantity: parseInt(document.getElementById('station-quantity')?.value || 50),
            show_single_unit_bom: document.getElementById('show-single-unit')?.checked || false,
            show_batch_bom: document.getElementById('show-batch')?.checked || false
        };

        const result = await makeAPICall(`/station/${currentEditingStation}/assembly/config/`, {
            method: 'POST',
            body: JSON.stringify(config)
        });

        showAlert(`Display ${currentEditingStation} configured successfully`, 'success');
        closeModal('station-modal');
        await loadStations();

    } catch (error) {
        console.error('Error configuring station:', error);
        showAlert(`Error configuring station: ${error.message}`, 'danger');
    }
}

// Handle template form submission
async function handleTemplateSubmit(e) {
    e.preventDefault();
    
    if (!currentProduct) {
        showAlert('Please select a product first', 'warning');
        return;
    }
    
    try {
        const templateData = {
            product: currentProduct.id,
            template_name: document.getElementById('template-name')?.value,
            bom_type: document.getElementById('bom-type')?.value,
            stage: document.getElementById('template-stage')?.value || null,
            description: document.getElementById('template-description')?.value || '',
            display_screen_1: document.getElementById('display-1')?.checked || false,
            display_screen_2: document.getElementById('display-2')?.checked || false,
            display_screen_3: document.getElementById('display-3')?.checked || false
        };

        const result = await makeAPICall('/station/api/bom-templates/', {
            method: 'POST',
            body: JSON.stringify(templateData)
        });

        showAlert('BOM template created successfully', 'success');
        closeModal('template-modal');
        await loadBOMTemplates();

    } catch (error) {
        console.error('Error creating template:', error);
        showAlert(`Error creating BOM template: ${error.message}`, 'danger');
    }
}

// BOM Template functions
function showAddTemplateModal() {
    const modalTitle = document.getElementById('template-modal-title');
    const templateForm = document.getElementById('template-form');
    
    if (modalTitle) modalTitle.textContent = 'Create BOM Template';
    if (templateForm) templateForm.reset();
    
    // Populate stage dropdown
    const stageSelect = document.getElementById('template-stage');
    if (stageSelect) {
        stageSelect.innerHTML = '<option value="">Select Stage</option>' +
            allStages.map(stage => `<option value="${stage.id}">${escapeHtml(stage.display_name)}</option>`).join('');
    }
    
    showModal('template-modal');
}

async function previewBOMTemplate(templateId) {
    const quantity = prompt('Enter quantity for preview:', currentQuantity);
    if (!quantity) return;

    try {
        const data = await makeAPICall(`/station/api/bom-templates/${templateId}/preview/?quantity=${quantity}`);

        const previewContent = `

            <div class="data-table">
                <div class="table-container" style="max-height: 400px;">
                    <table>
                        <thead>
                            <tr>
                                <th>S.No</th>
                                <th>Item Code</th>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.bom_data.map(item => `
                                <tr>
                                    <td>${item.serial_number}</td>
                                    <td><strong>${escapeHtml(item.item_code)}</strong></td>
                                    <td>${escapeHtml(item.item_description)}</td>
                                    <td>${escapeHtml(item.formatted_quantity)}</td>
                                    <td>${escapeHtml(item.unit_of_measure)}</td>
                                    <td>${item.cost_per_unit ? item.line_cost.toFixed(2) : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="alert alert-info mt-3">
                <strong>Summary:</strong> ${data.summary.total_items} items, 
                Total Cost: ${data.summary.total_cost.toFixed(2)}
            </div>
        `;

        const previewContentElement = document.getElementById('bom-preview-content');
        const previewTitleElement = document.getElementById('bom-preview-title');
        
        if (previewContentElement) previewContentElement.innerHTML = previewContent;
        if (previewTitleElement) previewTitleElement.textContent = `BOM Preview - ${data.template.name}`;
        
        showModal('bom-preview-modal');

    } catch (error) {
        console.error('Error previewing template:', error);
        showAlert(`Error loading BOM preview: ${error.message}`, 'danger');
    }
}

async function exportBOMTemplate(templateId, quantity = null) {
    const qty = quantity || prompt('Enter quantity for export:', currentQuantity);
    if (!qty) return;

    try {
        const link = document.createElement('a');
        link.href = `/api/bom-templates/${templateId}/export/?quantity=${qty}`;
        link.download = `bom_template_${templateId}_qty_${qty}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('BOM template exported successfully', 'success');

    } catch (error) {
        console.error('Error exporting template:', error);
        showAlert(`Error exporting BOM template: ${error.message}`, 'danger');
    }
}

async function editBOMTemplate(templateId) {
    showAlert('Template editing functionality coming soon', 'info');
}

async function deleteBOMTemplate(templateId) {
    if (!confirm('Are you sure you want to delete this BOM template?')) {
        return;
    }

    try {
        await makeAPICall(`/station/api/bom-templates/${templateId}/`, {
            method: 'DELETE'
        });

        showAlert('BOM template deleted successfully', 'success');
        await loadBOMTemplates();

    } catch (error) {
        console.error('Error deleting template:', error);
        showAlert(`Error deleting BOM template: ${error.message}`, 'danger');
    }
}

// Refresh functions
async function refreshBOMItems() {
    if (currentProduct) {
        await loadBOMItems();
        showAlert('BOM items refreshed', 'success');
    }
}

async function refreshBOMTemplates() {
    if (currentProduct) {
        await loadBOMTemplates();
        showAlert('BOM templates refreshed', 'success');
    }
}

async function refreshStations() {
    await loadStations();
    showAlert('Stations refreshed', 'success');
}

async function refreshMedia() {
    if (currentProduct) {
        await loadMedia();
        showAlert('Media refreshed', 'success');
    }
}

// Export functions
async function exportBOMItems() {
    try {
        const link = document.createElement('a');
        link.href = '/api/bom-items/export/';
        link.download = 'all_bom_items.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('BOM items exported successfully', 'success');

    } catch (error) {
        console.error('Error exporting BOM items:', error);
        showAlert(`Error exporting BOM items: ${error.message}`, 'danger');
    }
}

// Media management placeholders
function showAddMediaModal() {
    if (!currentProduct) {
        showAlert('Please select a product first', 'warning');
        return;
    }

    const modalTitle = document.getElementById('media-modal-title');
    const mediaForm = document.getElementById('media-form');
    
    if (modalTitle) modalTitle.textContent = 'Add Media File';
    if (mediaForm) mediaForm.reset();
    
    // Clear file input and preview
    const fileInput = document.getElementById('media-file');
    const previewDiv = document.getElementById('media-file-preview');
    if (fileInput) fileInput.value = '';
    if (previewDiv) previewDiv.innerHTML = '';
    
    // Populate process dropdown
    populateProcessDropdown('media-process');
    
    showModal('media-modal');
}



// Populate process dropdown
async function populateProcessDropdown(selectId) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    try {
        const data = await makeAPICall('/station/1/assembly/options/');
        select.innerHTML = '<option value="">No Process Association</option>';
        
        if (data.stages) {
            data.stages.forEach(stage => {
                if (stage.processes && stage.processes.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = stage.display_name;
                    
                    stage.processes.forEach(process => {
                        const option = document.createElement('option');
                        option.value = process.id;
                        option.textContent = `${process.name} - ${process.display_name}`;
                        optgroup.appendChild(option);
                    });
                    
                    select.appendChild(optgroup);
                }
            });
        }
    } catch (error) {
        console.error('Error loading processes:', error);
        select.innerHTML = '<option value="">Error loading processes</option>';
    }
}



// Handle media form submission
async function handleMediaSubmit(e) {
    e.preventDefault();
    
    if (!currentProduct) {
        showAlert('Please select a product first', 'warning');
        return;
    }
    
    try {
        const formData = new FormData();
        
        // Add product ID
        formData.append('product_id', currentProduct.id);
        
        // Get form values
        const mediaFile = document.getElementById('media-file')?.files[0];
        const mediaType = document.getElementById('media-type')?.value || 'PROCESS_DOC';
        const duration = document.getElementById('media-duration')?.value || '15';
        const processId = document.getElementById('media-process')?.value || '';
        const display1 = document.getElementById('media-display-1')?.checked || false;
        const display2 = document.getElementById('media-display-2')?.checked || false;
        const display3 = document.getElementById('media-display-3')?.checked || false;
        
        // Validate file
        if (!mediaFile) {
            showAlert('Please select a media file', 'warning');
            return;
        }
        
        // Validate at least one display selected
        if (!display1 && !display2 && !display3) {
            showAlert('Please select at least one display screen', 'warning');
            return;
        }
        
        // Add form data
        formData.append('media_file', mediaFile);
        formData.append('media_type', mediaType);
        formData.append('duration', duration);
        formData.append('display_screen_1', display1);
        formData.append('display_screen_2', display2);
        formData.append('display_screen_3', display3);
        
        if (processId) {
            formData.append('process_id', processId);
        }
        
        // Show loading state
        const submitBtn = document.querySelector('#media-form button[type="submit"]');
        const originalText = submitBtn?.innerHTML;
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; margin-right: 8px;"></div>Uploading...';
        }
        
        // Upload file
        const result = await makeAPICall('/station/api/product-media/create/', {
            method: 'POST',
            body: formData,
            headers: {} // Let browser set content-type for FormData
        });
        
        showAlert('Media file uploaded successfully', 'success');
        closeModal('media-modal');
        await loadMedia();
        
    } catch (error) {
        console.error('Error uploading media:', error);
        showAlert(`Error uploading media file: ${error.message}`, 'danger');
    } finally {
        // Reset button state
        const submitBtn = document.querySelector('#media-form button[type="submit"]');
        if (submitBtn && originalText) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }
}


// Preview media file
async function previewMedia(mediaId) {
    try {
        const data = await makeAPICall(`/station/api/media-preview/${mediaId}/`);
        const media = data.media;
        
        const previewContent = document.getElementById('media-preview-content');
        const previewTitle = document.getElementById('media-preview-title');
        
        if (previewTitle) {
            previewTitle.textContent = `Preview: ${media.file_name}`;
        }
        
        if (previewContent) {
            let content = '';
            
            if (media.preview_type === 'image') {
                content = `
                    <div class="text-center">
                        <img src="${media.file_url}" alt="${media.file_name}" style="max-width: 100%; max-height: 500px;">
                    </div>
                `;
            } else if (media.preview_type === 'video') {
                content = `
                    <div class="text-center">
                        <video controls style="max-width: 100%; max-height: 500px;">
                            <source src="${media.file_url}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                `;
            } else if (media.preview_type === 'pdf') {
                content = `
                    <div class="text-center">
                        <iframe src="${media.file_url}" style="width: 100%; height: 500px; border: none;"></iframe>
                        <p><a href="${media.file_url}" target="_blank" class="btn btn-primary">üìÑ Open PDF in New Tab</a></p>
                    </div>
                `;
            } else {
                content = `
                    <div class="text-center">
                        <div class="empty-state-icon">üìÅ</div>
                        <h3>Preview Not Available</h3>
                        <p>File type: ${media.file_extension?.toUpperCase()}</p>
                        <p>Size: ${formatFileSize(media.file_size)}</p>
                        <a href="${media.file_url}" target="_blank" class="btn btn-primary">üì• Download File</a>
                    </div>
                `;
            }
            
            // Add media details
            content += `
                <div class="mt-3" style="border-top: 2px solid #e9ecef; padding-top: 20px;">
                    <h4>Media Details</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Type:</strong> ${media.media_type}</p>
                            <p><strong>Duration:</strong> ${media.duration} seconds</p>
                            <p><strong>File Size:</strong> ${media.file_size_mb} MB</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Product:</strong> ${media.product.code} - ${media.product.name}</p>
                            <p><strong>Displays:</strong> ${media.assigned_displays.map(d => `Display ${d}`).join(', ') || 'None'}</p>
                            ${media.process ? `<p><strong>Process:</strong> ${media.process.display_name}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            previewContent.innerHTML = content;
        }
        
        showModal('media-preview-modal');
        
    } catch (error) {
        console.error('Error previewing media:', error);
        showAlert(`Error loading media preview: ${error.message}`, 'danger');
    }
}

// Download media file
function downloadMedia(mediaId) {
    window.open(`/station/api/media-download/${mediaId}/`, '_blank');
}

// Edit media file
async function editMedia(mediaId) {
    try {
        const data = await makeAPICall(`/station/api/media-preview/${mediaId}/`);
        const media = data.media;
        
        currentEditingMedia = media;
        
        const modalTitle = document.getElementById('media-modal-title');
        if (modalTitle) modalTitle.textContent = 'Edit Media File';
        
        // Populate form fields
        const fields = {
            'media-type': media.media_type,
            'media-duration': media.duration,
            'media-display-1': media.display_assignments.display_1,
            'media-display-2': media.display_assignments.display_2,
            'media-display-3': media.display_assignments.display_3,
        };
        
        Object.entries(fields).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = value;
                } else {
                    element.value = value;
                }
            }
        });
        
        // Populate process dropdown and set value
        await populateProcessDropdown('media-process');
        if (media.process) {
            const processSelect = document.getElementById('media-process');
            if (processSelect) {
                processSelect.value = media.process.id;
            }
        }
        
        // Clear file input but show current file info
        const fileInput = document.getElementById('media-file');
        const previewDiv = document.getElementById('media-file-preview');
        if (fileInput) fileInput.value = '';
        if (previewDiv) {
            previewDiv.innerHTML = `
                <p>Current file: <strong>${media.file_name}</strong></p>
                <p>Size: ${formatFileSize(media.file_size)}</p>
                <small>Leave file input empty to keep current file</small>
            `;
        }
        
        showModal('media-modal');
        
    } catch (error) {
        console.error('Error loading media details:', error);
        showAlert('Error loading media details', 'danger');
    }
}

// Delete media file
async function deleteMedia(mediaId) {
    if (!confirm('Are you sure you want to delete this media file?')) {
        return;
    }
    
    try {
        await makeAPICall(`/station/api/product-media/${mediaId}/`, {
            method: 'DELETE'
        });
        
        showAlert('Media file deleted successfully', 'success');
        await loadMedia();
        
    } catch (error) {
        console.error('Error deleting media:', error);
        showAlert(`Error deleting media file: ${error.message}`, 'danger');
    }
}

// Search media files
function searchMedia() {
    const searchInput = document.getElementById('media-search');
    const typeFilter = document.getElementById('media-type-filter');
    const displayFilter = document.getElementById('display-filter');
    
    if (!searchInput || !currentProduct) return;
    
    // Debounce search
    clearTimeout(window.mediaSearchTimeout);
    window.mediaSearchTimeout = setTimeout(async () => {
        try {
            const searchTerm = searchInput.value.trim();
            const mediaType = typeFilter?.value || '';
            const display = displayFilter?.value || '';
            
            const params = new URLSearchParams({
                product: currentProduct.id,
                search: searchTerm,
                media_type: mediaType,
                display: display
            });
            
            const data = await makeAPICall(`/station/api/product-media/?${params}`);
            renderMediaFiles(data.media || [], data.filters || {});
            
        } catch (error) {
            console.error('Error searching media:', error);
            showAlert(`Error searching media: ${error.message}`, 'danger');
        }
    }, 300);
}

// Filter media files
function filterMedia() {
    searchMedia(); // Use the same search function
}

// Toggle select all media
function toggleSelectAllMedia() {
    const selectAll = document.getElementById('select-all-media');
    const checkboxes = document.querySelectorAll('.media-select');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

// Bulk update display assignments
async function bulkUpdateDisplays() {
    const selectedMedia = Array.from(document.querySelectorAll('.media-select:checked')).map(cb => parseInt(cb.value));
    
    if (selectedMedia.length === 0) {
        showAlert('Please select media files first', 'warning');
        return;
    }
    
    // Show bulk update modal
    const modalContent = `
        <div class="modal-header">
            <h3>Bulk Update Display Assignments</h3>
            <button class="close-btn" onclick="closeModal('bulk-update-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <p>Update display assignments for ${selectedMedia.length} selected media files:</p>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="bulk-display-1"> Display 1
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="bulk-display-2"> Display 2
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="bulk-display-3"> Display 3
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-success" onclick="executeBulkDisplayUpdate(${JSON.stringify(selectedMedia).replace(/"/g, '&quot;')})">Update Displays</button>
            <button class="btn btn-secondary" onclick="closeModal('bulk-update-modal')">Cancel</button>
        </div>
    `;
    
    // Create temporary modal
    let modal = document.getElementById('bulk-update-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'bulk-update-modal';
        modal.className = 'modal';
        document.body.appendChild(modal);
    }
    modal.innerHTML = `<div class="modal-content">${modalContent}</div>`;
    
    showModal('bulk-update-modal');
}

// Execute bulk display update
async function executeBulkDisplayUpdate(mediaIds) {
    try {
        const display1 = document.getElementById('bulk-display-1')?.checked || false;
        const display2 = document.getElementById('bulk-display-2')?.checked || false;
        const display3 = document.getElementById('bulk-display-3')?.checked || false;
        
        const result = await makeAPICall('/station/api/bulk-update-media-displays/', {
            method: 'POST',
            body: JSON.stringify({
                media_ids: mediaIds,
                display_settings: {
                    display_screen_1: display1,
                    display_screen_2: display2,
                    display_screen_3: display3
                }
            })
        });
        
        showAlert(result.message, 'success');
        closeModal('bulk-update-modal');
        await loadMedia();
        
    } catch (error) {
        console.error('Error updating displays:', error);
        showAlert(`Error updating displays: ${error.message}`, 'danger');
    }
}
// Bulk delete media files
async function bulkDeleteMedia() {
    const selectedMedia = Array.from(document.querySelectorAll('.media-select:checked')).map(cb => parseInt(cb.value));
    
    if (selectedMedia.length === 0) {
        showAlert('Please select media files first', 'warning');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${selectedMedia.length} media files? This action cannot be undone.`)) {
        return;
    }
    
    try {
        const result = await makeAPICall('/station/api/bulk-delete-media/', {
            method: 'POST',
            body: JSON.stringify({
                media_ids: selectedMedia
            })
        });
        
        showAlert(result.message, 'success');
        await loadMedia();
        
        // Uncheck select all
        const selectAll = document.getElementById('select-all-media');
        if (selectAll) selectAll.checked = false;
        
    } catch (error) {
        console.error('Error deleting media:', error);
        showAlert(`Error deleting media files: ${error.message}`, 'danger');
    }
}

async function refreshMedia() {
    if (currentProduct) {
        await loadMedia();
        showAlert('Media files refreshed', 'success');
    }
}
// Handle file input change for preview
function handleMediaFileSelect(input) {
    const file = input.files[0];
    const previewDiv = document.getElementById('media-file-preview');
    
    if (!previewDiv) return;
    
    if (file) {
        const fileSize = formatFileSize(file.size);
        const fileName = file.name;
        const fileType = file.type;
        
        let preview = `
            <p><strong>Selected:</strong> ${fileName}</p>
            <p><strong>Size:</strong> ${fileSize}</p>
            <p><strong>Type:</strong> ${fileType}</p>
        `;
        
        // Show image preview for images
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview += `<img src="${e.target.result}" style="max-width: 200px; max-height: 150px; margin-top: 10px; border-radius: 6px;">`;
                previewDiv.innerHTML = preview;
            };
            reader.readAsDataURL(file);
        } else {
            previewDiv.innerHTML = preview;
        }
        
        // Auto-set duration for videos
        if (file.type.startsWith('video/')) {
            const durationInput = document.getElementById('media-duration');
            if (durationInput && durationInput.value === '15') {
                durationInput.value = '30'; // Default longer duration for videos
            }
        }
    } else {
        previewDiv.innerHTML = '';
    }
}


// Global variables for media management
let currentEditingMedia = null;

// Export functions for global access
window.loadMedia = loadMedia;
window.showAddMediaModal = showAddMediaModal;
window.handleMediaSubmit = handleMediaSubmit;
window.previewMedia = previewMedia;
window.downloadMedia = downloadMedia;
window.editMedia = editMedia;
window.deleteMedia = deleteMedia;
window.searchMedia = searchMedia;
window.filterMedia = filterMedia;
window.toggleSelectAllMedia = toggleSelectAllMedia;
window.bulkUpdateDisplays = bulkUpdateDisplays;
window.executeBulkDisplayUpdate = executeBulkDisplayUpdate;
window.bulkDeleteMedia = bulkDeleteMedia;
window.refreshMedia = refreshMedia;
window.handleMediaFileSelect = handleMediaFileSelect;


// User preferences management
function saveUserPreferences() {
    try {
        const prefs = {
            lastSelectedProduct: currentProduct?.id,
            lastQuantity: currentQuantity,
            activeTab: document.querySelector('.tab.active')?.textContent
        };
        localStorage.setItem('bomManagementPrefs', JSON.stringify(prefs));
    } catch (error) {
        console.log('Could not save user preferences:', error);
    }
}

function loadUserPreferences() {
    try {
        const prefs = JSON.parse(localStorage.getItem('bomManagementPrefs') || '{}');
        
        if (prefs.lastQuantity) {
            const quantityInput = document.getElementById('quantity-input');
            if (quantityInput) quantityInput.value = prefs.lastQuantity;
        }
        
        // Auto-select last product if available
        if (prefs.lastSelectedProduct) {
            setTimeout(() => {
                const productSelect = document.getElementById('product-select');
                const option = productSelect?.querySelector(`option[value="${prefs.lastSelectedProduct}"]`);
                if (option) {
                    productSelect.value = prefs.lastSelectedProduct;
                }
            }, 1000);
        }
        
    } catch (error) {
        console.log('Could not load user preferences:', error);
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // ESC to close modals
    if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(modal => {
            closeModal(modal.id);
        });
    }
    
    // Ctrl+R to refresh current tab
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        const activeTab = document.querySelector('.tab.active');
        if (activeTab) {
            const tabName = activeTab.textContent.toLowerCase();
            if (tabName.includes('bom items')) refreshBOMItems();
            else if (tabName.includes('templates')) refreshBOMTemplates();
            else if (tabName.includes('stations')) refreshStations();
            else if (tabName.includes('media')) refreshMedia();
        }
    }
});

// Error boundary for better error handling
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    showAlert('An unexpected error occurred. Please refresh the page if issues persist.', 'danger');
});

window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled promise rejection:', event.reason);
    if (event.reason && event.reason.message && event.reason.message.includes('excel')) {
        showAlert('Excel upload error detected. Check console for details.', 'danger');
    }
});


// Auto-refresh functionality (for stations)
let autoRefreshInterval;

function startAutoRefresh() {
    if (autoRefreshInterval) clearInterval(autoRefreshInterval);
    
    autoRefreshInterval = setInterval(async () => {
        const activeTab = document.querySelector('.tab.active');
        if (activeTab && activeTab.textContent.includes('Stations')) {
            try {
                await loadStations();
            } catch (error) {
                console.log('Auto-refresh failed:', error);
            }
        }
    }, 30000); // Refresh every 30 seconds
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

// Initialize auto-refresh when product is loaded
function enableAutoRefresh() {
    if (currentProduct) {
        startAutoRefresh();
    }
}

// Performance optimization for large tables
function optimizeTableRendering() {
    if (allBOMItems.length > 100) {
        console.log('Using optimized rendering for', allBOMItems.length, 'items');
        // Could implement virtual scrolling here if needed
    }
}

// Additional utility functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Enhanced search with debouncing
const debouncedSearch = debounce(searchBOMItems, 300);

// Network status monitoring
window.addEventListener('online', function() {
    showAlert('Connection restored', 'success');
});

window.addEventListener('offline', function() {
    showAlert('Connection lost. Some features may not work.', 'warning');
});

// Initialize tooltips and other UI enhancements
function initializeUIEnhancements() {
    // Add loading states to buttons
    document.querySelectorAll('.btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (!this.disabled) {
                // Add subtle loading effect
                this.style.opacity = '0.7';
                setTimeout(() => {
                    this.style.opacity = '1';
                }, 200);
            }
        });
    });
}

// Call UI enhancements on DOM ready
document.addEventListener('DOMContentLoaded', initializeUIEnhancements);

// Export functions for global access
window.loadProductData = loadProductData;
window.showTab = showTab;
window.showAddItemModal = showAddItemModal;
window.editBOMItem = editBOMItem;
window.deleteBOMItem = deleteBOMItem;
window.uploadExcelFile = uploadExcelFile;
window.testExcelEndpoint = testExcelEndpoint;
window.clearUploadForm = clearUploadForm;
window.handleFileSelect = handleFileSelect;
window.exportBOMItems = exportBOMItems;
window.refreshBOMItems = refreshBOMItems;
window.refreshBOMTemplates = refreshBOMTemplates;
window.refreshStations = refreshStations;
window.refreshMedia = refreshMedia;
window.showAddTemplateModal = showAddTemplateModal;
window.showAddMediaModal = showAddMediaModal;
window.configureStation = configureStation;
window.updateStationProcesses = updateStationProcesses;
window.openStation = openStation;
window.testStation = testStation;
window.syncAllStations = syncAllStations;
window.previewBOMTemplate = previewBOMTemplate;
window.exportBOMTemplate = exportBOMTemplate;
window.editBOMTemplate = editBOMTemplate;
window.deleteBOMTemplate = deleteBOMTemplate;
window.closeModal = closeModal;
window.searchBOMItems = searchBOMItems;
window.filterBOMItems = filterBOMItems;

console.log('BOM Management System initialized successfully');

</script>
</body>
</html>