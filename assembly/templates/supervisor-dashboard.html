<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisor Dashboard - Nipha Exports Private Limited</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        /* Quick Setup Section */
        .quick-setup {
            background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #2196f3;
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.1);
        }

        .quick-setup h2 {
            color: #1976d2;
            margin-bottom: 25px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setup-form {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 20px;
            align-items: end;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .form-control {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1.1em;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.2);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .auto-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 10px;
            font-size: 0.95em;
            color: #2d5a2d;
            margin-top: 15px;
            border-left: 4px solid #27ae60;
        }

        /* Display Status Overview */
        .status-overview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .display-status {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-top: 4px solid;
            transition: transform 0.3s ease;
        }

        .display-status:hover {
            transform: translateY(-3px);
        }

        .display-1 { border-top-color: #FF6B6B; }
        .display-2 { border-top-color: #4ECDC4; }
        .display-3 { border-top-color: #45B7D1; }

        .display-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .display-type {
            color: #666;
            margin-bottom: 15px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .current-process {
            background: #e8f5e8;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #2d5a2d;
            margin-bottom: 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-online { background: #27ae60; }
        .status-offline { background: #e74c3c; }
        .status-loading { background: #f39c12; }

        /* BOM Pagination Controls */
        .bom-pagination-section {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #ff9800;
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.1);
            display: none; /* Hidden by default */
        }

        .bom-pagination-section.visible {
            display: block;
        }

        .bom-pagination-section h2 {
            color: #e65100;
            margin-bottom: 25px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bom-controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin-bottom: 25px;
        }

        .display-bom-controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }

        .display-bom-controls.display-1 { border-left-color: #FF6B6B; }
        .display-bom-controls.display-2 { border-left-color: #4ECDC4; }
        .display-bom-controls.display-3 { border-left-color: #45B7D1; }

        .bom-control-header {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: 15px;
        }

        .bom-control-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .bom-info-display {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #495057;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
        }

        .pagination-info {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            color: #495057;
            text-align: center;
            margin-top: 10px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
            border-radius: 6px;
        }

        .global-bom-controls {
            background: #fff8e1;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #ffcc02;
        }

        .global-bom-controls h3 {
            color: #f57f17;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .global-controls-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Process Navigation Controls */
        .navigation-controls {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #6c757d;
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.1);
        }

        .navigation-controls h2 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .navigation-controls p {
            color: #666;
            margin-bottom: 25px;
            font-size: 1.1em;
        }

        .navigation-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 25px;
        }

        .navigation-buttons .btn-large {
            flex: 1;
            max-width: 250px;
            min-width: 180px;
        }

        .btn-large {
            padding: 18px 35px;
            font-size: 1.2em;
            border-radius: 12px;
            min-width: 200px;
        }

        .navigation-info {
            text-align: center;
            margin-top: 20px;
        }

        .loop-status-display {
            margin-bottom: 15px;
        }

        .navigation-note {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            color: #856404;
            font-size: 0.95em;
            text-align: left;
            max-width: 600px;
            margin: 0 auto;
        }

        .loop-status {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 15px;
        }

        .loop-active {
            background: #fff3cd;
            color: #856404;
        }

        .loop-inactive {
            background: #d1ecf1;
            color: #0c5460;
        }

        .loop-toggle {
            background: #f39c12;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .loop-toggle:hover {
            background: #e67e22;
        }

        .loop-toggle.active {
            background: #27ae60;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #b8daff;
            color: #0c5460;
        }

        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .setup-form {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .bom-controls-grid {
                grid-template-columns: 1fr;
            }
            
            .status-overview {
                grid-template-columns: 1fr;
            }
            
            .process-navigation {
                flex-direction: column;
            }

            .global-controls-row {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Loading States */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* BOM Status Indicators */
        .bom-status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .bom-available { background: #28a745; }
        .bom-unavailable { background: #dc3545; }
        .bom-loading { background: #ffc107; }

        .no-bom-message {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 15px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>Supervisor Dashboard - Nipha Exports Private Limited</h1>
        </div>

        <div class="main-content">
            <!-- Quick Setup Section -->
            <div class="quick-setup">
                <h2>üéØ Quick Setup</h2>
                
                <div class="setup-form">
                    <div class="form-group">
                        <label for="product-select">Select Product:</label>
                        <select class="form-control" id="product-select">
                            <option value="">Loading products...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="quantity-input">Quantity:</label>
                        <input type="number" class="form-control" id="quantity-input" value="50" min="1" max="1000">
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-success" id="apply-btn" onclick="applyProductSetup()">
                            üöÄ Apply to All Displays
                        </button>
                    </div>
                </div>

                <div class="auto-info">
                    <strong>‚ú® Auto Setup:</strong> Selecting a product will automatically choose the first stage and process for all displays.
                    <br><strong>üîÑ Sync Mode:</strong> All displays will show the same process step and can be controlled together.
                </div>
            </div>

            <!-- Display Status Overview -->
            <div class="status-overview">
                <div class="display-status display-1">
                    <div class="display-number">1</div>
                    <div class="display-type">BOMs & Reference</div>
                    <div class="current-process" id="display1-process">Loading...</div>
                    <div style="margin-top: 10px;">
                        <span class="status-indicator status-loading" id="display1-status"></span>
                        <span id="display1-connection">Checking...</span>
                    </div>
                </div>
                <div class="display-status display-2">
                    <div class="display-number">2</div>
                    <div class="display-type">Process Instructions</div>
                    <div class="current-process" id="display2-process">Loading...</div>
                    <div style="margin-top: 10px;">
                        <span class="status-indicator status-loading" id="display2-status"></span>
                        <span id="display2-connection">Checking...</span>
                    </div>
                </div>
                <div class="display-status display-3">
                    <div class="display-number">3</div>
                    <div class="display-type">Instructional Videos</div>
                    <div class="current-process" id="display3-process">Loading...</div>
                    <div style="margin-top: 10px;">
                        <span class="status-indicator status-loading" id="display3-status"></span>
                        <span id="display3-connection">Checking...</span>
                    </div>
                </div>
            </div>

            {% comment %} <!-- BOM Pagination Controls Section -->
            <div class="bom-pagination-section" id="bom-pagination-section">
                <h2>üìã BOM Pagination Controls</h2>
                
                <div class="bom-controls-grid">
                    <!-- Display 1 BOM Controls -->
                    <div class="display-bom-controls display-1" id="bom-controls-1">
                        <div class="bom-control-header">
                            <span class="bom-control-title">Display 1</span>
                            <span class="bom-status-indicator bom-loading" id="bom-status-1"></span>
                        </div>
                        <div class="bom-info-display" id="bom-info-1">
                            <div class="no-bom-message">No BOM data available</div>
                        </div>
                        <div class="pagination-controls" id="pagination-controls-1" style="display: none;">
                            <button class="btn btn-info btn-sm" onclick="bomPreviousPage(1)">‚¨ÖÔ∏è Previous</button>
                            <button class="btn btn-primary btn-sm" onclick="bomRefresh(1)">üîÑ Refresh</button>
                            <button class="btn btn-info btn-sm" onclick="bomNextPage(1)">‚û°Ô∏è Next</button>
                        </div>
                        <div class="pagination-info" id="pagination-info-1" style="display: none;">
                            Page 1 of 1 (0 items)
                        </div>
                    </div>

                    <!-- Display 2 BOM Controls -->
                    <div class="display-bom-controls display-2" id="bom-controls-2">
                        <div class="bom-control-header">
                            <span class="bom-control-title">Display 2</span>
                            <span class="bom-status-indicator bom-loading" id="bom-status-2"></span>
                        </div>
                        <div class="bom-info-display" id="bom-info-2">
                            <div class="no-bom-message">No BOM data available</div>
                        </div>
                        <div class="pagination-controls" id="pagination-controls-2" style="display: none;">
                            <button class="btn btn-info btn-sm" onclick="bomPreviousPage(2)">‚¨ÖÔ∏è Previous</button>
                            <button class="btn btn-primary btn-sm" onclick="bomRefresh(2)">üîÑ Refresh</button>
                            <button class="btn btn-info btn-sm" onclick="bomNextPage(2)">‚û°Ô∏è Next</button>
                        </div>
                        <div class="pagination-info" id="pagination-info-2" style="display: none;">
                            Page 1 of 1 (0 items)
                        </div>
                    </div>

                    <!-- Display 3 BOM Controls -->
                    <div class="display-bom-controls display-3" id="bom-controls-3">
                        <div class="bom-control-header">
                            <span class="bom-control-title">Display 3</span>
                            <span class="bom-status-indicator bom-loading" id="bom-status-3"></span>
                        </div>
                        <div class="bom-info-display" id="bom-info-3">
                            <div class="no-bom-message">No BOM data available</div>
                        </div>
                        <div class="pagination-controls" id="pagination-controls-3" style="display: none;">
                            <button class="btn btn-info btn-sm" onclick="bomPreviousPage(3)">‚¨ÖÔ∏è Previous</button>
                            <button class="btn btn-primary btn-sm" onclick="bomRefresh(3)">üîÑ Refresh</button>
                            <button class="btn btn-info btn-sm" onclick="bomNextPage(3)">‚û°Ô∏è Next</button>
                        </div>
                        <div class="pagination-info" id="pagination-info-3" style="display: none;">
                            Page 1 of 1 (0 items)
                        </div>
                    </div>
                </div>

                <!-- Global BOM Controls -->
                <div class="global-bom-controls">
                    <h3>üåê Global BOM Controls</h3>
                    <div class="global-controls-row">
                        <button class="btn btn-info" onclick="bomPreviousPageAll()">‚¨ÖÔ∏è Previous Page (All)</button>
                        <button class="btn btn-info" onclick="bomNextPageAll()">‚û°Ô∏è Next Page (All)</button>
                        <button class="btn btn-warning" onclick="bomRefreshAll()">üîÑ Refresh All BOMs</button>
                        <button class="btn btn-primary" onclick="bomTestAllDisplays()">üß™ Test All BOM Displays</button>
                    </div>
                </div>
            </div>

            <!-- Process Navigation Controls -->
            <div class="navigation-controls">
                <h2>üéÆ Process Navigation</h2>
                <p>Control all displays together using these navigation buttons:</p>
                
                <div class="navigation-buttons">
                    <button class="btn btn-primary btn-large" onclick="previousProcess(1)">
                        ‚¨ÖÔ∏è Previous Process
                    </button>
                    <button class="btn btn-primary btn-large" onclick="nextProcess(1)">
                        ‚û°Ô∏è Next Process
                    </button>
                    <button class="btn btn-warning btn-large" onclick="toggleLoopMode(1)">
                        üîÑ Toggle Loop Mode
                    </button>
                </div>
                
                <div class="navigation-info">
                    <div class="loop-status-display">
                        <span class="loop-status loop-inactive" id="global-loop-status">üîÑ Loop: Inactive</span>
                    </div>
                    <p class="navigation-note">
                        <strong>Note:</strong> Navigation controls affect all displays simultaneously. 
                        Loop mode is available for processes 1A, 1B, and 1C.
                    </p>
                </div>
            </div> {% endcomment %}

            <!-- Quick Links -->
            <div class="alert alert-info">
                <strong>üîó Quick Links:</strong>
                <div class="quick-actions">
                    <a href="workflow-guide.html" class="btn btn-primary">üìã View Workflow Guide</a>
                    <a href="/admin/" class="btn btn-warning">‚öôÔ∏è Admin Panel</a>
                    <button class="btn btn-success" onclick="refreshAllDisplays()">üîÑ Refresh All</button>
                    <button class="btn btn-success" onclick="testAllDisplays()">üß™ Test All Displays</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStationData = {};
        let isUserEditing = false;
        let editingTimeouts = {};
        let selectedProduct = null;
        let selectedQuantity = 50;
        let bomPaginationData = {}; // Store BOM pagination data for each display

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadProductOptions();
            loadAssemblyOptions();
            loadStationData();
            startStatusUpdates();
            addEditingProtectionToInputs();
            checkBOMDataAvailability();
        });

        // Load product options for the main dropdown
        async function loadProductOptions() {
            try {
                // Get products from first station's options
                const response = await fetch('/station/1/assembly/options/');
                const data = await response.json();
                
                const productSelect = document.getElementById('product-select');
                productSelect.innerHTML = '<option value="">Select Product</option>';
                
                data.products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.code} - ${product.name}`;
                    productSelect.appendChild(option);
                });
                
                // Add event listener for product selection
                productSelect.addEventListener('change', function() {
                    selectedProduct = this.value ? data.products.find(p => p.id == this.value) : null;
                    if (selectedProduct) {
                        showSystemAlert(`Selected: ${selectedProduct.code} - ${selectedProduct.name}`, 'info');
                        // Refresh BOM data when product changes
                        setTimeout(() => checkBOMDataAvailability(), 1000);
                    }
                });
                
            } catch (error) {
                console.error('Error loading product options:', error);
                showSystemAlert('Error loading products', 'warning');
            }
        }

        // Apply product setup to all displays
        async function applyProductSetup() {
            const productSelect = document.getElementById('product-select');
            const quantityInput = document.getElementById('quantity-input');
            const applyBtn = document.getElementById('apply-btn');
            
            if (!productSelect.value) {
                alert('Please select a product first');
                return;
            }
            
            selectedQuantity = parseInt(quantityInput.value) || 50;
            
            try {
                // Disable button and show loading
                applyBtn.disabled = true;
                applyBtn.innerHTML = '<span class="loading-spinner"></span> Applying...';
                
                showSystemAlert('Setting up all displays...', 'info');
                
                // Get assembly options to find first stage and process
                const response = await fetch('/station/1/assembly/options/');
                const data = await response.json();
                
                if (!data.stages || data.stages.length === 0) {
                    throw new Error('No stages available');
                }
                
                const firstStage = data.stages[0];
                const firstProcess = firstStage.processes && firstStage.processes.length > 0 
                    ? firstStage.processes[0] 
                    : null;
                
                if (!firstProcess) {
                    throw new Error('No processes available in first stage');
                }
                
                // Configure all displays with the same settings
                const config = {
                    product_id: parseInt(productSelect.value),
                    stage_id: firstStage.id,
                    process_id: firstProcess.id,
                    quantity: selectedQuantity,
                    show_single_unit_bom: selectedQuantity === 1,
                    show_batch_bom: selectedQuantity > 1
                };
                
                // Update all three displays
                const promises = [1, 2, 3].map(displayNum => 
                    fetch(`/station/${displayNum}/assembly/config/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(config)
                    })
                );
                
                const responses = await Promise.all(promises);
                const results = await Promise.all(responses.map(r => r.json()));
                
                if (results.every(r => r.success)) {
                    showSystemAlert(`‚úÖ All displays configured: ${selectedProduct.code} - ${firstProcess.display_name} (Qty: ${selectedQuantity})`, 'success');
                    
                    // Refresh data and check BOM availability
                    loadStationData();
                    setTimeout(() => checkBOMDataAvailability(), 1500);
                    
                } else {
                    showSystemAlert('‚ö†Ô∏è Some displays failed to update', 'warning');
                }
                
            } catch (error) {
                console.error('Error applying setup:', error);
                showSystemAlert(`‚ùå Error: ${error.message}`, 'warning');
            } finally {
                // Re-enable button
                applyBtn.disabled = false;
                applyBtn.innerHTML = 'üöÄ Apply to All Displays';
            }
        }

        // Check BOM data availability for all displays
        async function checkBOMDataAvailability() {
            const bomSection = document.getElementById('bom-pagination-section');
            let hasAnyBOM = false;

            for (let displayNum = 1; displayNum <= 3; displayNum++) {
                try {
                    // FIXED: Use the working bom-paginated endpoint instead of media endpoint
                    const response = await fetch(`/station/${displayNum}/bom-paginated/`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Check if we have actual BOM data
                        const hasBOM = data.bom_data && data.bom_data.length > 0;
                        
                        console.log(`Display ${displayNum} BOM check:`, {
                            hasBOM,
                            itemCount: data.bom_data ? data.bom_data.length : 0,
                            totalItems: data.summary ? data.summary.total_items : 0,
                            pagination: data.pagination
                        });
                        
                        if (hasBOM) {
                            hasAnyBOM = true;
                            // Update controls with actual BOM data
                            updateBOMControls(displayNum, data);
                        } else {
                            updateBOMControlsNoBOM(displayNum);
                        }
                    } else {
                        // If 404 or 400, likely no BOM data configured
                        console.log(`Display ${displayNum}: No BOM data configured (${response.status})`);
                        updateBOMControlsNoBOM(displayNum);
                    }
                    
                } catch (error) {
                    console.error(`Error checking BOM data for display ${displayNum}:`, error);
                    updateBOMControlsError(displayNum);
                }
            }

            // Show/hide BOM pagination section
            if (hasAnyBOM) {
                bomSection.classList.add('visible');
                console.log('BOM pagination section shown - found BOM data');
            } else {
                bomSection.classList.remove('visible');
                console.log('BOM pagination section hidden - no BOM data found');
            }
        }

        // Load BOM pagination data for a specific display
        async function loadBOMPaginationData(displayNum) {
            try {
                // Use the working bom-paginated endpoint
                const response = await fetch(`/station/${displayNum}/bom-paginated/`);
                
                if (!response.ok) {
                    if (response.status === 404 || response.status === 400) {
                        console.log(`Display ${displayNum}: No BOM data configured`);
                        updateBOMControlsNoBOM(displayNum);
                        return;
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    console.log(`Display ${displayNum}: BOM error - ${data.error}`);
                    updateBOMControlsError(displayNum);
                    return;
                }

                // Store pagination data
                bomPaginationData[displayNum] = data;
                
                console.log(`Display ${displayNum} BOM data loaded:`, {
                    totalItems: data.summary.total_items,
                    currentPage: data.pagination.current_page,
                    totalPages: data.pagination.total_pages,
                    bomType: data.station_info.bom_type
                });
                
                // Update UI with actual data
                updateBOMControls(displayNum, data);
                
            } catch (error) {
                console.error(`Error loading BOM pagination data for display ${displayNum}:`, error);
                updateBOMControlsError(displayNum);
            }
        }

        // Update BOM controls with data
        function updateBOMControls(displayNum, data) {
            const bomStatus = document.getElementById(`bom-status-${displayNum}`);
            const bomInfo = document.getElementById(`bom-info-${displayNum}`);
            const paginationControls = document.getElementById(`pagination-controls-${displayNum}`);
            const paginationInfo = document.getElementById(`pagination-info-${displayNum}`);

            // Update status
            bomStatus.className = 'bom-status-indicator bom-available';

            // Update info display with actual data structure
            const stationInfo = data.station_info;
            bomInfo.innerHTML = `
                <div><strong>BOM Type:</strong> ${stationInfo.bom_type}</div>
                <div><strong>Product:</strong> ${stationInfo.product_code} - ${stationInfo.product_name}</div>
                <div><strong>Quantity:</strong> ${stationInfo.quantity}</div>
                <div><strong>Items:</strong> ${data.summary.total_items} total</div>
            `;

            // Show/hide controls based on pagination
            const pagination = data.pagination;
            const hasPagination = pagination && pagination.total_pages > 1;

            if (hasPagination) {
                paginationControls.style.display = 'flex';
                paginationInfo.style.display = 'block';
                paginationInfo.textContent = `Page ${pagination.current_page} of ${pagination.total_pages} (${data.summary.total_items} items)`;
                
                // Enable/disable navigation buttons
                const prevBtn = paginationControls.querySelector(`button[onclick="bomPreviousPage(${displayNum})"]`);
                const nextBtn = paginationControls.querySelector(`button[onclick="bomNextPage(${displayNum})"]`);
                
                if (prevBtn) prevBtn.disabled = !pagination.has_previous;
                if (nextBtn) nextBtn.disabled = !pagination.has_next;
                
                console.log(`Display ${displayNum} pagination controls updated:`, {
                    currentPage: pagination.current_page,
                    totalPages: pagination.total_pages,
                    hasPrevious: pagination.has_previous,
                    hasNext: pagination.has_next
                });
            } else {
                paginationControls.style.display = 'none';
                paginationInfo.style.display = 'block';
                paginationInfo.textContent = `Single page (${data.summary.total_items} items)`;
                console.log(`Display ${displayNum}: Single page, no pagination needed`);
            }
        }

        // Update BOM controls when no BOM data available
        function updateBOMControlsNoBOM(displayNum) {
            const bomStatus = document.getElementById(`bom-status-${displayNum}`);
            const bomInfo = document.getElementById(`bom-info-${displayNum}`);
            const paginationControls = document.getElementById(`pagination-controls-${displayNum}`);
            const paginationInfo = document.getElementById(`pagination-info-${displayNum}`);

            bomStatus.className = 'bom-status-indicator bom-unavailable';
            bomInfo.innerHTML = '<div class="no-bom-message">No BOM data available</div>';
            paginationControls.style.display = 'none';
            paginationInfo.style.display = 'none';
        }

        // Update BOM controls when error occurs
        function updateBOMControlsError(displayNum) {
            const bomStatus = document.getElementById(`bom-status-${displayNum}`);
            const bomInfo = document.getElementById(`bom-info-${displayNum}`);
            const paginationControls = document.getElementById(`pagination-controls-${displayNum}`);
            const paginationInfo = document.getElementById(`pagination-info-${displayNum}`);

            bomStatus.className = 'bom-status-indicator bom-loading';
            bomInfo.innerHTML = '<div class="no-bom-message">Error loading BOM data</div>';
            paginationControls.style.display = 'none';
            paginationInfo.style.display = 'none';
        }

        // BOM Pagination Control Functions
        async function bomPreviousPage(displayNum) {
            await bomPaginationAction(displayNum, 'previous_page');
        }

        async function bomNextPage(displayNum) {
            await bomPaginationAction(displayNum, 'next_page');
        }

        async function bomRefresh(displayNum) {
            await loadBOMPaginationData(displayNum);
            showSystemAlert(`Display ${displayNum}: BOM data refreshed`, 'success');
        }

        async function bomPaginationAction(displayNum, action) {
            try {
                console.log(`Executing BOM pagination action: ${action} for display ${displayNum}`);
                
                const response = await fetch(`/station/${displayNum}/bom-pagination-control/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: action,
                        mode: 'split',
                        items_per_screen: 8
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    console.log(`BOM pagination success for display ${displayNum}:`, result);
                    
                    // Reload pagination data to get updated info
                    await loadBOMPaginationData(displayNum);
                    showSystemAlert(`Display ${displayNum}: ${result.message}`, 'success');
                } else {
                    console.error(`BOM pagination failed for display ${displayNum}:`, result.error);
                    showSystemAlert(`Display ${displayNum}: ${result.error}`, 'warning');
                }
            } catch (error) {
                console.error(`Error with BOM pagination for display ${displayNum}:`, error);
                showSystemAlert(`Display ${displayNum}: Pagination error`, 'warning');
            }
        }

        // Global BOM Controls
        async function bomPreviousPageAll() {
            const promises = [];
            let actionCount = 0;
            
            for (let i = 1; i <= 3; i++) {
                if (bomPaginationData[i] && bomPaginationData[i].pagination.has_previous) {
                    promises.push(bomPaginationAction(i, 'previous_page'));
                    actionCount++;
                }
            }
            
            if (actionCount > 0) {
                await Promise.all(promises);
                showSystemAlert(`Previous page applied to ${actionCount} displays with BOM data`, 'info');
            } else {
                showSystemAlert('No displays have previous pages available', 'warning');
            }
        }

        async function bomNextPageAll() {
            const promises = [];
            let actionCount = 0;
            
            for (let i = 1; i <= 3; i++) {
                if (bomPaginationData[i] && bomPaginationData[i].pagination.has_next) {
                    promises.push(bomPaginationAction(i, 'next_page'));
                    actionCount++;
                }
            }
            
            if (actionCount > 0) {
                await Promise.all(promises);
                showSystemAlert(`Next page applied to ${actionCount} displays with BOM data`, 'info');
            } else {
                showSystemAlert('No displays have next pages available', 'warning');
            }
        }

        async function bomRefreshAll() {
            const promises = [];
            let refreshCount = 0;
            
            for (let i = 1; i <= 3; i++) {
                promises.push(loadBOMPaginationData(i));
                refreshCount++;
            }
            
            await Promise.all(promises);
            showSystemAlert(`Refreshed BOM data for ${refreshCount} displays`, 'success');
        }

        function bomTestAllDisplays() {
            let openedCount = 0;
            for (let i = 1; i <= 3; i++) {
                if (bomPaginationData[i]) {
                    window.open(`/station/${i}/bom-render-paginated/`, '_blank');
                    openedCount++;
                }
            }
            
            if (openedCount > 0) {
                showSystemAlert(`Opened ${openedCount} BOM display windows`, 'info');
            } else {
                showSystemAlert('No BOM data available to test', 'warning');
            }
        }

        // Enhanced stage change handler
        function handleStageChange(displayNum) {
            const stageSelect = document.getElementById(`stage-select-${displayNum}`);
            const processSelect = document.getElementById(`process-select-${displayNum}`);
            const stageId = stageSelect.value;
            
            if (!stageId) {
                processSelect.innerHTML = '<option value="">Select stage first</option>';
                return;
            }

            const selectedStage = window.stagesData.find(s => s.id == stageId);
            if (!selectedStage || !selectedStage.processes.length) {
                processSelect.innerHTML = '<option value="">No processes available</option>';
                return;
            }

            populateProcessSelect(selectedStage.processes, displayNum);
            
            // Auto-select first process
            const firstProcess = selectedStage.processes[0];
            processSelect.value = firstProcess.id;
            
            showSystemAlert(`Display ${displayNum}: Auto-selected "${firstProcess.name}"`, 'success');
            setEditingMode(displayNum, true);
        }

        // Load assembly options (simplified - no individual controls needed)
        async function loadAssemblyOptions() {
            try {
                const response = await fetch('/station/1/assembly/options/');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                window.stagesData = data.stages;
                console.log('Assembly options loaded successfully:', data);
                
            } catch (error) {
                console.error('Error loading assembly options:', error);
                showSystemAlert(`Error loading assembly options: ${error.message}`, 'warning');
                
                // Fallback: Try to load from other stations
                try {
                    console.log('Trying fallback station...');
                    const fallbackResponse = await fetch('/station/2/assembly/options/');
                    if (fallbackResponse.ok) {
                        const fallbackData = await fallbackResponse.json();
                        window.stagesData = fallbackData.stages;
                        showSystemAlert('Loaded assembly options from backup station', 'info');
                    }
                } catch (fallbackError) {
                    console.error('Fallback also failed:', fallbackError);
                    showSystemAlert('Unable to load assembly options from any station', 'warning');
                }
            }
        }

        // Test all displays
        function testAllDisplays() {
            for (let i = 1; i <= 3; i++) {
                window.open(`/station/${i}/slider/`, '_blank');
            }
        }

        // Populate stage select for individual displays
        function populateStageSelect(stages, displayNum) {
            const stageSelect = document.getElementById(`stage-select-${displayNum}`);
            stageSelect.innerHTML = '<option value="">Select Stage</option>';
            
            stages.forEach(stage => {
                const option = document.createElement('option');
                option.value = stage.id;
                option.textContent = stage.display_name;
                stageSelect.appendChild(option);
            });

            stageSelect.addEventListener('focus', function() {
                setEditingMode(displayNum, true);
            });

            stageSelect.addEventListener('blur', function() {
                setTimeout(() => {
                    setEditingMode(displayNum, false);
                }, 2000);
            });
        }

        // Populate process select for individual displays
        function populateProcessSelect(processes, displayNum) {
            const processSelect = document.getElementById(`process-select-${displayNum}`);
            const currentValue = processSelect.value;
            processSelect.innerHTML = '<option value="">Select Process</option>';
            
            processes.forEach(process => {
                const option = document.createElement('option');
                option.value = process.id;
                option.textContent = `${process.name} - ${process.display_name}`;
                processSelect.appendChild(option);
            });
            
            if (currentValue && processSelect.querySelector(`option[value="${currentValue}"]`)) {
                processSelect.value = currentValue;
            }

            processSelect.addEventListener('focus', function() {
                setEditingMode(displayNum, true);
            });

            processSelect.addEventListener('blur', function() {
                setTimeout(() => {
                    setEditingMode(displayNum, false);
                }, 1000);
            });
        }

        // Load current station data
        async function loadStationData() {
            if (isAnyDisplayBeingEdited()) {
                return;
            }

            try {
                const responses = await Promise.all([
                    fetch('/station/1/media/'),
                    fetch('/station/2/media/'),
                    fetch('/station/3/media/')
                ]);

                for (let i = 0; i < responses.length; i++) {
                    const data = await responses[i].json();
                    updateDisplayStatus(i + 1, data);
                }
            } catch (error) {
                console.error('Error loading station data:', error);
            }
        }

        // Update display status with real-time data
        function updateDisplayStatus(displayNum, data) {
            const processElement = document.getElementById(`display${displayNum}-process`);
            const statusElement = document.getElementById(`display${displayNum}-status`);
            const connectionElement = document.getElementById(`display${displayNum}-connection`);
            
            if (data.station_info) {
                const station = data.station_info;
                
                let processText = 'No process selected';
                if (station.current_process && station.current_stage) {
                    processText = `${station.current_stage.name} - ${station.current_process.name}`;
                    
                    if (station.loop_mode) {
                        processText += ' üîÑ';
                    }
                    
                    if (!station.clicker_enabled) {
                        processText += ' üö´';
                    }
                }
                
                processElement.textContent = processText;
                statusElement.className = 'status-indicator status-online';
                connectionElement.textContent = 'Connected';
                
                updateControlsFromStatus(station, displayNum);
                
            } else {
                processElement.textContent = 'Connection error';
                statusElement.className = 'status-indicator status-offline';
                connectionElement.textContent = 'Offline';
            }
        }

        // Update controls based on current station status
        function updateControlsFromStatus(station, displayNum) {
            // Update global loop status based on any display
            if (displayNum === 1) {
                updateGlobalLoopStatus(station.loop_mode);
            }
        }

        // Update current configuration for specific display
        function updateCurrentConfig(config, displayNum) {
            // Only update global loop status, no individual controls
            if (displayNum === 1) {
                updateGlobalLoopStatus(config.loop_mode);
            }
        }

        // Update global loop status display
        function updateGlobalLoopStatus(isActive) {
            const globalLoopStatus = document.getElementById('global-loop-status');
            
            if (globalLoopStatus) {
                if (isActive) {
                    globalLoopStatus.textContent = 'üîÑ Loop: Active';
                    globalLoopStatus.className = 'loop-status loop-active';
                } else {
                    globalLoopStatus.textContent = 'üîÑ Loop: Inactive';
                    globalLoopStatus.className = 'loop-status loop-inactive';
                }
            }
        }

        // Set editing mode for specific display
        function setEditingMode(displayNum, editing) {
            if (editing) {
                editingTimeouts[displayNum] = true;
                if (editingTimeouts[`timeout_${displayNum}`]) {
                    clearTimeout(editingTimeouts[`timeout_${displayNum}`]);
                }
                editingTimeouts[`timeout_${displayNum}`] = setTimeout(() => {
                    editingTimeouts[displayNum] = false;
                }, 5000);
            } else {
                editingTimeouts[displayNum] = false;
                if (editingTimeouts[`timeout_${displayNum}`]) {
                    clearTimeout(editingTimeouts[`timeout_${displayNum}`]);
                }
            }
        }

        // Check if any display is being edited
        function isAnyDisplayBeingEdited() {
            return isUserEditing || Object.keys(editingTimeouts).some(key => 
                !key.startsWith('timeout_') && editingTimeouts[key] === true
            );
        }

        // Add editing protection for inputs
        function addEditingProtectionToInputs() {
            // Add listener for main quantity input
            const mainQuantityInput = document.getElementById('quantity-input');
            if (mainQuantityInput) {
                mainQuantityInput.addEventListener('change', function() {
                    selectedQuantity = parseInt(this.value) || 50;
                    showSystemAlert(`‚úÖ Quantity set to ${selectedQuantity}`, 'info');
                    // Refresh BOM data when quantity changes
                    setTimeout(() => checkBOMDataAvailability(), 1000);
                });
            }
        }

        // Process navigation functions
        async function previousProcess(displayNum) {
            await sendClickerAction('backward', displayNum);
        }

        async function nextProcess(displayNum) {
            await sendClickerAction('forward', displayNum);
        }

        async function toggleLoopMode(displayNum) {
            await sendClickerAction('toggle_loop', displayNum);
        }

        // Send clicker actions
        async function sendClickerAction(action, displayNum) {
            try {
                const actionBtns = document.querySelectorAll(`button[onclick*="${action}(${displayNum})"]`);
                actionBtns.forEach(btn => {
                    btn.style.opacity = '0.6';
                    btn.disabled = true;
                });

                const response = await fetch(`/station/${displayNum}/clicker/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSystemAlert(`Display ${displayNum}: ${action} successful`, 'success');
                    await refreshSingleDisplay(displayNum);
                    // Refresh BOM data after process change
                    setTimeout(() => checkBOMDataAvailability(), 1000);
                } else {
                    showSystemAlert(`Display ${displayNum}: ${result.error || 'Action failed'}`, 'warning');
                }
            } catch (error) {
                showSystemAlert(`Display ${displayNum}: Error sending command`, 'warning');
            } finally {
                const actionBtns = document.querySelectorAll(`button[onclick*="${action}(${displayNum})"]`);
                actionBtns.forEach(btn => {
                    btn.style.opacity = '1';
                    btn.disabled = false;
                });
            }
        }

        // Update configuration for individual display
        async function updateConfiguration(displayNum) {
            const stageId = document.getElementById(`stage-select-${displayNum}`).value;
            const processId = document.getElementById(`process-select-${displayNum}`).value;
            const quantity = document.getElementById(`quantity-input-${displayNum}`).value;
            
            if (!stageId || !processId) {
                alert('Please select both stage and process');
                return;
            }

            const config = {
                stage_id: stageId,
                process_id: processId,
                quantity: parseInt(quantity),
                show_single_unit_bom: parseInt(quantity) === 1,
                show_batch_bom: parseInt(quantity) > 1
            };

            const updateBtn = document.querySelector(`button[onclick="updateConfiguration(${displayNum})"]`);
            const originalText = updateBtn ? updateBtn.textContent : 'üíæ Update';

            try {
                if (updateBtn) {
                    updateBtn.textContent = '‚è≥ Updating...';
                    updateBtn.disabled = true;
                }

                const response = await fetch(`/station/${displayNum}/assembly/config/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                
                if (result.success) {
                    showSystemAlert(`Display ${displayNum} updated successfully`, 'success');
                    await refreshSingleDisplay(displayNum);
                    // Refresh BOM data after configuration update
                    setTimeout(() => checkBOMDataAvailability(), 1000);
                } else {
                    showSystemAlert(`Display ${displayNum} update failed: ${result.error}`, 'warning');
                }
            } catch (error) {
                showSystemAlert(`Display ${displayNum}: Error updating configuration`, 'warning');
            } finally {
                if (updateBtn) {
                    updateBtn.textContent = originalText;
                    updateBtn.disabled = false;
                }
            }
        }

        // Refresh single display
        async function refreshSingleDisplay(displayNum) {
            try {
                const response = await fetch(`/station/${displayNum}/media/`);
                const data = await response.json();
                updateDisplayStatus(displayNum, data);
            } catch (error) {
                console.error(`Error refreshing display ${displayNum}:`, error);
            }
        }

        // Update loop status display
        function updateLoopStatus(isActive, displayNum) {
            const loopStatus = document.getElementById(`loop-status-${displayNum}`);
            const loopToggleBtn = document.getElementById(`loop-toggle-btn-${displayNum}`);
            
            if (loopStatus && loopToggleBtn) {
                if (isActive) {
                    loopStatus.textContent = 'üîÑ Loop: Active';
                    loopStatus.className = 'loop-status loop-active';
                    loopToggleBtn.classList.add('active');
                    loopToggleBtn.textContent = 'Disable Loop';
                } else {
                    loopStatus.textContent = 'üîÑ Loop: Inactive';
                    loopStatus.className = 'loop-status loop-inactive';
                    loopToggleBtn.classList.remove('active');
                    loopToggleBtn.textContent = 'Enable Loop';
                }
            }
        }

        // Refresh all displays
        function refreshAllDisplays() {
            loadStationData();
            loadAssemblyOptions();
            checkBOMDataAvailability();
            showSystemAlert('Refreshing all displays...', 'info');
        }

        // Test display
        function testDisplay(displayNum) {
            window.open(`/station/${displayNum}/slider/`, '_blank');
        }

        // Show system alerts
        function showSystemAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.maxWidth = '400px';
            alertDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            alertDiv.innerHTML = `
                <strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">√ó</button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Start periodic status updates
        function startStatusUpdates() {
            setInterval(async () => {
                await loadStationData();
            }, 3000);
            
            setInterval(async () => {
                await loadAssemblyOptions();
            }, 30000);

            // Check BOM data availability every 10 seconds
            setInterval(async () => {
                await checkBOMDataAvailability();
            }, 10000);
        }
    </script>
</body>
</html>